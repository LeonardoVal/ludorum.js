//! ludorum 0.2.1

(function(a){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat"],a):"object"==typeof exports&&module.exports?module.exports=a(require("creatartis-base"),require("sermat")):this.ludorum=a(this.base,this.Sermat)}).call(this,function a(b,c){"use strict";var d=b.objects.unimplemented,e=b.obj,f=b.copy,g=b.raise,h=b.raiseIf,i=b.declare,j=b.Iterable,k=b.iterable,l=b.Future,m=b.Randomness,n=b.initialize,o=b.Statistics,p=b.Events,q={__package__:"ludorum",__name__:"ludorum",__init__:a,__dependencies__:[b,c],__SERMAT__:{include:[b]}},r=q.aleatories={},s=q.games={},t=q.players={},u=q.tournaments={},v=q.utils={},w=q.Game=i({constructor:function(a){this.activatePlayers(a)},name:"?",players:[],moves:d("Game","moves()"),next:d("Game","next(moves, haps, update)"),result:d("Game","result()"),scores:function(){return this.results()},view:function(a){return this},isActive:function(){for(var a=0;a<arguments.length;a++)if(this.activePlayers.indexOf(arguments[a])<0)return!1;return!0},activePlayer:function(){var a=this.activePlayers.length;return h(a<1,"There are no active players!"),h(a>1,"More than one player is active!"),this.activePlayers[0]},activatePlayers:function(a){return this.activePlayers=a?Array.isArray(a)?a:[a]:[this.players[0]]},opponents:function(a){return a=a||this.activePlayers,this.players.filter(function(b){return a.indexOf(b)<0})},opponent:function(a){var b=this.players.indexOf(a||this.activePlayer());return this.players[(b+1)%this.players.length]},perform:function(){for(var a,b={},c=0;c<arguments.length;c+=2)a=arguments[c+1],"undefined"==typeof a&&(a=this.activePlayer()),b[a]=arguments[c];return this.next(b)},possibleMoves:function(a){if(a=arguments.length<1?this.moves():a,!a||"object"!=typeof a)return[];var b=Object.keys(a);if(1===b.length){var c=b[0];return a[c].map(function(a){return e(c,a)})}return j.product.apply(j,k(a).mapApply(function(a,b){return b.map(function(b){return[a,b]})}).toArray()).map(function(a){return k(a).toObject()}).toArray()},contingent:function(a,b,c){return new z(this,a,b,c)},resultBounds:function(){return[-1,1]},normalizedResult:function(a){a=a||this.result();var c;if(a&&"object"==typeof a){c=this.resultBounds(),a=b.copy(a);for(var d in a)a[d]=(a[d]-c[0])/(c[1]-c[0])*2-1;return a}return"number"==typeof a?(c=this.resultBounds(),(+a-c[0])/(c[1]-c[0])*2-1):null},zerosumResult:function(a,b){b=b?Array.isArray(b)?b:[b]:this.activePlayers,a=+a/(b.length||1);var c=-a/(this.players.length-b.length||1);return k(this.players).map(function(d){return[d,b.indexOf(d)<0?c:a]}).toObject()},victory:function(a,b){return this.zerosumResult(b||1,a)},defeat:function(a,b){return this.zerosumResult(b||-1,a)},tied:function(a,b){return b=+(b||0),k(a||this.players).map(function(a){return[a,b]}).toObject()},isZeroSum:!0,isDeterministic:!1,isSimultaneous:!1,__hash__:function(){return c.hashCode(this).toString(36)},clone:function(){return c.clone(this)},toString:function(){return c.ser(this)},"static make":function(a){return a=f({},a),a.hasOwnProperty("name")||"function"!=typeof a.constructor||(a.name=a.constructor.name),h("string"!=typeof a.name||!a.name,"A game must have a `name`!"),h(!Array.isArray(a.players),"A game must have `players`!"),i(this,a)},"static cacheProperties":function(){var a=this;return Array.prototype.slice.call(arguments).forEach(function(b){var c="__"+b+"$cache__",d=a.prototype[b];a.prototype[b]=function(){return arguments.length>0?d.apply(this,arguments):(this.hasOwnProperty(c)||(this[c]=d.call(this)),this[c])}}),a},"static serialized":function(a){var b=a.prototype.moves,c=a.prototype.next;return i(a,{moves:function(){for(var a,c=this.__fixedMoves__||(this.__fixedMoves__={}),d=b.call(this),f=0;f<this.activePlayers.length;f++)if(c.hasOwnProperty(this.activePlayers[f])){a=this.activePlayers[f];break}return a&&d?e(a,d[a]):null},next:function(a){var b,d=f({},this.fixedMoves||{},a),e=k(this.players).all(function(a){return d.hasOwnProperty(a)});return e?(b=c.call(this,d),b.fixedMoves={}):(b=this.clone(),b.fixedMoves=d),b}})}}),x=q.Player=i({constructor:function(){var a=0;return function(b){var c=Object.getPrototypeOf(this);n(this,b).string("name",{defaultValue:"Player"+a++,coerce:!0}).object("random",{defaultValue:c.random})}}(),random:m.DEFAULT,decision:function(a,b){return this.movesFor(a,b)[0]},movesFor:function(a,b){var c=a.moves();return h(!c||!c[b]||c[b].length<1,"Player ",b," has no moves for game ",a,"."),c[b]},isCompatibleWith:function(a){return!0},participate:function(a,b){return this},"static make":function(a){return i(this,a)},"dual playTo":function(a){var b=this,c=a.players.map(function(a){return"function"==typeof b?new b:b});return new y(a,c)},"static __SERMAT__":{identifier:"Player",serializer:function(a){return[{name:a.name}]}},toString:function(){return c.ser(this)}}),y=q.Match=i({constructor:function(a,b){this.game=a,this.players=Array.isArray(b)?k(a.players).zip(b).toObject():b,this.history=[{state:a}],this.events=new p({events:["begin","next","end","quit"]});for(var c in this.players)this.players[c]=this.players[c].participate(this,c)||this.players[c]},ply:function(){return this.history.length-1},state:function(a){return a=isNaN(a)?this.ply():+a<0?this.ply()+ +a:+a,this.history[0|a].state},result:function(){return this.state().result()},decisions:function(a){a=a||this.state();var b=this.players,c=a.activePlayers;return l.all(c.map(function(c){return b[c].decision(a.view(c),c)})).then(function(a){var b=k(c).zip(a).toObject();return b})},run:function(a){if(a=isNaN(a)?1/0:+a,a<1)return l.when(this);var b,c=this.ply(),d=this.state();if(c<1&&this.onBegin(d),d=this.__advanceContingents__(d),b=d.result())return this.onEnd(d,b),l.when(this);var e=this;return this.decisions(d).then(function(b){return e.__advance__(d,b)?e.run(a-1):e})},__advanceContingents__:function(a){for(var b,c;a.isContingent;)b=a.randomHaps(),this.history[this.history.length-1].haps=b,c=a.next(b),this.history.push({state:c}),this.onNext(a,null,b,c),a=c;return a},__advance__:function(a,b){var c=this,d=!k(a.activePlayers).all(function(a){var d=b[a];return"function"!=typeof d.__command__||d.__command__(c,a)});if(d)return!1;var e=a.next(b);return this.history[this.history.length-1].moves=b,this.history.push({state:e}),this.onNext(a,b,null,e),!0},"static commands":{Quit:i({__command__:function(a,b){return a.onQuit(a.state(),b),!1}})},onBegin:function(a){this.events.emit("begin",a,this),this.logger&&this.logger.info("Match begins with ",k(this.players).map(function(a){return a[1]+" as "+a[0]}).join(", "),"; for ",a,".")},onNext:function(a,b,c,d){this.events.emit("next",a,b,c,d,this),this.logger&&this.logger.info("Match advances from ",a," to ",d)},onEnd:function(a,b){this.events.emit("end",a,b,this),this.logger&&this.logger.info("Match for ",a,"ends with ",JSON.stringify(b))},onQuit:function(a,b){this.events.emit("quit",a,b,this),this.logger&&this.logger.info("Match for ",a," aborted because player "+b+" quitted.")},"static randomMatch":function(a,c){c=c||{};var d=t.RandomPlayer.playTo(a);return c.log&&("object"==typeof c.log?d.logger=c.log:(d.logger=new b.Logger("string"==typeof c.log?c.log:"Match"),d.logger.appendToConsole())),d},toString:function(){return c.ser(this)},"static __SERMAT__":{identifier:"Match",serializer:function(a){return[a.game,a.players,a.history]},materializer:function(a,b){if(b){var c=new y(b[0],b[1]);return c.history=b[2],c}return null}}}),z=q.Contingent=i({isContingent:!0,constructor:function(a,b,c,d){this.state=a,this.moves=b,this.haps=c,this.update=!!d},next:function(a){return this.state.next(this.moves,a||this.randomHaps(),this.update)},randomHaps:function(a){return k(this.haps).mapApply(function(b,c){return[b,c.randomValue(a)]}).toObject()},randomNext:function(a){return this.next(this.randomHaps(a))},possibleHaps:function(){return j.product.apply(j,k(this.haps).mapApply(function(a,b){return b.distribution().mapApply(function(b,c){return[a,b,c]})}).toArray()).map(function(a){var b=1;return[k(a).mapApply(function(a,c,d){return b*=d,[a,c]}).toObject(),b]}).toArray()},expectedEvaluation:function(a,b,c){var d=this,e=!1,f=this.possibleHaps().map(function(f){var g=d.next(f[0]),h=g.isContingent?g.expectedEvaluation(a,b,c):b(g,a);return e=e||l.__isFuture__(h),l.then(h,function(a){return f.push(a),f})});return l.then(e?l.all(f):f,c||function(a){var b=0;return a.forEach(function(a){b+=a[1]*a[2]}),b})},toString:function(){return c.ser(this)},"static __SERMAT__":{identifier:"Contingent",serializer:function(a){return[a.state,a.moves,a.haps]}}}),A=q.Tournament=i({constructor:function(a,b){this.game=a,this.players=Array.isArray(b)?b:iterables.iterable(b).toArray(),this.statistics=new o,this.events=new p({events:["begin","beforeMatch","afterMatch","end"]})},__advance__:d("Tournament","__advance__"),run:function(){this.onBegin();var a=this;return l.doWhile(function(){return l.then(a.__advance__(),function(b){return b?(a.beforeMatch(b),a.__runMatch__(b).then(function(b){return a.account(b),a.afterMatch(b),b})):null})}).then(this.onEnd.bind(this))},__runMatch__:function(a){return a.run()},account:function(a){var b=this.game,c=a.result(),d=this.statistics;h(!c,"Match doesn't have results. Has it finished?"),k(a.players).forEach(function(e){var f=e[0],g=e[1],h=c[e[0]];d.add({key:"results",game:b.name,role:f,player:g.name},h),d.add({key:h>0?"victories":h<0?"defeats":"draws",game:b.name,role:f,player:g.name},h),d.add({key:"length",game:b.name,role:f,player:g.name},a.ply()),a.history.forEach(function(a){var b=a.state;if("function"==typeof b){var c=b.moves();c&&c.hasOwnProperty(f)&&c[f].length>0&&d.add({key:"width",game:b.name,role:f,player:g.name},c[f].length)}})})},onBegin:function(){this.events.emit("begin",this),this.logger&&this.logger.info("Tournament begins for game ",game.name,".")},beforeMatch:function(a){this.events.emit("beforeMatch",a,this),this.logger&&this.logger.debug("Beginning match with ",JSON.stringify(a.players),".")},afterMatch:function(a){this.events.emit("afterMatch",a,this),this.logger&&this.logger.debug("Finishing match with ",JSON.stringify(a.players),".")},onEnd:function(){this.events.emit("end",this.statistics,this),this.logger&&this.logger.info("Tournament ends for game ",game.name,":\n",this.statistics,"\n")},toString:function(){return c.ser(this)},"static __SERMAT__":{identifier:"Tournament",serializer:function(a){return[a.game,a.players]}}}),B=v.Checkerboard=i({constructor:function(a,b){isNaN(a)||(this.height=0|a),isNaN(b)||(this.width=0|b)},emptySquare:null,isValidCoord:function(a){return Array.isArray(a)&&!isNaN(a[0])&&!isNaN(a[1])&&a[0]>=0&&a[0]<this.height&&a[1]>=0&&a[1]<this.width},coordinates:function(){return j.range(this.height).product(j.range(this.width))},square:d("utils.Checkerboard","square"),isEmptySquare:function(a){return this.square(a)===this.emptySquare},horizontals:function(){var a=this.width;return j.range(this.height).map(function(b){return j.range(a).map(function(a){return[b,a]})})},verticals:function(){var a=this.height;return j.range(this.width).map(function(b){return j.range(a).map(function(a){return[a,b]})})},orthogonals:function(){return this.horizontals().chain(this.verticals())},positiveDiagonals:function(){var a=this.width,b=this.height,c=b+a-1;return j.range(c).map(function(a){var d=Math.max(0,b-a-1),e=Math.max(0,a-b+1);return j.range(Math.min(a+1,c-a)).map(function(a){return[d+a,e+a]})})},negativeDiagonals:function(){var a=this.width,b=this.height,c=b+a-1;return j.range(c).map(function(a){var d=Math.min(a,b-1),e=Math.max(0,a-b+1);return j.range(Math.min(a+1,c-a)).map(function(a){return[d-a,e+a]})})},diagonals:function(){return this.positiveDiagonals().chain(this.negativeDiagonals())},lines:function(){return this.orthogonals().chain(this.diagonals())},sublines:function(a,b){return k(a).map(function(a){return Array.isArray(a)?a:k(a).toArray()},function(a){return a.length>=b}).map(function(a){return j.range(0,a.length-b+1).map(function(c){return a.slice(c,c+b)})}).flatten()},walk:function(a,b){var c=this;return new j(function(){var d=a.slice();return function(){if(c.isValidCoord(d)){var a=d.slice();return d[0]+=b[0],d[1]+=b[1],a}throw j.STOP_ITERATION}})},walks:function(a,b){var c=this;return b.map(function(b){return c.walk(a,b)})},"static DIRECTIONS":{HORIZONTAL:[[0,-1],[0,1]],VERTICAL:[[-1,0],[1,0]],ORTHOGONAL:[[0,-1],[0,1],[-1,0],[1,0]],DIAGONAL:[[-1,-1],[-1,1],[1,-1],[1,1]],EVERY:[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[-1,1],[1,-1],[1,1]]},clone:d("utils.Checkerboard","clone"),__place__:d("utils.Checkerboard","place"),place:function(a,b){return this.clone().__place__(a,b)},__move__:function(a,b,c){return this.__place__(b,this.square(a)).__place__(a,"undefined"==typeof c?this.emptySquare:c)},move:function(a,b,c){return this.clone().__move__(a,b,c)},__swap__:function(a,b){var c=this.square(b);return this.__place__(b,this.square(a)).__place__(a,c)},swap:function(a,b){return this.clone().__swap__(a,b)},transform:function(a){var b=this.clone(),c=this;return this.coordinates().forEach(function(d){var e=a.apply(c,[c,d].concat(d));b.__place__(e,c.square(d))}),b},horizontalSymmetry:function(){return this.transform(function(a,b,c,d){return[c,a.width-d-1]})},verticalSymmetry:function(){return this.transform(function(a,b,c,d){return[a.height-c-1,d]})},clockwiseRotation:function(){return this.transform(function(a,b,c,d){return[d,a.height-c-1]})},counterClockwiseRotation:function(){return this.transform(function(a,b,c,d){return[a.width-d-1,c]})},renderAsHTMLTable:function(a,c,d){var e=this,f=a.createElement("table");return c.appendChild(f),e.horizontals().reverse().forEach(function(c){var g=a.createElement("tr");f.appendChild(g),c.forEach(function(c){var f=e.square(c),h=a.createElement("td"),i={id:"ludorum-square-"+c.join("-"),className:"ludorum-square",square:f,coord:c,innerHTML:b.Text.escapeXML(f)};d&&(i=d(i)||i),h["ludorum-data"]=i,h.id=i.id,h.className=i.className,h.innerHTML=i.innerHTML,i.onclick&&(h.onclick=i.onclick),g.appendChild(h)})}),f},weightedSum:function(a,b){var c=this;return this.coordinates().zip(a).mapApply(function(a,d){return b[c.square(a)]*d||0}).sum()}}),C=v.CheckerboardFromString=i(B,{constructor:function(a,b,c,d){if(B.call(this,a,b),d&&d!==this.emptySquare&&(this.emptySquare=(d+"").charAt(0)),c&&c.length!==a*b)throw new Error("Given string "+JSON.stringify(c)+" does not match board dimensions.");this.string=c||this.emptySquare.repeat(a*b)},emptySquare:".",toString:function(){var a=this.string,b=this.height,c=this.width;return j.range(b).map(function(d){return a.substr((b-d-1)*c,c)}).join("\n")},square:function(a,b){var c=a[0],d=a[1],e=this.width;return c>=0&&c<this.height&&d>=0&&d<e?this.string.charAt(c*e+d):b},asString:function(a){var b=this;return a.map(function(a){return b.square(a)}).join("")},asStrings:function(a){var b=this;return a.map(function(a){return b.asString(a)})},asRegExp:function(a,b,c){c=c||".";var d=this.width,e=j.repeat(!1,d*this.height).toArray();a.forEach(function(a){e[a[0]*d+a[1]]=!0});for(var f,g="",h=0,i=0;i<e.length;h=0){f=e[i];do++h;while(++i<e.length&&e[i]===f);g+=h<2?f?b:c:(f?b:c)+"{"+h+"}"}return g},asRegExps:function(a,b,c){var d=this;return a.map(function(a){return d.asRegExp(a,b,c)}).join("|")},clone:function(){return new this.constructor(this.height,this.width,this.string,this.hasOwnProperty("emptySquare")?this.emptySquare:void 0)},__place__:function(a,b){h(!this.isValidCoord(a),"Invalid coordinate ",a,"."),b=(b+this.emptySquare).charAt(0);var c=a[0]*this.width+a[1];return this.string=this.string.substr(0,c)+b+this.string.substr(c+1),this},"static __SERMAT__":{identifier:"CheckerboardFromString",serializer:function(a){var b=[a.height,a.width,a.string];return a.hasOwnProperty("emptySquare")&&b.push(a.emptySquare),b}}});v.CheckerboardFromPieces=i(B,{constructor:function(a,c,d,e){B.call(this,a,c);var f=this;e!==this.emptySquare&&(this.emptySquare=e),Array.isArray(d)?(this.pieces={},k(d||[]).forEach(function(a){h(!Array.isArray(a.position),"Piece has not a position (",a,")!"),f.pieces[a.position+""]=a})):"object"==typeof d?this.pieces=b.copy({},d):g("Invalid pieces definition: ",d,"!")},emptySquare:null,toString:function(){return"["+k(this.pieces).select(1).join(", ")+"]"},square:function(a,b){return this.pieces[a]||b},clone:function(){return new this.constructor(this.height,this.width,this.pieces,this.emptySquare)},__place__:function(a,b){h(!this.isValidCoord(a),"Invalid coordinate ",a,"!");var c=a+"";return delete this.pieces[c],b&&(this.pieces[c]=b),this},"static __SERMAT__":{identifier:"CheckerboardFromPieces",serializer:function(a){var b=[a.height,a.width,a.pieces];return a.hasOwnProperty("emptySquare")&&b.push(a.emptySquare),b}}});q.utils.Scanner=i({constructor:function(a){n(this,a).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:m.DEFAULT}).object("statistics",{defaultValue:new o})},scan:function(a){var b=this,c=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),d=0;return l.whileDo(function(){return c.length>0&&d<b.maxLength},function(){return l.all(c.map(function(c){return b.__advance__(a,c,d)})).then(function(a){return c=k(a).flatten().sample(b.maxWidth,b.random).toArray(),++d})}).then(function(){return b.statistics.add({key:"aborted"},c.length),b.statistics})},scans:function(){return l.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(a,b,c){if(b instanceof J)return k(b.distribution()).mapApply(function(a,c){return b.next(a)});if(this.account(a,b,c))return j.EMPTY;var d=b.moves(),e=this.statistics;return l.all(b.activePlayers.map(function(c){if(a&&a[c]){var f=a[c],g=e.stat({key:"decision.time",game:b.name,role:c,player:f.name});return g.startTime(),l.when(f.decision(b,c)).then(function(a){return g.addTime(),[[c,a]]})}return d[c].map(function(a){return[c,a]})})).then(function(a){return j.product.apply(j,a).map(function(a){return b.next(k(a).toObject())})})},account:function(a,b,c){var d=b.result(),e=this.statistics;if(d)return k(b.players).forEach(function(f){var g=d[f],h=a&&a[f]?a[f].name:"";["game:"+b.name,"role:"+f,"player:"+h];e.add({key:"game.result",game:b.name,role:f,player:h},g,b),e.add({key:"game.length",game:b.name,role:f,player:h},c,b),g<0?(e.add({key:"defeat.result",game:b.name,role:f,player:h},g,b),e.add({key:"defeat.length",game:b.name,role:f,player:h},c,b)):g>0?(e.add({key:"victory.result",game:b.name,role:f,player:h},g,b),e.add({key:"victory.length",game:b.name,role:f,player:h},c,b)):e.add({key:"draw.length",game:b.name,role:f,player:h},c,b)}),!0;var f=b.moves();return k(b.activePlayers).forEach(function(a){e.add({key:"game.width",game:b.name,role:a},f[a].length)}),!1}}),v.Cache=i({constructor:function(a){this.clear(),a&&this.root(a)},stateIdentifier:function(a){return a.identifier()},moveIdentifier:function(a){return JSON.stringify(a)},has:function(a){var b="string"==typeof a?a:this.stateIdentifier(a);return this.__entries__.hasOwnProperty(b)},get:function(a){var b="string"==typeof a?a:this.stateIdentifier(a);return this.__entries__[b]},size:function(){return Object.keys(this.__entries__).length},entry:function(a,b){if(b=b||this.stateIdentifier(a),this.has(b))return this.get(b);var c={id:b,state:a,precursors:[],descendants:{}};return this.__entries__[b]=c,c},descendant:function(a,b){var c=this.moveIdentifier(b),d=a.descendants;if(d.hasOwnProperty(c))return d[c][1];var e=a.state.next(b),f=this.stateIdentifier(e),g=this.get(f)||this.entry(e,f);return d[c]=[b,g],g.precursors.push([b,a]),g},descendants:function(a){var b=this.descendant.bind(this,a);return arguments.length>1?Array.prototype.slice.call(arguments,1).map(b):a.state.possibleMoves().map(b)},clear:function(){this.__entries__={},this.__root__=null},root:function(a){if(arguments.length>0){var b=this.stateIdentifier(a);this.__root__=this.get(b)||this.entry(a,b),this.prune(b)}return this.__root__},prune:function(a){for(var b,c=[a||this.__root__.id],d={};a=c.shift();)d.hasOwnProperty(a)||(b=this.get(a),d[a]=b,c.push.apply(c,k(b.descendants).mapApply(function(a,b){return b[1][a]}).toArray()));return this.__entries__=d}});var D=v.GameTree=i({constructor:function(a){this.parent=a&&a.parent,this.state=a&&a.state,this.transition=a&&a.transition,this.probability=a&&+a.probability,this.children=a&&a.children,this.state&&!this.children&&(this.children=this.possibleTransitions())},possibleTransitions:function(){var a=this.state,b=this.constructor,c=this;return h(!a,"GameTree node has no state!"),a.isContingent?a.possibleHaps().map(function(a){var d=new b({parent:c,transition:a[0],probability:a[1]});return d}):a.possibleMoves().map(function(a){return new b({parent:c,transition:a})})},childrenCount:function(){return this.children||(this.children=this.possibleTransitions()),this.children.length},__expandChild__:function(a){if(!a.state)try{a.state=a.parent.state.next(a.transition)}catch(b){g("Node expansion for ",a.parent.state," with ",JSON.stringify(a.transition)," failed with: ",b)}return a},expand:function(a){return h(a<0||a>=this.childrenCount(),"Cannot expand children ",a,"!"),this.__expandChild__(this.children[a])},expandRandom:function(a){return a=a||m.DEFAULT,this.expand(a.randomInt(this.childrenCount()))},expandAll:function(){for(var a=0,b=this.childrenCount;a<b;a++)this.__expandChild__(this.children[a]);return this.children},toString:function(){return"GameTree("+this.state+")"},"static __SERMAT__":{identifier:"GameTree",serializer:function(a){return[{parent:a.parent,state:a.state,transition:a.transition,probability:a.probability,children:a.children}]}}});t.RandomPlayer=i(x,{constructor:function(a){x.call(this,a);var b=Object.getPrototypeOf(this);n(this,a).object("random",{defaultValue:b.random})},random:m.DEFAULT,decision:function(a,b){return h(a.isContingent,"Contingent game state has no moves!"),this.random.choice(this.movesFor(a,b))},"static __SERMAT__":{identifier:"RandomPlayer",serializer:function(a){return this.serializeAsProperties(a,["name","random"])}}}),t.TracePlayer=i(x,{constructor:function(a){x.call(this,a),this.trace=k(a.trace),this.__iter__=this.trace.__iter__(),this.__decision__=this.__iter__()},decision:function(a,b){try{this.__decision__=this.__iter__()}catch(c){j.prototype.catchStop(c)}return this.__decision__},"static __SERMAT__":{identifier:"TracePlayer",serializer:function(a){var b=x.__SERMAT__.serializer(a),c=b[0];return c.trace=a.trace.toArray(),b}}});var E=t.HeuristicPlayer=i(x,{constructor:function(a){x.call(this,a);Object.getPrototypeOf(this);n(this,a).func("heuristic",{ignore:!0})},moveEvaluation:function(a,b,c){var d=this;if(Object.keys(a).length<2)return this.stateEvaluation(b.next(a),c);var g=0,h=0;return a=f(e(c,[a[c]]),a),b.possibleMoves(a).forEach(function(a){g+=d.stateEvaluation(b.next(a),c),++h}),h>0?g/h:0},stateEvaluation:function(a,b){if(a.isContingent)return a.expectedEvaluation(b,this.stateEvaluation.bind(this));var c=a.result();return c?c[b]:this.heuristic(a,b)},heuristic:function(a,b){return this.random.random(-.5,.5)},evaluatedMoves:function(a,b){var c=this,d=!1;h(a.isContingent,"Contingent game state has no moves!");var e=this.possibleMoves(a,b).map(function(e){var f=c.moveEvaluation(e,a,b);return d=d||l.__isFuture__(f),l.then(f,function(a){return[e,a]})});return d?l.all(e):e},possibleMoves:function(a,b){var c=a.moves();return h(!c||!c[b]||!Array.isArray(c[b])||c[b].length<1,"Player "+b+" has no moves in "+a+" (moves= "+c+")!"),c[b].map(function(a){return f(e(b,a),c)})},bestMoves:function(a){return l.then(a,function(a){return k(a).greater(function(a){return a[1]}).map(function(a){return a[0]})})},decision:function(a,b){var c=this.random;return l.then(this.bestMoves(this.evaluatedMoves(a,b)),function(d){return h(!d||!d.length,"No moves where selected at ",a," for player ",b,"!"),c.choice(d)[b]})},"static composite":function(){var a=Array.prototype.slice.call(arguments);h(a.length<1,"HeuristicPlayer.composite() cannot take an odd number of arguments!");for(var b=0;b<a.length;b+=2)h("function"!=typeof a[b],"HeuristicPlayer.composite() argument ",b," (",a[b],") is not a function!"),a[b+1]=+a[b+1],h(isNaN(a[b+1])||a[b+1]<0||a[b+1]>1,"HeuristicPlayer.composite() argument ",b+1," (",a[b+1],") is not a valid weight!");return function(b,c){for(var d=0,e=0;e+1<a.length;e+=2)d+=a[e](b,c)*a[e+1];return d}},"static __SERMAT__":{identifier:"HeuristicPlayer",serializer:function(a){var b=x.__SERMAT__.serializer(a),c=b[0];return a.hasOwnProperty("heuristic")&&(c.heuristic=a.heuristic),b}}}),F=(t.MaxNPlayer=i(E,{constructor:function(a){E.call(this,a);var b=Object.getPrototypeOf(this);n(this,a).integer("horizon",{defaultValue:b.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(a){return!a.isSimultaneous&&a.isDeterministic},stateEvaluation:function(a,b){return a.isContingent?void g("MaxNPlayer.stateEvalution() does not support contingent game states!"):this.maxN(a,b,0)[b]},heuristics:function(a){var b={},c=this;return a.players.forEach(function(d){b[d]=c.heuristic(a,d)}),b},quiescence:function(a,b,c){var d=a.result();return d?d:c>=this.horizon?this.heuristics(a):null},maxN:function(a,b,c){var d=this.quiescence(a,b,c);if(!d){var f,g,h=a.activePlayer(),i=this.movesFor(a,h);if(d={},i.length<1)throw new Error("No moves for unfinished game "+a+".");for(var j=0;j<i.length;++j)g=a.next(e(h,i[j])),f=this.maxN(g,b,c+1),f[h]>(d[h]||-(1/0))&&(d=f)}return d},"static __SERMAT__":{identifier:"MaxNPlayer",serializer:function(a){var b=E.__SERMAT__.serializer(a),c=b[0];return c.horizon=a.horizon,b}}}),t.MiniMaxPlayer=i(E,{constructor:function(a){E.call(this,a);var b=Object.getPrototypeOf(this);n(this,a).integer("horizon",{defaultValue:b.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(a){return!a.isSimultaneous},stateEvaluation:function(a,b){return this.minimax(a,b,0)},quiescence:function(a,b,c){var d=a.result();return d?d[b]:c>=this.horizon?this.heuristic(a,b):NaN},minimax:function(a,b,c){if(a.isContingent)return this.expectiMinimax(a,b,c);var d=this.quiescence(a,b,c);if(isNaN(d)){var f,g,h=a.activePlayer(),i=this.movesFor(a,h);if(i.length<1)throw new Error("No moves for unfinished game "+a+".");h==b?(d=-(1/0),f=Math.max):(d=+(1/0),f=Math.min);for(var j=0;j<i.length;++j)g=a.next(e(h,i[j])),d=f(d,this.minimax(g,b,c+1))}return d},expectiMinimax:function(a,b,c){if(a.isContingent){var d=this;return a.expectedEvaluation(b,function(a,b){return d.minimax(a,b,c+1)})}return this.minimax(a,b,c)},"static __SERMAT__":{identifier:"MiniMaxPlayer",serializer:function(a){var b=E.__SERMAT__.serializer(a),c=b[0];return c.horizon=a.horizon,b}}}));t.AlphaBetaPlayer=i(F,{constructor:function(a){F.call(this,a)},stateEvaluation:function(a,b){return this.minimax(a,b,0,-(1/0),1/0)},minimax:function(a,b,c,d,f){if(a.isContingent)return this.expectiMinimax(a,b,c,d,f);var h=this.quiescence(a,b,c);if(!isNaN(h))return h;var i,j=a.activePlayer(),k=j==b,l=this.movesFor(a,j);l.length<1&&g("No moves for unfinished game "+a+"!");for(var m=0;m<l.length&&(i=a.next(e(j,l[m])),h=this.minimax(i,b,c+1,d,f),k?d<h&&(d=h):f>h&&(f=h),!(f<=d));m++);return k?d:f},expectiMinimax:function(a,b,c,d,e){if(a.isContingent){var f=this;return a.expectedEvaluation(b,function(a,b){return f.minimax(a,b,c+1,d,e)})}return this.minimax(a,b,c)},"static __SERMAT__":{identifier:"AlphaBetaPlayer",serializer:function(a){return F.__SERMAT__.serializer(a)}}});var G=t.MonteCarloPlayer=i(E,{constructor:function(a){E.call(this,a);var b=Object.getPrototypeOf(this);if(n(this,a).number("simulationCount",{defaultValue:b.simulationCount,coerce:!0}).number("timeCap",{defaultValue:b.timeCap,coerce:!0}).number("horizon",{defaultValue:b.horizon,coerce:!0}),a)switch(typeof a.agent){case"function":this.agent=new E({heuristic:a.agent});break;case"object":this.agent=a.agent;break;default:this.agent=null}},simulationCount:30,timeCap:1e3,horizon:500,evaluatedMoves:function(a,b){h(a.isContingent,"MonteCarloPlayer cannot evaluate root contingent states!");for(var c=this,d=Date.now(),g=this.possibleMoves(a,b).map(function(c){return{move:c,nexts:Object.keys(c).length<2?[a.next(c)]:a.possibleMoves(f(e(b,[c[b]]),c)).map(function(b){return a.next(b)}),sum:0,count:0}}),i=0;!this.__finishMoveEvaluation__(i,d,g);)g.forEach(function(a){a.nexts=a.nexts.filter(function(d){var e=c.simulation(d,b);return a.sum+=e.result,++a.count,e.plies>0}),i++});return g.map(function(a){return h(isNaN(a.sum),"State evaluation is NaN for move ",a.move,"!"),[a.move,a.count>0?a.sum/a.count:0,a.count]})},__finishMoveEvaluation__:function(a,b,c){return a>this.simulationCount||b+this.timeCap<Date.now()},stateEvaluation:function(a,b){for(var c,d=0,e=this.simulationCount,f=0;f<e&&(c=this.simulation(a,b),d+=c.result[b],!(c.plies<1));++f);return e>0?d/e:0},quiescence:function(a,b,c){var d=a.result();return d?d[b]:c>=this.horizon?this.heuristic(a,b):NaN},simulation:function(a,b){var c,d,e,f=this,h={game:a};for(c=0;!0;++c)if(a.isContingent)a=a.randomNext(this.random);else{e=a.moves();var i=this.quiescence(a,b,c+1);if(!isNaN(i))return h.result=i,h.plies=c,h;d={},a.activePlayers.forEach(function(b){d[b]=f.agent?f.agent.decision(a,b):f.random.choice(e[b])}),a=a.next(d,null,c>0)}g("Simulation ended unexpectedly for player ",b," in game ",a,"!")},"static __SERMAT__":{identifier:"MonteCarloPlayer",serializer:function(a){var b=E.__SERMAT__.serializer(a),c=b[0];return c.simulationCount=a.simulationCount,c.timeCap=a.timeCap,c.horizon=a.horizon,a.agent&&(c.agent=a.agent),b}}});t.UCTPlayer=i(G,{constructor:function(a){G.call(this,a);var b=Object.getPrototypeOf(this);n(this,a).number("explorationConstant",{defaultValue:b.explorationConstant,coerce:!0})},explorationConstant:Math.sqrt(2),selectNode:function(a,b,c){return c=isNaN(c)?this.explorationConstant:+c,this.random.choice(k(a.children).greater(function(a){return(a.uct.rewards+a.uct.visits)/a.uct.visits/2+c*Math.sqrt(Math.log(b)/a.uct.visits)}))},evaluatedMoves:function(a,b){var c,d,e=new D({state:a}),f=Date.now();e.uct={pending:e.childrenCount(),visits:0,rewards:0};for(var g=0;!this.__finishMoveEvaluation__(g,f,e);g++){for(c=e;c.uct.pending<1&&c.childrenCount()>0;)c=this.selectNode(c,g+1,this.explorationConstant);for(c.uct.pending>0&&(c=c.expandRandom(this.random),c.uct={pending:e.childrenCount(),visits:0,rewards:0}),d=this.simulation(c.state,b);c;c=c.parent)++c.uct.visits,c.uct.rewards+=a.normalizedResult(d.result)}return k(e.children).map(function(a){return a.uct?[a.transition,a.uct.rewards/a.uct.visits,a.uct.visits]:[a.transition,0,0]}).toArray()},"static __SERMAT__":{identifier:"UCTPlayer",serializer:function(a){var b=G.__SERMAT__.serializer(a),c=b[0];return c.explorationConstant=a.explorationConstant,b}}}),t.RuleBasedPlayer=i(x,{constructor:function(a){x.call(this,a),n(this,a).array("rules",{defaultValue:[]}).func("features",{ignore:!0})},features:function(a,b){return[a,b]},decision:function(a,b){for(var c=null,d=this.features(a,b),e=this.movesFor(a,b),f=0,g=this.rules.length;f<g;f++)if(c=this.rules[f].call(this,d),null!==c&&e.indexOf(c)>=0)return c;return this.random.choice(e)},rule:function(a){return h("function"!=typeof a,"A rule must be in the form of a function!"),this.rules.push(a),this},"static regExpRule":function(a,b){return function(c){return a.test(c)?b:null}},regExpRule:function(a,b){return this.rule(this.constructor.regExpRule(a,b))},"static __SERMAT__":{identifier:"RuleBasedPlayer",serializer:function(a){var b=x.__SERMAT__.serializer(a),c=b[0];return c.rules=a.rules,a.hasOwnProperty("features")&&(c.features=a.features),b}}}),t.EnsemblePlayer=i(x,{constructor:function(a){x.call(this,a),n(this,a).array("players",{ignore:!0})},players:[],playerSelection:function(a,b){return this.players},decision:function(a,b){return this.randomDecision(a,b)},randomDecision:function(a,b,c){return c=c||this.playerSelection(a,b),h(c.length<1,"No player was selected!"),(1==c.length?c[0]:this.random.choice(c)).decision(a,b)},heuristicCombination:function(){function a(a,b,c,d){
return k(b).sum()/b.length}return function(b){return b=b||a,function(a,c,d){d=d||this.playerSelection(a,c);var e=!1,f=this,g=d.map(function(b){h(!b.evaluatedMoves,"Cannot call `evaluatedMoves()` on player ",b.name,"(",b.constructor.name,")!");var d=b.evaluatedMoves(a,c);return e=e||l.__isFuture__(d),d});return e?l.all(g).then(function(d){return f.__bestAggregatedEvaluationMove__(a,c,b,d)}):f.__bestAggregatedEvaluationMove__(a,c,b,g)}}}(),__aggregateEvaluatedMoves__:function(a,b,c,d){var e=k(d).flatten().groupAll(function(a){return JSON.stringify(a[0])},function(a,b){return a?(a[1].push(b[1]),a):[b[0],[b[1]]]});return k(e).mapApply(function(d,e){return[e[0],c(e[0],e[1],a,b)]})},__bestAggregatedEvaluationMove__:function(a,b,c,d){var e=this.__aggregateEvaluatedMoves__(a,b,c,d);h(e.isEmpty(),"There are no evaluated moves for ",b," to choose from in ",a,"!");var f=E.prototype.bestMoves(e),g=this.random.choice(f);return g[b]},"static parallelizeHeuristicPlayer":function(a,c){a=a||navigator.hardwareConcurrency;var d=b.Iterable.range(a).map(function(){return ludorum.players.WebWorkerPlayer.create(c)}),e=this;return b.Future.all(d.toArray()).then(function(a){var b=new e({players:a});return b.decision=b.heuristicCombination(),b})},"static __SERMAT__":{identifier:"EnsemblePlayer",serializer:function(a){return this.serializeAsProperties(a,["name","random","players"])}}});var H=t.UserInterfacePlayer=i(x,{constructor:function(a){x.call(this,a)},participate:function(a,b){return this.role=b,this},decision:function(a,b){return this.__future__&&this.__future__.isPending()&&this.__future__.resolve(new y.commands.Quit),this.__future__=new l,this.__future__},perform:function(a){var b=this.__future__;return b&&(this.__future__=null,b.resolve(a)),!!b}}),I=t.UserInterface=i({constructor:function(a){this.onBegin=this.onBegin.bind(this),this.onNext=this.onNext.bind(this),this.onEnd=this.onEnd.bind(this),a.match&&this.show(a.match)},show:function(a){this.match&&(a.events.off("begin",this.onBegin),a.events.off("next",this.onNext),a.events.off("end",this.onEnd)),this.match=a,a.events.on("begin",this.onBegin),a.events.on("next",this.onNext),a.events.on("end",this.onEnd)},onBegin:function(a){this.display(a)},onNext:function(a,b,c,d){this.display(d)},onEnd:function(a,b){this.results=b,this.display(a)},display:d("UserInterface","display"),perform:function(a,b){k(this.match.players).forEach(function(c){var d=(c[0],c[1]);d instanceof H&&(!b||d.role===b)&&d.perform(a)})}});I.BasicHTMLInterface=i(I,{constructor:function(a){I.call(this,a),this.document=a.document||b.global.document,this.container=a.container,"string"==typeof this.container&&(this.container=this.document.getElementById(this.container))},display:function(a){for(var b,c=this.container;b=c.firstChild;)c.removeChild(b);a.display(this)},build:function(a,b){var c=this;return b.forEach(function(b){var d;if(Array.isArray(b)){if(d=c.document.createElement(b[0]),b.length>2&&b[1]){var e=b[1];for(var f in e)attr.hasOwnProperty(f)&&d.setAttribute(f,e[f])}b.length>1&&b[b.length-1]&&c.build(d,b[b.length-1])}else"string"==typeof b&&(d=c.document.createTextNode(b));d&&a&&a.appendChild(d)}),a}});var J=(t.WebWorkerPlayer=i(x,{constructor:function(a){x.call(this,a),n(this,a).object("worker"),this.worker.onmessage=b.Parallel.prototype.__onmessage__.bind(this)},"static createWorker":function(a){h("string function".indexOf(typeof a.playerBuilder)<0,"Invalid player builder: "+a.playerBuilder+"!"),h(a.workerSetup&&"string function".indexOf(typeof a.workerSetup)<0,"Invalid worker setup: "+a.workerSetup+"!");var c=new b.Parallel,d=[q].concat(a.dependencies||[]);return l.sequence(d,function(a){return c.loadModule(a,!0)}).then(function(){return c.run((a.workerSetup?"("+a.workerSetup+")(),\n":"")+"self.PLAYER = ("+a.playerBuilder+').call(self),\n"OK"')}).then(function(){var a=c.worker;return a.__parallel__=c,a})},"static create":function(a){var b=this;return b.createWorker(a).then(function(a){return new b({name:name,worker:a})})},__newFuture__:function(a){var b=this.__future__;return b&&b.isPending()&&(b.hasOwnProperty("__cancelValue__")?b.resolve(b.__cancelValue__):b.reject("Canceled!")),b=new l,"undefined"!=typeof a&&(b.__cancelValue__=a),this.__future__=b,b},__onmessage__:function(a){var b=this.__future__;b&&(b.hasOwnProperty("__cancelValue__")?b.resolve(b.__cancelValue__):b.reject("Canceled!")),this.__future__=null;try{var c=JSON.parse(a.data);c.error?b.reject(c.error):b.resolve(c.result)}catch(d){b.reject(d)}},__run__:function(a){var b=this.__newFuture__(y.commandQuit);return this.worker.postMessage(a),b},decision:function(a,b){return this.__run__("PLAYER.decision(Sermat.mat("+JSON.stringify(c.ser(a))+"),"+JSON.stringify(b)+")")},evaluatedMoves:function(a,b){return this.__run__("PLAYER.evaluatedMoves(Sermat.mat("+JSON.stringify(c.ser(a))+"),"+JSON.stringify(b)+")")}}),q.aleatories.Aleatory=i({constructor:function(a){this.__distribution__=k(a).toArray(),h(this.__distribution__.length<1,"Aleatories must have at least one value!")},count:function(){return this.__distribution__.length},value:function(a){return this.__distribution__[a][0]},probability:function(a){return+this.__distribution__[a][1]},randomValue:function(a){return a=a||m.DEFAULT,a.weightedChoice(this.__distribution__)},distribution:function(){var a=this;return j.range(this.count()).map(function(b){return[a.value(b),a.probability(b)]})},"static tries":function(a,c){var d=b.math.combinations;return c<=0?[[0,1]]:j.range(c+1).map(function(b){return[b,Math.pow(a,b)*Math.pow(1-a,c-b)*d(c,b)]}).toArray()},"static aggregate":function(a,b,c,d){var e=[];return c=c||function(a,b){return a+b},d=d||function(a,b){return a===b},j.product(a,b).forEachApply(function(a,b){for(var f=c(a[0],b[0]),g=0;g<e.length;g++)if(d(e[g][0],f))return void(e[g][1]+=a[1]*b[1]);e.push([f,a[1]*b[1]])}),e},"static __SERMAT__":{identifier:"Aleatory",serializer:function(a){return[a.distribution().toArray()]}}})),K=q.aleatories.DieAleatory=i(J,{constructor:function(a,b){1===arguments.length&&(b=a,a=1),this.min=0|a,this.max=0|b},count:function(){return this.max-this.min+1},value:function(a){return a>this.max-this.min?void 0:a+this.min},probability:function(a){return a>this.max-this.min?NaN:1/(this.max-this.min+1)},randomValue:function(a){return(a||m.DEFAULT).randomInt(this.min,this.max+1)},"static __SERMAT__":{identifier:"DiceAleatory",serializer:function(a){return[a.min,a.max]}}});return r.dice={D4:new K(4),D6:new K(6),D8:new K(8),D10:new K(10),D12:new K(12),D20:new K(20)},r.uniformAleatory=function(a){a=k(a).toArray();var b=1/a.length;return new J(a.map(function(a){return[a,b]}))},r.normalization=function(a){var b=0,c=[];return k(a).forEachApply(function(a,d){h(d<0,"aleatories.normalization: probabilities cannot be negative ("+d+")!"),b+=d;for(var e=0;e<c.length;e++)if(c[e][0]===a)return void(c[e][1]+=d);c.push([a,d])}),b>0&&c.forEach(function(a){a[1]/=b}),c},r.sumProbability=function(a,c,d){if(c=0|c,d=0|d,a=0|a,isNaN(c)||isNaN(d)||isNaN(a)||c<1||d<2)return NaN;if(a<c||a>c*d)return 0;var e=b.math.factorial,f=e(c),g=f/c;return Math.pow(d,-c)*j.range(0,Math.floor((a-c)/d)+1).map(function(b){var h=f/e(b)/e(c-b),i=a-d*b-1,j=e(i)/g/e(i-c+1);return(b%2?-1:1)*h*j}).sum()},s.Predefined=i(w,{name:"Predefined",height:5,width:5,constructor:function(a,b,c,d){b&&(this.__results__=b,this.players=Object.keys(b)),w.call(this,a),isNaN(c)||(this.height=+c),isNaN(d)||(this.width=+d)},players:["A","B"],__results__:{A:0,B:0},moves:function(){if(this.height>0)return e(this.activePlayer(),j.range(1,this.width+1).toArray())},result:function(){return this.height>0?null:this.__results__},next:function(a,b,c){return h(b,"Haps are not required (given ",b,")!"),c?(this.height--,this.activatePlayers(this.opponent()),this):new this.constructor(this.opponent(),this.__results__,this.height-1,this.width)},"static __SERMAT__":{identifier:"Predefined",serializer:function(a){return[a.activePlayer(),a.__results__,a.height,a.width]}}}),s.Choose2Win=i(w,{constructor:function(a,b,c){w.call(this,b),this.__turns__=isNaN(a)?1/0:+a,this.__winner__=c},name:"Choose2Win",players:["This","That"],moves:function(){if(!this.__winner__&&this.__turns__>0)return e(this.activePlayer(),["win","lose","pass"])},result:function(){return this.__winner__?this.victory(this.__winner__):this.__turns__<1?this.draw():null},next:function(a,b,c){var d=this.activePlayer(),e=this.opponent(d);h(!a.hasOwnProperty(d),"No move for active player ",d," at ",this,"!"),h(b,"Haps are not required (given ",b,")!");var f={win:d,lose:e,pass:void 0},i=a[d];return f.hasOwnProperty(i)?c?(this.activatePlayers(e),this.__turns__--,this.__winner__=f[i],this):new this.constructor(this.__turns__-1,e,f[i]):void g("Invalid move ",a[d]," for ",d," at ",this,"!")},"static __SERMAT__":{identifier:"Choose2Win",serializer:function(a){var b=[a.__turns__,a.activePlayer()];return a.__winner__&&b.push(a.__winner__),b}}}),s.ConnectionGame=i(w,{name:"ConnectionGame",height:9,width:9,lineLength:5,constructor:function(a,b){w.call(this,a),this.board=b instanceof C?b:new C(this.height,this.width,b),this.height=this.board.height,this.width=this.board.width},players:["First","Second"],__lines__:function(){function a(a,c,d){var e=a+"x"+c+"/"+d;if(!b.hasOwnProperty(e)){var f=new C(a,c,".".repeat(a*c));b[e]=f.lines().map(function(a){return a.toArray()},function(a){return a.length>=d}).toArray()}return b[e]}var b={};return a.CACHE=b,a}(),result:function(){if(this.hasOwnProperty("__result__"))return this.__result__;for(var a=this.lineLength,b=this.board.asStrings(this.__lines__(this.height,this.width,a)).join(" "),c=0;c<this.players.length;++c)if(b.indexOf(c.toString(36).repeat(a))>=0)return this.__result__=this.victory([this.players[c]]);return b.indexOf(".")<0?this.__result__=this.tied():this.__result__=null},moves:function(){if(this.hasOwnProperty("__moves__"))return this.__moves__;if(this.result())this.__moves__=null;else{var a=this.board;this.__moves__=e(this.activePlayer(),a.coordinates().filter(function(b){return a.isEmptySquare(b)}).toArray())}return this.__moves__},next:function(a,b,c){h(b,"Haps are not required (given ",b,")!");var d=this.activePlayer(),e=this.players.indexOf(d),f=a[d],g=(e+1)%this.players.length,i=this.board.place(f,e.toString(36));return c?(this.activatePlayers(g),this.board=i,this):new this.constructor(g,i)},display:function(a){h(!(a&&a instanceof I.BasicHTMLInterface),"Unsupported UI!");var b=this.moves(),c=this.activePlayer(),d=this.board;b=b&&b[c];this.board.renderAsHTMLTable(a.document,a.container,function(e){e.className="."===e.square?"ludorum-empty":"ludorum-player"+e.square,e.innerHTML="."===e.square?"&nbsp;":"&#x25CF;";var f=e.coord[0]*d.height+e.coord[1];b&&b.indexOf(f)>=0&&(e.move=f,e.activePlayer=c,e.onclick=a.perform.bind(a,e.move,c))});return a},"static __SERMAT__":{identifier:"ConnectionGame",serializer:function(a){return[a.activePlayer(),a.board]}}}),s.OddsAndEvens=i(w,{name:"OddsAndEvens",constructor:function(a,b){w.call(this,this.players),this.turns=isNaN(a)?1:+a,this.points=b||{Evens:0,Odds:0}},isSimultaneous:!0,players:["Evens","Odds"],moves:function(){return this.turns<1?null:{Evens:[1,2],Odds:[1,2]}},result:function(){var a=this.points.Evens-this.points.Odds;return this.turns>0?null:{Evens:+a,Odds:-a}},next:function(a,b,c){h("number"!=typeof a.Evens||"number"!=typeof a.Odds,"Invalid moves ",a,"!"),h(b,"Haps are not required (given ",b,")!");var d=(a.Evens+a.Odds)%2===0,e={Evens:this.points.Evens+(d?1:0),Odds:this.points.Odds+(d?0:1)};return c?(this.turns--,this.points=e,this):new this.constructor(this.turns-1,e)},"static __SERMAT__":{identifier:"OddsAndEvens",serializer:function(a){return[a.turns,a.points]}}}),s.TicTacToe=i(w,{name:"TicTacToe",constructor:function(a,b){w.call(this,a),this.board=b||"_________"},players:["Xs","Os"],result:function(){return function(){return this.board.match(this.WIN_X)?this.victory(["Xs"]):this.board.match(this.WIN_O)?this.victory(["Os"]):this.board.indexOf("_")<0?this.tied():null}}(),moves:function(){if(this.result())return null;var a={};return a[this.activePlayer()]=k(this.board).filter(function(a,b){return"_"===a},function(a,b){return b}).toArray(),a},next:function(a,b,c){h(b,"Haps are not required (given ",b,")!");var d=this.activePlayer(),e=+a[d];if(isNaN(e)||"_"!==this.board.charAt(e))throw new Error("Invalid move "+JSON.stringify(a)+" for board "+this.board+" (moves= "+JSON.stringify(a)+").");var f=this.board.substring(0,e)+d.charAt(0)+this.board.substring(e+1);return c?(this.activatePlayers(this.opponent(d)),this.board=f,this):new this.constructor(this.opponent(d),f)},"static __SERMAT__":{identifier:"TicTacToe",serializer:function(a){return[a.activePlayer(),a.board]}},__hash__:function(a){var b={_:0,X:1,O:2};return parseInt((a||this.board).split("").map(function(a){return b[a]}).join(""),3)},symmetryHash:function(){var a="210543876 678345012 630741852 258147036 876543210 852741630 036147258".split(" ").map(function(a){return a.split("").map(function(a){return+a})}),b=function(){var b=this.board,c=a.map(function(a){return a.map(function(a){return b.charAt(a)}).join("")});return c.sort(),this.__hash__(c[0])};return b.SYMMETRIES=a,b}(),printBoard:function(){var a=this.board;return[0,3,6].map(function(b){return a.substr(0,3).split("").join("|")}).join("\n-+-+-\n")},"static heuristics":{heuristicFromWeights:function(a){function b(b,d){var e=d.charAt(0);return k(b.board).map(function(b,c){return"_"===b?0:a[c]*(b===e?1:-1)}).sum()/c}var c=k(a).map(Math.abs).sum();return b.weights=a,b}},"":function(){var a=new C(3,3,"_".repeat(9)),b=a.sublines(a.lines(),3);this.prototype.WIN_X=new RegExp(a.asRegExps(b,"X",".")),this.prototype.WIN_O=new RegExp(a.asRegExps(b,"O",".")),this.heuristics.defaultHeuristic=this.heuristics.heuristicFromWeights([2,1,2,1,5,1,2,1,2])}}),s.ToadsAndFrogs=i(w,{name:"ToadsAndFrogs",constructor:function L(a,b){w.call(this,a),this.board=b||L.board()},"static board":function(a,b){return a=isNaN(a)?3:+a,b=isNaN(b)?2:+b,"T".repeat(a)+"_".repeat(b)+"F".repeat(a)},players:["Toads","Frogs"],result:function(){return this.moves()?null:this.defeat()},moves:function(){var a=this.activePlayer(),b={},c=b[a]=[];return this.board.replace(a==this.players[0]?/TF?_/g:/_T?F/g,function(a,b){return c.push(b),a}),c.length>0?b:null},next:function(a,b,c){h(b,"Haps are not required (given ",b,")!");var d,e=this.activePlayer(),f=a[e],g=(e.charAt(0),this.board);if("T_"==g.substr(f,2))d=g.substring(0,f)+"_T"+g.substring(f+2);else if("_F"==g.substr(f,2))d=g.substring(0,f)+"F_"+g.substring(f+2);else if("TF_"==g.substr(f,3))d=g.substring(0,f)+"_FT"+g.substring(f+3);else{if("_TF"!=g.substr(f,3))throw new Error("Invalid move ",f," for board <",g,">.");d=g.substring(0,f)+"FT_"+g.substring(f+3)}return c?(this.activatePlayers(this.opponent()),this.board=d,this):new this.constructor(this.opponent(),d)},"static __SERMAT__":{identifier:"ToadsAndFrogs",serializer:function(a){return[a.activePlayer(),a.board]}},__hash__:function(a,b){var c={_:0,T:1,F:2};return a=(a||this.activePlayer()).charAt(0),b=b||this.board,parseInt((a+b).split("").map(function(a){return c[a]}).join(""),3)}}),s.Pig=i(w,{name:"Pig",constructor:function(a,b,c,d){w.call(this,a),this.goal=isNaN(b)?100:+b,this.__scores__=c||k(this.players).zip([0,0]).toObject(),this.__rolls__=d||[]},isDeterministic:!1,players:["One","Two"],moves:function(){if(!this.result()){var a=this.activePlayer(),b=this.__scores__[a]+k(this.__rolls__).sum();return e(a,this.__rolls__.length<1?["roll"]:b>=this.goal?["hold"]:["roll","hold"])}},result:function(){var a=this.__scores__[this.players[0]],b=this.__scores__[this.players[1]];if(a>=this.goal||b>=this.goal){var c={};return c[this.players[0]]=Math.min(this.goal,a)-Math.min(this.goal,b),c[this.players[1]]=-c[this.players[0]],c}},next:function(a,b,c){var d=this.activePlayer(),e=a&&a[d];h(!e,"No move for active player ",d," at ",this,"!");var i=this.opponent(),j=this.__scores__,l=[];if("hold"===e||"roll"===e){if("hold"===e)j=f(j),j[d]+=k(this.__rolls__).sum();else{var m=0|(b&&b.die);if(!m)return new z(this,a,{die:r.dice.D6},c);if(m>1)return i=d,l=this.__rolls__.concat(m),new this.constructor(d,this.goal,this.__scores__,this.__rolls__.concat(m))}return c?(this.activatePlayers(i),this.__scores__=j,this.__rolls__=l,this):new this.constructor(i,this.goal,j,l)}g("Invalid moves ",JSON.stringify(a)," at ",this,"!")},resultBounds:function(){return[-this.goal,+this.goal]},"static __SERMAT__":{identifier:"Pig",serializer:function(a){return[a.activePlayer(),a.goal,a.__scores__,a.__rolls__]}}}),s.Mutropas=i(w,{name:"Mutropas",players:["Left","Right"],constructor:function(a){w.call(this,this.players),a=a||{},this.playedPieces=a.playedPieces||[],this.pieces=a.pieces||this.dealPieces(a.random),this.__scores__=a.scores||e(this.players[0],0,this.players[1],0)},isDeterministic:!1,isSimultaneous:!0,allPieces:j.range(9).toArray(),dealPieces:function(a){a=a||m.DEFAULT;var b=this.allPieces.length/2|0,c=a.split(b,this.allPieces),d=a.split(b,c[1]);return e(this.players[0],c[0],this.players[1],d[0])},moves:function(){return this.result()?null:f({},this.pieces)},moveResult:function(a,b){var c=k(this.allPieces).max(0)+1;return a<b?b-a<=c/2?1:-1:a>b?a-b>=c/2+1?1:-1:0},next:function(a,b,c){var d=this.players[0],f=this.players[1];if(!this.pieces[d]||!this.pieces[f])return this.__viewNext__(a,b,c);var g=a[d],i=a[f],j=this.pieces;h(j[d].indexOf(g)<0,"Invalid move ",JSON.stringify(g)," for player ",d,"! (moves= ",JSON.stringify(a),")"),h(j[f].indexOf(i)<0,"Invalid move ",JSON.stringify(i)," for player ",f,"! (moves= ",JSON.stringify(a),")");var k=this.moveResult(g,i),l=this.playedPieces.concat([g,i]),m=e(d,j[d].filter(function(a){return a!==g}),f,j[f].filter(function(a){return a!==i})),n=e(d,this.__scores__[d]+k,f,this.__scores__[f]-k);return c?(this.playedPieces=l,this.pieces=m,this.__scores__=n,this):new this.constructor({playedPieces:l,pieces:m,scores:n})},__viewNext__:function(a,b,c){var d=this.pieces[this.players[0]]?this.players[0]:this.players[1],f=this.opponent(d);return b?new this.constructor({pieces:e(d,this.pieces[d],f,b[f]),playedPieces:this.playedPieces,scores:this.__scores__}).next(a,null,c):this.contingent(a,e(d,r.uniformAleatory(this.__possiblePieces__(f))),c)},scores:function(){return f({},this.__scores__)},result:function(){var a=this.players;if(this.playedPieces.length>=this.allPieces.length-1){var b=this.scores();return this.zerosumResult(b[a[0]]-b[a[1]],a[0])}return null},__possiblePieces__:function(a){var b=this.playedPieces,c=this.pieces[this.opponent(a)],d=k(this.allPieces).filter(function(a){return b.indexOf(a)<0&&c.indexOf(a)<0});return d.combinations(d.count()-1)},view:function(a){return new this.constructor({pieces:e(a,this.pieces[a]),playedPieces:this.playedPieces,scores:this.__scores__})},"static __SERMAT__":{identifier:"Mutropas",serializer:function(a){return[{pieces:a.pieces,playedPieces:a.playedPieces,scores:a.__scores__}]}}}),s.Bahab=i(w,{name:"Bahab",players:["Uppercase","Lowercase"],constructor:function(a,b){w.call(this,a),this.board=b instanceof C?b:new C(5,5,b||this.initialBoard)},initialBoard:["BBABB","BBBBB",".....","bbbbb","bbabb"].join(""),__PLAYER_ENDGAME_RE__:{Uppercase:/^[.Bab]+$|^.{0,4}[a]/,Lowercase:/^[.bAB]+$|[A].{0,4}$/},result:function(){for(var a,b=this.board.string,c=0;c<2;++c)if(a=this.players[c],b.match(this.__PLAYER_ENDGAME_RE__[a]))return this.defeat(a);return this.moves()?null:this.defeat(this.activePlayer())},__PLAYER_PIECES_RE__:{Uppercase:/[AB]/g,Lowercase:/[ab]/g},moves:function(){var a=this.activePlayer(),b=this.__PLAYER_PIECES_RE__[a],c=this.board,d=[];return c.string.replace(b,function(a,e){var f,g=[e/5|0,e%5];switch(a){case"A":f=[[1,-1],[-1,0],[1,1]];break;case"B":f=[[1,-1],[1,1]];break;case"a":f=[[-1,-1],[1,0],[-1,1]];break;case"b":f=[[-1,-1],[-1,1]]}return k(f).forEachApply(function(e,f){var h=[g[0]+e,g[1]+f],i=c.square(h);!c.isValidCoord(h)||i.match(b)||"."!=i&&a.toLowerCase()!=i.toLowerCase()||d.push([g,h])}),a}),d.length>0?e(a,d):null},next:function(a,b,c){h(b,"Haps are not required (given ",b,")!"),h(!a,"Invalid moves ",a,"!");var d=this.activePlayer(),e=a[d];h(!Array.isArray(a[d]),"Invalid moves ",a,"!");var f=this.board.move(e[0],e[1]);return c?(this.activatePlayers(this.opponent()),this.board=f,this):new this.constructor(this.opponent(),f)},"static __SERMAT__":{identifier:"Bahab",serializer:function(a){return[a.activePlayer(),a.board]}}}),s.Puzzle15=i(w,{name:"Puzzle15",players:["Player"],width:4,height:4,target:"0123456789ABCDE ",maxMoves:81,constructor:function(a){w.call(this,this.players[0]),a=a||{},this.board=a.board||this.randomBoard(),this.moveNumber=0|a.moveNumber},randomBoard:function(a,b,c,d){return a=0|a||this.width,b=0|b||this.height,c=c||m.DEFAULT,d=d||j.range(a*b-1).map(function(a){return a.toString(36)}).join("").toUpperCase(),new C(a,b,c.shuffle(" "+d.substr(0,a*b-1)).join("")," ")},differences:function(a){a=a||this.target;var b=this.board.string;return k(b).zip(a).map(function(a){return a[0]===a[1]?0:1}).sum()},scores:function(){return e(this.players[0],this.maxMoves-this.moveNumber)},result:function(){return 0===this.differences()?this.victory():this.moveNumber>=this.maxMoves?this.defeat():null},emptyCoord:function(){var a=this.board.string.indexOf(" "),b=this.board.width;return[a/b|0,a%b]},moves:function(){var a=this.emptyCoord();this.board;return this.result()?null:{Player:k(B.DIRECTIONS.ORTHOGONAL).mapApply(function(b,c){return[a[0]+b,a[1]+c]},this.board.isValidCoord.bind(this.board)).toArray()}},next:function(a,b,c){h(b,"Haps are not required (given ",b,")!");var d=this.board.swap(this.emptyCoord(),a.Player);return c?(this.board=d,this.moveNumber++,this):new this.constructor({board:d,moveNumber:this.moveNumber+1})},"static __SERMAT__":{identifier:"Puzzle15",serializer:function(a){return[{board:a.board,moveNumber:a.moveNumber}]}}}),u.RoundRobin=i(A,{constructor:function(a,b,c){A.call(this,a,b),this.matchCount=isNaN(c)?a.players.length:+c,this.__advance__=this.__matches__().chain(j.repeat(null)).__iter__()},__matches__:function(){var a=this.game;return k(this.players).permutations(a.players.length).product(j.range(this.matchCount)).map(function(b){return new y(a,b[0])})},"static __SERMAT__":{identifier:"RoundRobin",serializer:function(a){return[a.game,a.players,a.matchCount]}}}),u.Measurement=i(A,{constructor:function(a,b,c,d){A.call(this,a,Array.isArray(b)?b:[b]),this.opponents=Array.isArray(c)?c:[c],h(this.opponents.length<a.players.length-1,"Not enough opponents."),this.matchCount=isNaN(d)?a.players.length:+d,this.__advance__=this.__matches__().chain(j.repeat(null)).__iter__()},__matches__:function(){var a=this.game,b=a.players.length,c=k(this.opponents);return c=b>2?c.product.apply(c,j.repeat(this.opponents,b-2).toArray()):c.map(function(a){return[a]}),k(this.players).product(j.range(b),c,j.range(this.matchCount)).map(function(b){var c=b[2].slice(0);return c.splice(b[1],0,b[0]),new y(a,c)})},"static __SERMAT__":{identifier:"Measurement",serializer:function(a){return[a.game,a.players,a.opponents,a.matchCount]}}}),u.Elimination=i(A,{constructor:function(a,b,c){A.call(this,a,b),this.matchCount=isNaN(c)?1:+c>>0},__bracket__:function(a){var b=this.game,c=this.matchCount,d=this.game.players.length;return a=a||this.players,a.length<d?[]:j.range(0,a.length,d).map(function(e){var f=j.range(e,e+d).map(function(b){return a[b%a.length]}).toArray();return j.range(c).map(function(a){return f.unshift(f.pop()),new y(b,f)}).toArray()}).toArray()},__playoff__:function(a){var b={},c={};a.forEach(function(a){var d=a.result();if(!d)throw new Error("Unfinished match in playoff!");k(a.players).forEach(function(a){var e=a[0],f=a[1].name;b[f]=(+b[f]||0)+d[e],c[f]=a[1]})});var d=k(b).greater(function(a){return a[1]})[0][0];return c[d]},__advance__:function(){if(!this.__matches__||this.__matches__.length<1){if(this.__currentBracket__){if(this.__currentBracket__.length<1)return null;var a=this.__currentBracket__.map(this.__playoff__);this.__currentBracket__=this.__bracket__(a)}else this.__currentBracket__=this.__bracket__(this.players);this.__matches__=k(this.__currentBracket__).flatten().toArray()}return this.__matches__.shift()},"static __SERMAT__":{identifier:"Elimination",serializer:function(a){return[a.game,a.players,a.matchCount]}}}),[y,s.Bahab,s.Choose2Win,s.ConnectionGame,s.Mutropas,s.OddsAndEvens,s.Pig,s.Predefined,s.TicTacToe,s.ToadsAndFrogs,s.Puzzle15,x,t.AlphaBetaPlayer,t.MaxNPlayer,t.MiniMaxPlayer,t.MonteCarloPlayer,t.RandomPlayer,t.TracePlayer,t.UCTPlayer,A,u.Elimination,u.Measurement,u.RoundRobin,r.Aleatory,r.DieAleatory,v.CheckerboardFromString].forEach(function(a){a.__SERMAT__.identifier=q.__package__+"."+a.__SERMAT__.identifier,q.__SERMAT__.include.push(a)}),c.include(q),q});
//# sourceMappingURL=ludorum.min.js.map