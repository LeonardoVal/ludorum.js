//! ludorum 0.2.1

(function(t){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat"],t):"object"==typeof exports&&module.exports?module.exports=t(require("creatartis-base"),require("sermat")):this.ludorum=t(this.base,this.Sermat)}).call(this,function t(c,n){"use strict";var i,e=c.objects.unimplemented,_=c.obj,h=c.copy,l=c.raise,f=c.raiseIf,s=c.declare,p=c.Iterable,d=c.iterable,u=c.Future,r=c.Randomness,a=c.initialize,o=c.Statistics,m=c.Events,v={__package__:"ludorum",__name__:"ludorum",__init__:t,__dependencies__:[c,n],__SERMAT__:{include:[c]}},y=v.aleatories={},g=v.games={},b=v.players={},w=v.tournaments={},A=v.utils={},P=v.Game=s({constructor:function(t){this.activatePlayers(t)},name:"?",players:[],moves:e("Game","moves()"),next:e("Game","next(moves, haps, update)"),result:e("Game","result()"),scores:function(){return this.results()},view:function(t){return this},isActive:function(){for(var t=0;t<arguments.length;t++)if(this.activePlayers.indexOf(arguments[t])<0)return!1;return!0},activePlayer:function(){var t=this.activePlayers.length;return f(t<1,"There are no active players!"),f(1<t,"More than one player is active!"),this.activePlayers[0]},activatePlayers:function(t){return this.activePlayers=t?Array.isArray(t)?t:[t]:[this.players[0]]},opponents:function(e){return e=e||this.activePlayers,this.players.filter(function(t){return e.indexOf(t)<0})},opponent:function(t){var e=this.players.indexOf(t||this.activePlayer());return this.players[(e+1)%this.players.length]},perform:function(){for(var t,e={},n=0;n<arguments.length;n+=2)void 0===(t=arguments[n+1])&&(t=this.activePlayer()),e[t]=arguments[n];return this.next(e)},possibleMoves:function(t){if(!(t=arguments.length<1?this.moves():t)||"object"!=typeof t)return[];var e=Object.keys(t);if(1===e.length){var n=e[0];return t[n].map(function(t){return _(n,t)})}return p.product.apply(p,d(t).mapApply(function(e,t){return t.map(function(t){return[e,t]})}).toArray()).map(function(t){return d(t).toObject()}).toArray()},contingent:function(t,e,n){return new M(this,t,e,n)},resultBounds:function(){return[-1,1]},normalizedResult:function(t){var e;if((t=t||this.result())&&"object"==typeof t){for(var n in e=this.resultBounds(),t=c.copy(t))t[n]=(t[n]-e[0])/(e[1]-e[0])*2-1;return t}return"number"==typeof t?(+t-(e=this.resultBounds())[0])/(e[1]-e[0])*2-1:null},zerosumResult:function(e,n){n=n?Array.isArray(n)?n:[n]:this.activePlayers;var i=-(e=+e/(n.length||1))/(this.players.length-n.length||1);return d(this.players).map(function(t){return[t,n.indexOf(t)<0?i:e]}).toObject()},victory:function(t,e){return this.zerosumResult(e||1,t)},defeat:function(t,e){return this.zerosumResult(e||-1,t)},tied:function(t,e){return e=+(e||0),d(t||this.players).map(function(t){return[t,e]}).toObject()},isZeroSum:!0,isDeterministic:!1,isSimultaneous:!1,__hash__:function(){return n.hashCode(this).toString(36)},clone:function(){return n.clone(this)},toString:function(){return n.ser(this)},"static make":function(t){return(t=h({},t)).hasOwnProperty("name")||"function"!=typeof t.constructor||(t.name=t.constructor.name),f("string"!=typeof t.name||!t.name,"A game must have a `name`!"),f(!Array.isArray(t.players),"A game must have `players`!"),s(this,t)},"static cacheProperties":function(){var i=this;return Array.prototype.slice.call(arguments).forEach(function(t){var e="__"+t+"$cache__",n=i.prototype[t];i.prototype[t]=function(){return 0<arguments.length?n.apply(this,arguments):(this.hasOwnProperty(e)||(this[e]=n.call(this)),this[e])}}),i},"static serialized":function(t){var r=t.prototype.moves,i=t.prototype.next;return s(t,{moves:function(){for(var t,e=this.__fixedMoves__||(this.__fixedMoves__={}),n=r.call(this),i=0;i<this.activePlayers.length;i++)if(e.hasOwnProperty(this.activePlayers[i])){t=this.activePlayers[i];break}return t&&n?_(t,n[t]):null},next:function(t){var e,n=h({},this.fixedMoves||{},t);return d(this.players).all(function(t){return n.hasOwnProperty(t)})?(e=i.call(this,n)).fixedMoves={}:(e=this.clone()).fixedMoves=n,e}})}}),E=v.Player=s({constructor:(i=0,function(t){var e=Object.getPrototypeOf(this);a(this,t).string("name",{defaultValue:"Player"+i++,coerce:!0}).object("random",{defaultValue:e.random})}),random:r.DEFAULT,decision:function(t,e){return this.movesFor(t,e)[0]},movesFor:function(t,e){var n=t.moves();return f(!n||!n[e]||n[e].length<1,"Player ",e," has no moves for game ",t,"."),n[e]},isCompatibleWith:function(t){return!0},participate:function(t,e){return this},"static make":function(t){return s(this,t)},"dual playTo":function(t){var e=this,n=t.players.map(function(t){return"function"==typeof e?new e:e});return new x(t,n)},"static __SERMAT__":{identifier:"Player",serializer:function(t){return[{name:t.name}]}},toString:function(){return n.ser(this)}}),x=v.Match=s({constructor:function(t,e){for(var n in this.game=t,this.players=Array.isArray(e)?d(t.players).zip(e).toObject():e,this.history=[{state:t}],this.events=new m({events:["begin","next","end","quit"]}),this.players)this.players[n]=this.players[n].participate(this,n)||this.players[n]},ply:function(){return this.history.length-1},state:function(t){return t=isNaN(t)?this.ply():+t<0?this.ply()+ +t:+t,this.history[0|t].state},result:function(){return this.state().result()},decisions:function(e){e=e||this.state();var n=this.players,i=e.activePlayers;return u.all(i.map(function(t){return n[t].decision(e.view(t),t)})).then(function(t){return d(i).zip(t).toObject()})},run:function(e){if((e=isNaN(e)?1/0:+e)<1)return u.when(this);var t,n=this.ply(),i=this.state();if(n<1&&this.onBegin(i),t=(i=this.__advanceContingents__(i)).result())return this.onEnd(i,t),u.when(this);var r=this;return this.decisions(i).then(function(t){return r.__advance__(i,t)?r.run(e-1):r})},__advanceContingents__:function(t){for(var e,n;t.isContingent;)e=t.randomHaps(),this.history[this.history.length-1].haps=e,n=t.next(e),this.history.push({state:n}),this.onNext(t,null,e,n),t=n;return t},__advance__:function(t,n){var i=this;if(!d(t.activePlayers).all(function(t){var e=n[t];return"function"!=typeof e.__command__||e.__command__(i,t)}))return!1;var e=t.next(n);return this.history[this.history.length-1].moves=n,this.history.push({state:e}),this.onNext(t,n,null,e),!0},"static commands":{Quit:s({__command__:function(t,e){return t.onQuit(t.state(),e),!1}})},onBegin:function(t){this.events.emit("begin",t,this),this.logger&&this.logger.info("Match begins with ",d(this.players).map(function(t){return t[1]+" as "+t[0]}).join(", "),"; for ",t,".")},onNext:function(t,e,n,i){this.events.emit("next",t,e,n,i,this),this.logger&&this.logger.info("Match advances from ",t," to ",i)},onEnd:function(t,e){this.events.emit("end",t,e,this),this.logger&&this.logger.info("Match for ",t,"ends with ",JSON.stringify(e))},onQuit:function(t,e){this.events.emit("quit",t,e,this),this.logger&&this.logger.info("Match for ",t," aborted because player "+e+" quitted.")},"static randomMatch":function(t,e){e=e||{};var n=b.RandomPlayer.playTo(t);return e.log&&("object"==typeof e.log?n.logger=e.log:(n.logger=new c.Logger("string"==typeof e.log?e.log:"Match"),n.logger.appendToConsole())),n},toString:function(){return n.ser(this)},"static __SERMAT__":{identifier:"Match",serializer:function(t){return[t.game,t.players,t.history]},materializer:function(t,e){if(e){var n=new x(e[0],e[1]);return n.history=e[2],n}return null}}}),M=v.Contingent=s({isContingent:!0,constructor:function(t,e,n,i){this.state=t,this.moves=e,this.haps=n,this.update=!!i},next:function(t){return this.state.next(this.moves,t||this.randomHaps(),this.update)},randomHaps:function(n){return d(this.haps).mapApply(function(t,e){return[t,e.randomValue(n)]}).toObject()},randomNext:function(t){return this.next(this.randomHaps(t))},possibleHaps:function(){return p.product.apply(p,d(this.haps).mapApply(function(n,t){return t.distribution().mapApply(function(t,e){return[n,t,e]})}).toArray()).map(function(t){var i=1;return[d(t).mapApply(function(t,e,n){return i*=n,[t,e]}).toObject(),i]}).toArray()},expectedEvaluation:function(i,r,s){var a=this,o=!1,t=this.possibleHaps().map(function(e){var t=a.next(e[0]),n=t.isContingent?t.expectedEvaluation(i,r,s):r(t,i);return o=o||u.__isFuture__(n),u.then(n,function(t){return e.push(t),e})});return u.then(o?u.all(t):t,s||function(t){var e=0;return t.forEach(function(t){e+=t[1]*t[2]}),e})},toString:function(){return n.ser(this)},"static __SERMAT__":{identifier:"Contingent",serializer:function(t){return[t.state,t.moves,t.haps]}}}),N=v.Tournament=s({constructor:function(t,e){this.game=t,this.players=Array.isArray(e)?e:iterables.iterable(e).toArray(),this.statistics=new o,this.events=new m({events:["begin","beforeMatch","afterMatch","end"]})},__advance__:e("Tournament","__advance__"),run:function(){this.onBegin();var e=this;return u.doWhile(function(){return u.then(e.__advance__(),function(t){return t?(e.beforeMatch(t),e.__runMatch__(t).then(function(t){return e.account(t),e.afterMatch(t),t})):null})}).then(this.onEnd.bind(this))},__runMatch__:function(t){return t.run()},account:function(n){var s=this.game,a=n.result(),o=this.statistics;f(!a,"Match doesn't have results. Has it finished?"),d(n.players).forEach(function(t){var i=t[0],r=t[1],e=a[t[0]];o.add({key:"results",game:s.name,role:i,player:r.name},e),o.add({key:0<e?"victories":e<0?"defeats":"draws",game:s.name,role:i,player:r.name},e),o.add({key:"length",game:s.name,role:i,player:r.name},n.ply()),n.history.forEach(function(t){var e=t.state;if("function"==typeof e){var n=e.moves();n&&n.hasOwnProperty(i)&&0<n[i].length&&o.add({key:"width",game:e.name,role:i,player:r.name},n[i].length)}})})},onBegin:function(){this.events.emit("begin",this),this.logger&&this.logger.info("Tournament begins for game ",game.name,".")},beforeMatch:function(t){this.events.emit("beforeMatch",t,this),this.logger&&this.logger.debug("Beginning match with ",JSON.stringify(t.players),".")},afterMatch:function(t){this.events.emit("afterMatch",t,this),this.logger&&this.logger.debug("Finishing match with ",JSON.stringify(t.players),".")},onEnd:function(){this.events.emit("end",this.statistics,this),this.logger&&this.logger.info("Tournament ends for game ",game.name,":\n",this.statistics,"\n")},toString:function(){return n.ser(this)},"static __SERMAT__":{identifier:"Tournament",serializer:function(t){return[t.game,t.players]}}}),S=A.Checkerboard=s({constructor:function(t,e){isNaN(t)||(this.height=0|t),isNaN(e)||(this.width=0|e)},emptySquare:null,isValidCoord:function(t){return Array.isArray(t)&&!isNaN(t[0])&&!isNaN(t[1])&&0<=t[0]&&t[0]<this.height&&0<=t[1]&&t[1]<this.width},coordinates:function(){return p.range(this.height).product(p.range(this.width))},square:e("utils.Checkerboard","square"),isEmptySquare:function(t){return this.square(t)===this.emptySquare},horizontals:function(){var t=this.width;return p.range(this.height).map(function(e){return p.range(t).map(function(t){return[e,t]})})},verticals:function(){var t=this.height;return p.range(this.width).map(function(e){return p.range(t).map(function(t){return[t,e]})})},orthogonals:function(){return this.horizontals().chain(this.verticals())},positiveDiagonals:function(){var t=this.width,i=this.height,r=i+t-1;return p.range(r).map(function(t){var e=Math.max(0,i-t-1),n=Math.max(0,t-i+1);return p.range(Math.min(t+1,r-t)).map(function(t){return[e+t,n+t]})})},negativeDiagonals:function(){var t=this.width,i=this.height,r=i+t-1;return p.range(r).map(function(t){var e=Math.min(t,i-1),n=Math.max(0,t-i+1);return p.range(Math.min(t+1,r-t)).map(function(t){return[e-t,n+t]})})},diagonals:function(){return this.positiveDiagonals().chain(this.negativeDiagonals())},lines:function(){return this.orthogonals().chain(this.diagonals())},sublines:function(t,n){return d(t).map(function(t){return Array.isArray(t)?t:d(t).toArray()},function(t){return t.length>=n}).map(function(e){return p.range(0,e.length-n+1).map(function(t){return e.slice(t,t+n)})}).flatten()},walk:function(t,n){var i=this;return new p(function(){var e=t.slice();return function(){if(i.isValidCoord(e)){var t=e.slice();return e[0]+=n[0],e[1]+=n[1],t}throw p.STOP_ITERATION}})},walks:function(e,t){var n=this;return t.map(function(t){return n.walk(e,t)})},"static DIRECTIONS":{HORIZONTAL:[[0,-1],[0,1]],VERTICAL:[[-1,0],[1,0]],ORTHOGONAL:[[0,-1],[0,1],[-1,0],[1,0]],DIAGONAL:[[-1,-1],[-1,1],[1,-1],[1,1]],EVERY:[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[-1,1],[1,-1],[1,1]]},clone:e("utils.Checkerboard","clone"),__place__:e("utils.Checkerboard","place"),place:function(t,e){return this.clone().__place__(t,e)},__move__:function(t,e,n){return this.__place__(e,this.square(t)).__place__(t,void 0===n?this.emptySquare:n)},move:function(t,e,n){return this.clone().__move__(t,e,n)},__swap__:function(t,e){var n=this.square(e);return this.__place__(e,this.square(t)).__place__(t,n)},swap:function(t,e){return this.clone().__swap__(t,e)},transform:function(n){var i=this.clone(),r=this;return this.coordinates().forEach(function(t){var e=n.apply(r,[r,t].concat(t));i.__place__(e,r.square(t))}),i},horizontalSymmetry:function(){return this.transform(function(t,e,n,i){return[n,t.width-i-1]})},verticalSymmetry:function(){return this.transform(function(t,e,n,i){return[t.height-n-1,i]})},clockwiseRotation:function(){return this.transform(function(t,e,n,i){return[i,t.height-n-1]})},counterClockwiseRotation:function(){return this.transform(function(t,e,n,i){return[t.width-i-1,n]})},renderAsHTMLTable:function(s,t,a){var o=this,e=s.createElement("table");return t.appendChild(e),o.horizontals().reverse().forEach(function(t){var r=s.createElement("tr");e.appendChild(r),t.forEach(function(t){var e=o.square(t),n=s.createElement("td"),i={id:"ludorum-square-"+t.join("-"),className:"ludorum-square",square:e,coord:t,innerHTML:c.Text.escapeXML(e)};a&&(i=a(i)||i),n["ludorum-data"]=i,n.id=i.id,n.className=i.className,n.innerHTML=i.innerHTML,i.onclick&&(n.onclick=i.onclick),r.appendChild(n)})}),e},weightedSum:function(t,n){var i=this;return this.coordinates().zip(t).mapApply(function(t,e){return n[i.square(t)]*e||0}).sum()}}),T=A.CheckerboardFromString=s(S,{constructor:function(t,e,n,i){if(S.call(this,t,e),i&&i!==this.emptySquare&&(this.emptySquare=(i+"").charAt(0)),n&&n.length!==t*e)throw new Error("Given string "+JSON.stringify(n)+" does not match board dimensions.");this.string=n||this.emptySquare.repeat(t*e)},emptySquare:".",toString:function(){var e=this.string,n=this.height,i=this.width;return p.range(n).map(function(t){return e.substr((n-t-1)*i,i)}).join("\n")},square:function(t,e){var n=t[0],i=t[1],r=this.width;return 0<=n&&n<this.height&&0<=i&&i<r?this.string.charAt(n*r+i):e},asString:function(t){var e=this;return t.map(function(t){return e.square(t)}).join("")},asStrings:function(t){var e=this;return t.map(function(t){return e.asString(t)})},asRegExp:function(t,e,n){n=n||".";var i=this.width,r=p.repeat(!1,i*this.height).toArray();t.forEach(function(t){r[t[0]*i+t[1]]=!0});for(var s,a="",o=0,u=0;u<r.length;o=0){for(s=r[u];++o,++u<r.length&&r[u]===s;);a+=o<2?s?e:n:(s?e:n)+"{"+o+"}"}return a},asRegExps:function(t,e,n){var i=this;return t.map(function(t){return i.asRegExp(t,e,n)}).join("|")},clone:function(){return new this.constructor(this.height,this.width,this.string,this.hasOwnProperty("emptySquare")?this.emptySquare:void 0)},__place__:function(t,e){f(!this.isValidCoord(t),"Invalid coordinate ",t,"."),e=(e+this.emptySquare).charAt(0);var n=t[0]*this.width+t[1];return this.string=this.string.substr(0,n)+e+this.string.substr(n+1),this},"static __SERMAT__":{identifier:"CheckerboardFromString",serializer:function(t){var e=[t.height,t.width,t.string];return t.hasOwnProperty("emptySquare")&&e.push(t.emptySquare),e}}});A.CheckerboardFromPieces=s(S,{constructor:function(t,e,n,i){S.call(this,t,e);var r=this;i!==this.emptySquare&&(this.emptySquare=i),Array.isArray(n)?(this.pieces={},d(n||[]).forEach(function(t){f(!Array.isArray(t.position),"Piece has not a position (",t,")!"),r.pieces[t.position+""]=t})):"object"==typeof n?this.pieces=c.copy({},n):l("Invalid pieces definition: ",n,"!")},emptySquare:null,toString:function(){return"["+d(this.pieces).select(1).join(", ")+"]"},square:function(t,e){return this.pieces[t]||e},clone:function(){return new this.constructor(this.height,this.width,this.pieces,this.emptySquare)},__place__:function(t,e){f(!this.isValidCoord(t),"Invalid coordinate ",t,"!");var n=t+"";return delete this.pieces[n],e&&(this.pieces[n]=e),this},"static __SERMAT__":{identifier:"CheckerboardFromPieces",serializer:function(t){var e=[t.height,t.width,t.pieces];return t.hasOwnProperty("emptySquare")&&e.push(t.emptySquare),e}}});v.utils.Scanner=s({constructor:function(t){a(this,t).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:r.DEFAULT}).object("statistics",{defaultValue:new o})},scan:function(e){var n=this,i=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),r=0;return u.whileDo(function(){return 0<i.length&&r<n.maxLength},function(){return u.all(i.map(function(t){return n.__advance__(e,t,r)})).then(function(t){return i=d(t).flatten().sample(n.maxWidth,n.random).toArray(),++r})}).then(function(){return n.statistics.add({key:"aborted"},i.length),n.statistics})},scans:function(){return u.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(i,r,t){if(r instanceof I)return d(r.distribution()).mapApply(function(t,e){return r.next(t)});if(this.account(i,r,t))return p.EMPTY;var s=r.moves(),a=this.statistics;return u.all(r.activePlayers.map(function(e){if(i&&i[e]){var t=i[e],n=a.stat({key:"decision.time",game:r.name,role:e,player:t.name});return n.startTime(),u.when(t.decision(r,e)).then(function(t){return n.addTime(),[[e,t]]})}return s[e].map(function(t){return[e,t]})})).then(function(t){return p.product.apply(p,t).map(function(t){return r.next(d(t).toObject())})})},account:function(i,r,s){var a=r.result(),o=this.statistics;if(a)return d(r.players).forEach(function(t){var e=a[t],n=i&&i[t]?i[t].name:"";r.name;o.add({key:"game.result",game:r.name,role:t,player:n},e,r),o.add({key:"game.length",game:r.name,role:t,player:n},s,r),e<0?(o.add({key:"defeat.result",game:r.name,role:t,player:n},e,r),o.add({key:"defeat.length",game:r.name,role:t,player:n},s,r)):0<e?(o.add({key:"victory.result",game:r.name,role:t,player:n},e,r),o.add({key:"victory.length",game:r.name,role:t,player:n},s,r)):o.add({key:"draw.length",game:r.name,role:t,player:n},s,r)}),!0;var e=r.moves();return d(r.activePlayers).forEach(function(t){o.add({key:"game.width",game:r.name,role:t},e[t].length)}),!1}}),A.Cache=s({constructor:function(t){this.clear(),t&&this.root(t)},stateIdentifier:function(t){return t.identifier()},moveIdentifier:function(t){return JSON.stringify(t)},has:function(t){var e="string"==typeof t?t:this.stateIdentifier(t);return this.__entries__.hasOwnProperty(e)},get:function(t){var e="string"==typeof t?t:this.stateIdentifier(t);return this.__entries__[e]},size:function(){return Object.keys(this.__entries__).length},entry:function(t,e){if(e=e||this.stateIdentifier(t),this.has(e))return this.get(e);var n={id:e,state:t,precursors:[],descendants:{}};return this.__entries__[e]=n},descendant:function(t,e){var n=this.moveIdentifier(e),i=t.descendants;if(i.hasOwnProperty(n))return i[n][1];var r=t.state.next(e),s=this.stateIdentifier(r),a=this.get(s)||this.entry(r,s);return i[n]=[e,a],a.precursors.push([e,t]),a},descendants:function(t){var e=this.descendant.bind(this,t);return 1<arguments.length?Array.prototype.slice.call(arguments,1).map(e):t.state.possibleMoves().map(e)},clear:function(){this.__entries__={},this.__root__=null},root:function(t){if(0<arguments.length){var e=this.stateIdentifier(t);this.__root__=this.get(e)||this.entry(t,e),this.prune(e)}return this.__root__},prune:function(t){for(var e,n=[t||this.__root__.id],i={};t=n.shift();)i.hasOwnProperty(t)||(e=this.get(t),i[t]=e,n.push.apply(n,d(e.descendants).mapApply(function(t,e){return e[1][t]}).toArray()));return this.__entries__=i}});var C=A.GameTree=s({constructor:function(t){this.parent=t&&t.parent,this.state=t&&t.state,this.transition=t&&t.transition,this.probability=t&&+t.probability,this.children=t&&t.children,this.state&&!this.children&&(this.children=this.possibleTransitions())},possibleTransitions:function(){var t=this.state,e=this.constructor,n=this;return f(!t,"GameTree node has no state!"),t.isContingent?t.possibleHaps().map(function(t){return new e({parent:n,transition:t[0],probability:t[1]})}):t.possibleMoves().map(function(t){return new e({parent:n,transition:t})})},childrenCount:function(){return this.children||(this.children=this.possibleTransitions()),this.children.length},__expandChild__:function(e){if(!e.state)try{e.state=e.parent.state.next(e.transition)}catch(t){l("Node expansion for ",e.parent.state," with ",JSON.stringify(e.transition)," failed with: ",t)}return e},expand:function(t){return f(t<0||t>=this.childrenCount(),"Cannot expand children ",t,"!"),this.__expandChild__(this.children[t])},expandRandom:function(t){return t=t||r.DEFAULT,this.expand(t.randomInt(this.childrenCount()))},expandAll:function(){for(var t=0,e=this.childrenCount;t<e;t++)this.__expandChild__(this.children[t]);return this.children},toString:function(){return"GameTree("+this.state+")"},"static __SERMAT__":{identifier:"GameTree",serializer:function(t){return[{parent:t.parent,state:t.state,transition:t.transition,probability:t.probability,children:t.children}]}}});b.RandomPlayer=s(E,{constructor:function(t){E.call(this,t);var e=Object.getPrototypeOf(this);a(this,t).object("random",{defaultValue:e.random})},random:r.DEFAULT,decision:function(t,e){return f(t.isContingent,"Contingent game state has no moves!"),this.random.choice(this.movesFor(t,e))},"static __SERMAT__":{identifier:"RandomPlayer",serializer:function(t){return this.serializeAsProperties(t,["name","random"])}}}),b.TracePlayer=s(E,{constructor:function(t){E.call(this,t),this.trace=d(t.trace),this.__iter__=this.trace.__iter__(),this.__decision__=this.__iter__()},decision:function(t,e){try{this.__decision__=this.__iter__()}catch(t){p.prototype.catchStop(t)}return this.__decision__},"static __SERMAT__":{identifier:"TracePlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t);return e[0].trace=t.trace.toArray(),e}}});var O=b.HeuristicPlayer=s(E,{constructor:function(t){E.call(this,t);Object.getPrototypeOf(this);a(this,t).func("heuristic",{ignore:!0})},moveEvaluation:function(t,e,n){var i=this;if(Object.keys(t).length<2)return this.stateEvaluation(e.next(t),n);var r=0,s=0;return t=h(_(n,[t[n]]),t),e.possibleMoves(t).forEach(function(t){r+=i.stateEvaluation(e.next(t),n),++s}),0<s?r/s:0},stateEvaluation:function(t,e){if(t.isContingent)return t.expectedEvaluation(e,this.stateEvaluation.bind(this));var n=t.result();return n?n[e]:this.heuristic(t,e)},heuristic:function(t,e){return this.random.random(-.5,.5)},evaluatedMoves:function(n,i){var r=this,s=!1;f(n.isContingent,"Contingent game state has no moves!");var t=this.possibleMoves(n,i).map(function(e){var t=r.moveEvaluation(e,n,i);return s=s||u.__isFuture__(t),u.then(t,function(t){return[e,t]})});return s?u.all(t):t},possibleMoves:function(t,e){var n=t.moves();return f(!n||!n[e]||!Array.isArray(n[e])||n[e].length<1,"Player "+e+" has no moves in "+t+" (moves= "+n+")!"),n[e].map(function(t){return h(_(e,t),n)})},bestMoves:function(t){return u.then(t,function(t){return d(t).greater(function(t){return t[1]}).map(function(t){return t[0]})})},decision:function(e,n){var i=this.random;return u.then(this.bestMoves(this.evaluatedMoves(e,n)),function(t){return f(!t||!t.length,"No moves where selected at ",e," for player ",n,"!"),i.choice(t)[n]})},"static composite":function(){var r=Array.prototype.slice.call(arguments);f(r.length<1,"HeuristicPlayer.composite() cannot take an odd number of arguments!");for(var t=0;t<r.length;t+=2)f("function"!=typeof r[t],"HeuristicPlayer.composite() argument ",t," (",r[t],") is not a function!"),r[t+1]=+r[t+1],f(isNaN(r[t+1])||r[t+1]<0||1<r[t+1],"HeuristicPlayer.composite() argument ",t+1," (",r[t+1],") is not a valid weight!");return function(t,e){for(var n=0,i=0;i+1<r.length;i+=2)n+=r[i](t,e)*r[i+1];return n}},"static __SERMAT__":{identifier:"HeuristicPlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t),n=e[0];return t.hasOwnProperty("heuristic")&&(n.heuristic=t.heuristic),e}}}),R=(b.MaxNPlayer=s(O,{constructor:function(t){O.call(this,t);var e=Object.getPrototypeOf(this);a(this,t).integer("horizon",{defaultValue:e.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(t){return!t.isSimultaneous&&t.isDeterministic},stateEvaluation:function(t,e){if(!t.isContingent)return this.maxN(t,e,0)[e];l("MaxNPlayer.stateEvalution() does not support contingent game states!")},heuristics:function(e){var n={},i=this;return e.players.forEach(function(t){n[t]=i.heuristic(e,t)}),n},quiescence:function(t,e,n){var i=t.result();return i||(n>=this.horizon?this.heuristics(t):null)},maxN:function(t,e,n){var i=this.quiescence(t,e,n);if(!i){var r,s,a=t.activePlayer(),o=this.movesFor(t,a);if(i={},o.length<1)throw new Error("No moves for unfinished game "+t+".");for(var u=0;u<o.length;++u)s=t.next(_(a,o[u])),(r=this.maxN(s,e,n+1))[a]>(i[a]||-1/0)&&(i=r)}return i},"static __SERMAT__":{identifier:"MaxNPlayer",serializer:function(t){var e=O.__SERMAT__.serializer(t);return e[0].horizon=t.horizon,e}}}),b.MiniMaxPlayer=s(O,{constructor:function(t){O.call(this,t);var e=Object.getPrototypeOf(this);a(this,t).integer("horizon",{defaultValue:e.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(t){return!t.isSimultaneous},stateEvaluation:function(t,e,n){return this.minimax(t,e,0,n)},quiescence:function(t,e,n){var i=t.result();return i?i[e]:n>=this.horizon?this.heuristic(t,e):NaN},minimax:function(t,e,n,i){if(t.isContingent)return this.expectiMinimax(t,e,n,i);var r=this.quiescence(t,e,n);if(isNaN(r)){var s,a,o=t.activePlayer(),u=this.movesFor(t,o);if(u.length<1)throw new Error("No moves for unfinished game "+t+".");o==e?(r=-1/0,s=Math.max):(r=1/0,s=Math.min);for(var c=0;c<u.length;++c)a=t.next(_(o,u[c])),r=s(r,this.minimax(a,e,n+1,i))}if(i&&"function"==typeof i.hook){var h=i.hook(t,r);isNaN(h)||(r=h)}return r},expectiMinimax:function(t,e,n,i){if(t.isContingent){var r=this;return t.expectedEvaluation(e,function(t,e){return r.minimax(t,e,n+1,i)})}return this.minimax(t,e,n,i)},"static solution":function(t,e){var i=e&&e.evals||{},n=new this({horizon:1e8}),r=e.gameKey||function(t){return t.toString()};return n.minimax(t,t.activePlayer(),0,{hook:function(t,e){var n=r(t);f(i.hasOwnProperty(n)&&i[n]!==e,"Game ",t,"(key ",n,") has different values ",i[n]," and ",e,"!"),i[n]=e}}),i},"static __SERMAT__":{identifier:"MiniMaxPlayer",serializer:function(t){var e=O.__SERMAT__.serializer(t);return e[0].horizon=t.horizon,e}}}));b.AlphaBetaPlayer=s(R,{constructor:function(t){R.call(this,t)},stateEvaluation:function(t,e){return this.minimax(t,e,0,-1/0,1/0)},minimax:function(t,e,n,i,r){if(t.isContingent)return this.expectiMinimax(t,e,n,i,r);var s=this.quiescence(t,e,n);if(!isNaN(s))return s;var a,o=t.activePlayer(),u=o==e,c=this.movesFor(t,o);c.length<1&&l("No moves for unfinished game "+t+"!");for(var h=0;h<c.length&&(a=t.next(_(o,c[h])),s=this.minimax(a,e,n+1,i,r),u?i<s&&(i=s):s<r&&(r=s),!(r<=i));h++);return u?i:r},expectiMinimax:function(t,e,n,i,r){if(t.isContingent){var s=this;return t.expectedEvaluation(e,function(t,e){return s.minimax(t,e,n+1,i,r)})}return this.minimax(t,e,n)},"static __SERMAT__":{identifier:"AlphaBetaPlayer",serializer:function(t){return R.__SERMAT__.serializer(t)}}});var z=b.MonteCarloPlayer=s(O,{constructor:function(t){O.call(this,t);var e=Object.getPrototypeOf(this);if(a(this,t).number("simulationCount",{defaultValue:e.simulationCount,coerce:!0}).number("timeCap",{defaultValue:e.timeCap,coerce:!0}).number("horizon",{defaultValue:e.horizon,coerce:!0}),t)switch(typeof t.agent){case"function":this.agent=new O({heuristic:t.agent});break;case"object":this.agent=t.agent;break;default:this.agent=null}},simulationCount:30,timeCap:1e3,horizon:500,evaluatedMoves:function(e,i){f(e.isContingent,"MonteCarloPlayer cannot evaluate root contingent states!");for(var r=this,t=Date.now(),n=this.possibleMoves(e,i).map(function(t){return{move:t,nexts:Object.keys(t).length<2?[e.next(t)]:e.possibleMoves(h(_(i,[t[i]]),t)).map(function(t){return e.next(t)}),sum:0,count:0}}),s=0;!this.__finishMoveEvaluation__(s,t,n);)n.forEach(function(n){n.nexts=n.nexts.filter(function(t){var e=r.simulation(t,i);return n.sum+=e.result,++n.count,0<e.plies}),s++});return n.map(function(t){return f(isNaN(t.sum),"State evaluation is NaN for move ",t.move,"!"),[t.move,0<t.count?t.sum/t.count:0,t.count]})},__finishMoveEvaluation__:function(t,e,n){return t>this.simulationCount||e+this.timeCap<Date.now()},stateEvaluation:function(t,e){for(var n,i=0,r=this.simulationCount,s=0;s<r&&(i+=(n=this.simulation(t,e)).result[e],!(n.plies<1));++s);return 0<r?i/r:0},quiescence:function(t,e,n){var i=t.result();return i?i[e]:n>=this.horizon?this.heuristic(t,e):NaN},simulation:function(e,t){var n,i,r,s=this,a={game:e};for(n=0;;++n)if(e.isContingent)e=e.randomNext(this.random);else{r=e.moves();var o=this.quiescence(e,t,n+1);if(!isNaN(o))return a.result=o,a.plies=n,a;i={},e.activePlayers.forEach(function(t){i[t]=s.agent?s.agent.decision(e,t):s.random.choice(r[t])}),e=e.next(i,null,0<n)}l("Simulation ended unexpectedly for player ",t," in game ",e,"!")},"static __SERMAT__":{identifier:"MonteCarloPlayer",serializer:function(t){var e=O.__SERMAT__.serializer(t),n=e[0];return n.simulationCount=t.simulationCount,n.timeCap=t.timeCap,n.horizon=t.horizon,t.agent&&(n.agent=t.agent),e}}});b.UCTPlayer=s(z,{constructor:function(t){z.call(this,t);var e=Object.getPrototypeOf(this);a(this,t).number("explorationConstant",{defaultValue:e.explorationConstant,coerce:!0})},explorationConstant:Math.sqrt(2),selectNode:function(t,e,n){return n=isNaN(n)?this.explorationConstant:+n,this.random.choice(d(t.children).greater(function(t){return(t.uct.rewards+t.uct.visits)/t.uct.visits/2+n*Math.sqrt(Math.log(e)/t.uct.visits)}))},evaluatedMoves:function(t,e){var n,i,r=new C({state:t}),s=Date.now();r.uct={pending:r.childrenCount(),visits:0,rewards:0};for(var a=0;!this.__finishMoveEvaluation__(a,s,r);a++){for(n=r;n.uct.pending<1&&0<n.childrenCount();)n=this.selectNode(n,a+1,this.explorationConstant);for(0<n.uct.pending&&((n=n.expandRandom(this.random)).uct={pending:r.childrenCount(),visits:0,rewards:0}),i=this.simulation(n.state,e);n;n=n.parent)++n.uct.visits,n.uct.rewards+=t.normalizedResult(i.result)}return d(r.children).map(function(t){return t.uct?[t.transition,t.uct.rewards/t.uct.visits,t.uct.visits]:[t.transition,0,0]}).toArray()},"static __SERMAT__":{identifier:"UCTPlayer",serializer:function(t){var e=z.__SERMAT__.serializer(t);return e[0].explorationConstant=t.explorationConstant,e}}}),b.RuleBasedPlayer=s(E,{constructor:function(t){E.call(this,t),a(this,t).array("rules",{defaultValue:[]}).func("features",{ignore:!0})},features:function(t,e){return[t,e]},decision:function(t,e){for(var n=null,i=this.features(t,e),r=this.movesFor(t,e),s=0,a=this.rules.length;s<a;s++)if(null!==(n=this.rules[s].call(this,i))&&0<=r.indexOf(n))return n;return this.random.choice(r)},rule:function(t){return f("function"!=typeof t,"A rule must be in the form of a function!"),this.rules.push(t),this},"static regExpRule":function(e,n){return function(t){return e.test(t)?n:null}},regExpRule:function(t,e){return this.rule(this.constructor.regExpRule(t,e))},"static __SERMAT__":{identifier:"RuleBasedPlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t),n=e[0];return n.rules=t.rules,t.hasOwnProperty("features")&&(n.features=t.features),e}}}),b.EnsemblePlayer=s(E,{constructor:function(t){E.call(this,t),a(this,t).array("players",{ignore:!0})},players:[],playerSelection:function(t,e){return this.players},decision:function(t,e){return this.randomDecision(t,e)},randomDecision:function(t,e,n){return n=n||this.playerSelection(t,e),f(n.length<1,"No player was selected!"),(1==n.length?n[0]:this.random.choice(n)).decision(t,e)},heuristicCombination:function(){function t(t,e,n,i){return d(e).sum()/e.length}return function(a){return a=a||t,function(n,i,t){t=t||this.playerSelection(n,i);var r=!1,e=this,s=t.map(function(t){f(!t.evaluatedMoves,"Cannot call `evaluatedMoves()` on player ",t.name,"(",t.constructor.name,")!");var e=t.evaluatedMoves(n,i);return r=r||u.__isFuture__(e),e});return r?u.all(s).then(function(t){return e.__bestAggregatedEvaluationMove__(n,i,a,t)}):e.__bestAggregatedEvaluationMove__(n,i,a,s)}}}(),__aggregateEvaluatedMoves__:function(n,i,r,t){var e=d(t).flatten().groupAll(function(t){return JSON.stringify(t[0])},function(t,e){return t?(t[1].push(e[1]),t):[e[0],[e[1]]]});return d(e).mapApply(function(t,e){return[e[0],r(e[0],e[1],n,i)]})},__bestAggregatedEvaluationMove__:function(t,e,n,i){var r=this.__aggregateEvaluatedMoves__(t,e,n,i);f(r.isEmpty(),"There are no evaluated moves for ",e," to choose from in ",t,"!");var s=O.prototype.bestMoves(r);return this.random.choice(s)[e]},"static parallelizeHeuristicPlayer":function(t,e){t=t||navigator.hardwareConcurrency;var n=c.Iterable.range(t).map(function(){return ludorum.players.WebWorkerPlayer.create(e)}),i=this;return c.Future.all(n.toArray()).then(function(t){var e=new i({players:t});return e.decision=e.heuristicCombination(),e})},"static __SERMAT__":{identifier:"EnsemblePlayer",serializer:function(t){return this.serializeAsProperties(t,["name","random","players"])}}});var k=b.UserInterfacePlayer=s(E,{constructor:function(t){E.call(this,t)},participate:function(t,e){return this.role=e,this},decision:function(t,e){return this.__future__&&this.__future__.isPending()&&this.__future__.resolve(new x.commands.Quit),this.__future__=new u,this.__future__},perform:function(t){var e=this.__future__;return e&&(this.__future__=null,e.resolve(t)),!!e}}),q=b.UserInterface=s({constructor:function(t){this.onBegin=this.onBegin.bind(this),this.onNext=this.onNext.bind(this),this.onEnd=this.onEnd.bind(this),t.match&&this.show(t.match)},show:function(t){this.match&&(t.events.off("begin",this.onBegin),t.events.off("next",this.onNext),t.events.off("end",this.onEnd)),(this.match=t).events.on("begin",this.onBegin),t.events.on("next",this.onNext),t.events.on("end",this.onEnd)},onBegin:function(t){this.display(t)},onNext:function(t,e,n,i){this.display(i)},onEnd:function(t,e){this.results=e,this.display(t)},display:e("UserInterface","display"),perform:function(n,i){d(this.match.players).forEach(function(t){t[0];var e=t[1];e instanceof k&&(!i||e.role===i)&&e.perform(n)})}});q.BasicHTMLInterface=s(q,{constructor:function(t){q.call(this,t),this.document=t.document||c.global.document,this.container=t.container,"string"==typeof this.container&&(this.container=this.document.getElementById(this.container))},display:function(t){for(var e,n=this.container;e=n.firstChild;)n.removeChild(e);t.display(this)},build:function(r,t){var s=this;return t.forEach(function(t){var e;if(Array.isArray(t)){if(e=s.document.createElement(t[0]),2<t.length&&t[1]){var n=t[1];for(var i in n)attr.hasOwnProperty(i)&&e.setAttribute(i,n[i])}1<t.length&&t[t.length-1]&&s.build(e,t[t.length-1])}else"string"==typeof t&&(e=s.document.createTextNode(t));e&&r&&r.appendChild(e)}),r}});b.WebWorkerPlayer=s(E,{constructor:function(t){E.call(this,t),a(this,t).object("worker"),this.worker.onmessage=c.Parallel.prototype.__onmessage__.bind(this)},"static createWorker":function(t){f("string function".indexOf(typeof t.playerBuilder)<0,"Invalid player builder: "+t.playerBuilder+"!"),f(t.workerSetup&&"string function".indexOf(typeof t.workerSetup)<0,"Invalid worker setup: "+t.workerSetup+"!");var e=new c.Parallel,n=[v].concat(t.dependencies||[]);return u.sequence(n,function(t){return e.loadModule(t,!0)}).then(function(){return e.run((t.workerSetup?"("+t.workerSetup+")(),\n":"")+"self.PLAYER = ("+t.playerBuilder+').call(self),\n"OK"')}).then(function(){var t=e.worker;return t.__parallel__=e,t})},"static create":function(t){var e=this;return e.createWorker(t).then(function(t){return new e({name:name,worker:t})})},__newFuture__:function(t){var e=this.__future__;return e&&e.isPending()&&(e.hasOwnProperty("__cancelValue__")?e.resolve(e.__cancelValue__):e.reject("Canceled!")),e=new u,void 0!==t&&(e.__cancelValue__=t),this.__future__=e},__onmessage__:function(t){var e=this.__future__;e&&(e.hasOwnProperty("__cancelValue__")?e.resolve(e.__cancelValue__):e.reject("Canceled!")),this.__future__=null;try{var n=JSON.parse(t.data);n.error?e.reject(n.error):e.resolve(n.result)}catch(t){e.reject(t)}},__run__:function(t){var e=this.__newFuture__(x.commandQuit);return this.worker.postMessage(t),e},decision:function(t,e){return this.__run__("PLAYER.decision(Sermat.mat("+JSON.stringify(n.ser(t))+"),"+JSON.stringify(e)+")")},evaluatedMoves:function(t,e){return this.__run__("PLAYER.evaluatedMoves(Sermat.mat("+JSON.stringify(n.ser(t))+"),"+JSON.stringify(e)+")")}});var B,j,I=v.aleatories.Aleatory=s({constructor:function(t){this.__distribution__=d(t).toArray(),f(this.__distribution__.length<1,"Aleatories must have at least one value!")},count:function(){return this.__distribution__.length},value:function(t){return this.__distribution__[t][0]},probability:function(t){return+this.__distribution__[t][1]},randomValue:function(t){return(t=t||r.DEFAULT).weightedChoice(this.__distribution__)},distribution:function(){var e=this;return p.range(this.count()).map(function(t){return[e.value(t),e.probability(t)]})},"static tries":function(e,n){var i=c.math.combinations;return n<=0?[[0,1]]:p.range(n+1).map(function(t){return[t,Math.pow(e,t)*Math.pow(1-e,n-t)*i(n,t)]}).toArray()},"static aggregate":function(t,e,r,s){var a=[];return r=r||function(t,e){return t+e},s=s||function(t,e){return t===e},p.product(t,e).forEachApply(function(t,e){for(var n=r(t[0],e[0]),i=0;i<a.length;i++)if(s(a[i][0],n))return void(a[i][1]+=t[1]*e[1]);a.push([n,t[1]*e[1]])}),a},"static __SERMAT__":{identifier:"Aleatory",serializer:function(t){return[t.distribution().toArray()]}}}),F=v.aleatories.DieAleatory=s(I,{constructor:function(t,e){1===arguments.length&&(e=t,t=1),this.min=0|t,this.max=0|e},count:function(){return this.max-this.min+1},value:function(t){return t>this.max-this.min?void 0:t+this.min},probability:function(t){return t>this.max-this.min?NaN:1/(this.max-this.min+1)},randomValue:function(t){return(t||r.DEFAULT).randomInt(this.min,this.max+1)},"static __SERMAT__":{identifier:"DiceAleatory",serializer:function(t){return[t.min,t.max]}}});return y.dice={D4:new F(4),D6:new F(6),D8:new F(8),D10:new F(10),D12:new F(12),D20:new F(20)},y.uniformAleatory=function(t){var e=1/(t=d(t).toArray()).length;return new I(t.map(function(t){return[t,e]}))},y.normalization=function(t){var i=0,r=[];return d(t).forEachApply(function(t,e){f(e<0,"aleatories.normalization: probabilities cannot be negative ("+e+")!"),i+=e;for(var n=0;n<r.length;n++)if(r[n][0]===t)return void(r[n][1]+=e);r.push([t,e])}),0<i&&r.forEach(function(t){t[1]/=i}),r},y.sumProbability=function(i,r,s){if(r|=0,s|=0,i|=0,isNaN(r)||isNaN(s)||isNaN(i)||r<1||s<2)return NaN;if(i<r||r*s<i)return 0;var a=c.math.factorial,o=a(r),u=o/r;return Math.pow(s,-r)*p.range(0,Math.floor((i-r)/s)+1).map(function(t){var e=o/a(t)/a(r-t),n=i-s*t-1;return(t%2?-1:1)*e*(a(n)/u/a(n-r+1))}).sum()},g.Predefined=s(P,{name:"Predefined",height:5,width:5,constructor:function(t,e,n,i){e&&(this.__results__=e,this.players=Object.keys(e)),P.call(this,t),isNaN(n)||(this.height=+n),isNaN(i)||(this.width=+i)},players:["A","B"],__results__:{A:0,B:0},moves:function(){if(0<this.height)return _(this.activePlayer(),p.range(1,this.width+1).toArray())},result:function(){return 0<this.height?null:this.__results__},next:function(t,e,n){return f(e,"Haps are not required (given ",e,")!"),n?(this.height--,this.activatePlayers(this.opponent()),this):new this.constructor(this.opponent(),this.__results__,this.height-1,this.width)},"static __SERMAT__":{identifier:"Predefined",serializer:function(t){return[t.activePlayer(),t.__results__,t.height,t.width]}}}),g.Choose2Win=s(P,{constructor:function(t,e,n){P.call(this,e),this.__turns__=isNaN(t)?1/0:+t,this.__winner__=n},name:"Choose2Win",players:["This","That"],moves:function(){if(!this.__winner__&&0<this.__turns__)return _(this.activePlayer(),["win","lose","pass"])},result:function(){return this.__winner__?this.victory(this.__winner__):this.__turns__<1?this.draw():null},next:function(t,e,n){var i=this.activePlayer(),r=this.opponent(i);f(!t.hasOwnProperty(i),"No move for active player ",i," at ",this,"!"),f(e,"Haps are not required (given ",e,")!");var s={win:i,lose:r,pass:void 0},a=t[i];if(s.hasOwnProperty(a))return n?(this.activatePlayers(r),this.__turns__--,this.__winner__=s[a],this):new this.constructor(this.__turns__-1,r,s[a]);l("Invalid move ",t[i]," for ",i," at ",this,"!")},"static __SERMAT__":{identifier:"Choose2Win",serializer:function(t){var e=[t.__turns__,t.activePlayer()];return t.__winner__&&e.push(t.__winner__),e}}}),g.ConnectionGame=s(P,{name:"ConnectionGame",height:9,width:9,lineLength:5,constructor:function(t,e){P.call(this,t),this.board=e instanceof T?e:new T(this.height,this.width,e),this.height=this.board.height,this.width=this.board.width},players:["First","Second"],__lines__:function(){var s={};function t(t,e,n){var i=t+"x"+e+"/"+n;if(!s.hasOwnProperty(i)){var r=new T(t,e,".".repeat(t*e));s[i]=r.lines().map(function(t){return t.toArray()},function(t){return t.length>=n}).toArray()}return s[i]}return t.CACHE=s,t}(),result:function(){if(this.hasOwnProperty("__result__"))return this.__result__;for(var t=this.lineLength,e=this.board.asStrings(this.__lines__(this.height,this.width,t)).join(" "),n=0;n<this.players.length;++n)if(0<=e.indexOf(n.toString(36).repeat(t)))return this.__result__=this.victory([this.players[n]]);return e.indexOf(".")<0?this.__result__=this.tied():this.__result__=null},moves:function(){if(this.hasOwnProperty("__moves__"))return this.__moves__;if(this.result())this.__moves__=null;else{var e=this.board;this.__moves__=_(this.activePlayer(),e.coordinates().filter(function(t){return e.isEmptySquare(t)}).toArray())}return this.__moves__},next:function(t,e,n){f(e,"Haps are not required (given ",e,")!");var i=this.activePlayer(),r=this.players.indexOf(i),s=t[i],a=(r+1)%this.players.length,o=this.board.place(s,r.toString(36));return n?(this.activatePlayers(a),this.board=o,this):new this.constructor(a,o)},display:function(n){f(!(n&&n instanceof q.BasicHTMLInterface),"Unsupported UI!");var i=this.moves(),r=this.activePlayer(),s=this.board;i=i&&i[r];this.board.renderAsHTMLTable(n.document,n.container,function(t){t.className="."===t.square?"ludorum-empty":"ludorum-player"+t.square,t.innerHTML="."===t.square?"&nbsp;":"&#x25CF;";var e=t.coord[0]*s.height+t.coord[1];i&&0<=i.indexOf(e)&&(t.move=e,t.activePlayer=r,t.onclick=n.perform.bind(n,t.move,r))});return n},"static __SERMAT__":{identifier:"ConnectionGame",serializer:function(t){return[t.activePlayer(),t.board]}}}),g.OddsAndEvens=s(P,{name:"OddsAndEvens",constructor:function(t,e){P.call(this,this.players),this.turns=isNaN(t)?1:+t,this.points=e||{Evens:0,Odds:0}},isSimultaneous:!0,players:["Evens","Odds"],moves:function(){return this.turns<1?null:{Evens:[1,2],Odds:[1,2]}},result:function(){var t=this.points.Evens-this.points.Odds;return 0<this.turns?null:{Evens:+t,Odds:-t}},next:function(t,e,n){f("number"!=typeof t.Evens||"number"!=typeof t.Odds,"Invalid moves ",t,"!"),f(e,"Haps are not required (given ",e,")!");var i=(t.Evens+t.Odds)%2==0,r={Evens:this.points.Evens+(i?1:0),Odds:this.points.Odds+(i?0:1)};return n?(this.turns--,this.points=r,this):new this.constructor(this.turns-1,r)},"static __SERMAT__":{identifier:"OddsAndEvens",serializer:function(t){return[t.turns,t.points]}}}),g.TicTacToe=s(P,{name:"TicTacToe",constructor:function(t,e){P.call(this,t),this.board=e||"_________"},players:["Xs","Os"],result:function(){return this.board.match(this.WIN_X)?this.victory(["Xs"]):this.board.match(this.WIN_O)?this.victory(["Os"]):this.board.indexOf("_")<0?this.tied():null},moves:function(){if(this.result())return null;var t={};return t[this.activePlayer()]=d(this.board).filter(function(t,e){return"_"===t},function(t,e){return e}).toArray(),t},next:function(t,e,n){f(e,"Haps are not required (given ",e,")!");var i=this.activePlayer(),r=+t[i];if(isNaN(r)||"_"!==this.board.charAt(r))throw new Error("Invalid move "+JSON.stringify(t)+" for board "+this.board+" (moves= "+JSON.stringify(t)+").");var s=this.board.substring(0,r)+i.charAt(0)+this.board.substring(r+1);return n?(this.activatePlayers(this.opponent(i)),this.board=s,this):new this.constructor(this.opponent(i),s)},"static __SERMAT__":{identifier:"TicTacToe",serializer:function(t){return[t.activePlayer(),t.board]}},__hash__:function(t){var e={_:0,X:1,O:2};return parseInt((t||this.board).split("").map(function(t){return e[t]}).join(""),3)},equivalent:(B="210543876 678345012 630741852 258147036 876543210 852741630 036147258".split(" ").map(function(t){return t.split("").map(function(t){return+t})}),j=function(){var e=this.board,t=B.map(function(t){return t.map(function(t){return e.charAt(t)}).join("")});return t.sort(),t},j.MAPPINGS=B,j),printBoard:function(){var e=this.board;return[0,3,6].map(function(t){return e.substr(0,3).split("").join("|")}).join("\n-+-+-\n")},"static heuristics":{heuristicFromWeights:function(i){var r=d(i).map(Math.abs).sum();function t(t,e){var n=e.charAt(0);return d(t.board).map(function(t,e){return"_"===t?0:i[e]*(t===n?1:-1)}).sum()/r}return t.weights=i,t}},"":function(){var t=new T(3,3,"_".repeat(9)),e=t.sublines(t.lines(),3);this.prototype.WIN_X=new RegExp(t.asRegExps(e,"X",".")),this.prototype.WIN_O=new RegExp(t.asRegExps(e,"O",".")),this.heuristics.defaultHeuristic=this.heuristics.heuristicFromWeights([2,1,2,1,5,1,2,1,2])}}),g.ToadsAndFrogs=s(P,{name:"ToadsAndFrogs",constructor:function t(e,n){P.call(this,e),this.board=n||t.board()},"static board":function(t,e){return t=isNaN(t)?3:+t,e=isNaN(e)?2:+e,"T".repeat(t)+"_".repeat(e)+"F".repeat(t)},players:["Toads","Frogs"],result:function(){return this.moves()?null:this.defeat()},moves:function(){var t=this.activePlayer(),e={},n=e[t]=[];return this.board.replace(t==this.players[0]?/TF?_/g:/_T?F/g,function(t,e){return n.push(e),t}),0<n.length?e:null},next:function(t,e,n){f(e,"Haps are not required (given ",e,")!");var i,r=this.activePlayer(),s=t[r],a=(r.charAt(0),this.board);if("T_"==a.substr(s,2))i=a.substring(0,s)+"_T"+a.substring(s+2);else if("_F"==a.substr(s,2))i=a.substring(0,s)+"F_"+a.substring(s+2);else if("TF_"==a.substr(s,3))i=a.substring(0,s)+"_FT"+a.substring(s+3);else{if("_TF"!=a.substr(s,3))throw new Error("Invalid move ",s," for board <",a,">.");i=a.substring(0,s)+"FT_"+a.substring(s+3)}return n?(this.activatePlayers(this.opponent()),this.board=i,this):new this.constructor(this.opponent(),i)},"static __SERMAT__":{identifier:"ToadsAndFrogs",serializer:function(t){return[t.activePlayer(),t.board]}},__hash__:function(t,e){var n={_:0,T:1,F:2};return t=(t||this.activePlayer()).charAt(0),e=e||this.board,parseInt((t+e).split("").map(function(t){return n[t]}).join(""),3)}}),g.Pig=s(P,{name:"Pig",constructor:function(t,e,n,i){P.call(this,t),this.goal=isNaN(e)?100:+e,this.__scores__=n||d(this.players).zip([0,0]).toObject(),this.__rolls__=i||[]},isDeterministic:!1,players:["One","Two"],moves:function(){if(!this.result()){var t=this.activePlayer(),e=this.__scores__[t]+d(this.__rolls__).sum();return _(t,this.__rolls__.length<1?["roll"]:e>=this.goal?["hold"]:["roll","hold"])}},result:function(){var t=this.__scores__[this.players[0]],e=this.__scores__[this.players[1]];if(t>=this.goal||e>=this.goal){var n={};return n[this.players[0]]=Math.min(this.goal,t)-Math.min(this.goal,e),n[this.players[1]]=-n[this.players[0]],n}},next:function(t,e,n){var i=this.activePlayer(),r=t&&t[i];f(!r,"No move for active player ",i," at ",this,"!");var s=this.opponent(),a=this.__scores__,o=[];if("hold"===r||"roll"===r){if("hold"===r)(a=h(a))[i]+=d(this.__rolls__).sum();else{var u=0|(e&&e.die);if(!u)return new M(this,t,{die:y.dice.D6},n);if(1<u)return s=i,o=this.__rolls__.concat(u),new this.constructor(i,this.goal,this.__scores__,this.__rolls__.concat(u))}return n?(this.activatePlayers(s),this.__scores__=a,this.__rolls__=o,this):new this.constructor(s,this.goal,a,o)}l("Invalid moves ",JSON.stringify(t)," at ",this,"!")},resultBounds:function(){return[-this.goal,+this.goal]},"static __SERMAT__":{identifier:"Pig",serializer:function(t){return[t.activePlayer(),t.goal,t.__scores__,t.__rolls__]}}}),g.Mutropas=s(P,{name:"Mutropas",players:["Left","Right"],constructor:function(t){P.call(this,this.players),t=t||{},this.playedPieces=t.playedPieces||[],this.pieces=t.pieces||this.dealPieces(t.random),this.__scores__=t.scores||_(this.players[0],0,this.players[1],0)},isDeterministic:!1,isSimultaneous:!0,allPieces:p.range(9).toArray(),dealPieces:function(t){t=t||r.DEFAULT;var e=this.allPieces.length/2|0,n=t.split(e,this.allPieces),i=t.split(e,n[1]);return _(this.players[0],n[0],this.players[1],i[0])},moves:function(){return this.result()?null:h({},this.pieces)},moveResult:function(t,e){var n=d(this.allPieces).max(0)+1;return t<e?e-t<=n/2?1:-1:e<t?n/2+1<=t-e?1:-1:0},next:function(t,e,n){var i=this.players[0],r=this.players[1];if(!this.pieces[i]||!this.pieces[r])return this.__viewNext__(t,e,n);var s=t[i],a=t[r],o=this.pieces;f(o[i].indexOf(s)<0,"Invalid move ",JSON.stringify(s)," for player ",i,"! (moves= ",JSON.stringify(t),")"),f(o[r].indexOf(a)<0,"Invalid move ",JSON.stringify(a)," for player ",r,"! (moves= ",JSON.stringify(t),")");var u=this.moveResult(s,a),c=this.playedPieces.concat([s,a]),h=_(i,o[i].filter(function(t){return t!==s}),r,o[r].filter(function(t){return t!==a})),l=_(i,this.__scores__[i]+u,r,this.__scores__[r]-u);return n?(this.playedPieces=c,this.pieces=h,this.__scores__=l,this):new this.constructor({playedPieces:c,pieces:h,scores:l})},__viewNext__:function(t,e,n){var i=this.pieces[this.players[0]]?this.players[0]:this.players[1],r=this.opponent(i);return e?new this.constructor({pieces:_(i,this.pieces[i],r,e[r]),playedPieces:this.playedPieces,scores:this.__scores__}).next(t,null,n):this.contingent(t,_(i,y.uniformAleatory(this.__possiblePieces__(r))),n)},scores:function(){return h({},this.__scores__)},result:function(){var t=this.players;if(this.playedPieces.length>=this.allPieces.length-1){var e=this.scores();return this.zerosumResult(e[t[0]]-e[t[1]],t[0])}return null},__possiblePieces__:function(t){var e=this.playedPieces,n=this.pieces[this.opponent(t)],i=d(this.allPieces).filter(function(t){return e.indexOf(t)<0&&n.indexOf(t)<0});return i.combinations(i.count()-1)},view:function(t){return new this.constructor({pieces:_(t,this.pieces[t]),playedPieces:this.playedPieces,scores:this.__scores__})},"static __SERMAT__":{identifier:"Mutropas",serializer:function(t){return[{pieces:t.pieces,playedPieces:t.playedPieces,scores:t.__scores__}]}}}),g.Bahab=s(P,{name:"Bahab",players:["Uppercase","Lowercase"],constructor:function(t,e){P.call(this,t),this.board=e instanceof T?e:new T(5,5,e||this.initialBoard)},initialBoard:["BBABB","BBBBB",".....","bbbbb","bbabb"].join(""),__PLAYER_ENDGAME_RE__:{Uppercase:/^[.Bab]+$|^.{0,4}[a]/,Lowercase:/^[.bAB]+$|[A].{0,4}$/},result:function(){for(var t,e=this.board.string,n=0;n<2;++n)if(t=this.players[n],e.match(this.__PLAYER_ENDGAME_RE__[t]))return this.defeat(t);return this.moves()?null:this.defeat(this.activePlayer())},__PLAYER_PIECES_RE__:{Uppercase:/[AB]/g,Lowercase:/[ab]/g},moves:function(){var t=this.activePlayer(),a=this.__PLAYER_PIECES_RE__[t],o=this.board,u=[];return o.string.replace(a,function(r,t){var e,s=[t/5|0,t%5];switch(r){case"A":e=[[1,-1],[-1,0],[1,1]];break;case"B":e=[[1,-1],[1,1]];break;case"a":e=[[-1,-1],[1,0],[-1,1]];break;case"b":e=[[-1,-1],[-1,1]]}return d(e).forEachApply(function(t,e){var n=[s[0]+t,s[1]+e],i=o.square(n);!o.isValidCoord(n)||i.match(a)||"."!=i&&r.toLowerCase()!=i.toLowerCase()||u.push([s,n])}),r}),0<u.length?_(t,u):null},next:function(t,e,n){f(e,"Haps are not required (given ",e,")!"),f(!t,"Invalid moves ",t,"!");var i=this.activePlayer(),r=t[i];f(!Array.isArray(t[i]),"Invalid moves ",t,"!");var s=this.board.move(r[0],r[1]);return n?(this.activatePlayers(this.opponent()),this.board=s,this):new this.constructor(this.opponent(),s)},"static __SERMAT__":{identifier:"Bahab",serializer:function(t){return[t.activePlayer(),t.board]}}}),g.Puzzle15=s(P,{name:"Puzzle15",players:["Player"],width:4,height:4,target:"0123456789ABCDE ",maxMoves:81,constructor:function(t){P.call(this,this.players[0]),t=t||{},this.board=t.board||this.randomBoard(),this.moveNumber=0|t.moveNumber},randomBoard:function(t,e,n,i){return t=0|t||this.width,e=0|e||this.height,n=n||r.DEFAULT,i=i||p.range(t*e-1).map(function(t){return t.toString(36)}).join("").toUpperCase(),new T(t,e,n.shuffle(" "+i.substr(0,t*e-1)).join("")," ")},differences:function(t){t=t||this.target;var e=this.board.string;return d(e).zip(t).map(function(t){return t[0]===t[1]?0:1}).sum()},scores:function(){return _(this.players[0],this.maxMoves-this.moveNumber)},result:function(){return 0===this.differences()?this.victory():this.moveNumber>=this.maxMoves?this.defeat():null},emptyCoord:function(){var t=this.board.string.indexOf(" "),e=this.board.width;return[t/e|0,t%e]},moves:function(){var n=this.emptyCoord();this.board;return this.result()?null:{Player:d(S.DIRECTIONS.ORTHOGONAL).mapApply(function(t,e){return[n[0]+t,n[1]+e]},this.board.isValidCoord.bind(this.board)).toArray()}},next:function(t,e,n){f(e,"Haps are not required (given ",e,")!");var i=this.board.swap(this.emptyCoord(),t.Player);return n?(this.board=i,this.moveNumber++,this):new this.constructor({board:i,moveNumber:this.moveNumber+1})},"static __SERMAT__":{identifier:"Puzzle15",serializer:function(t){return[{board:t.board,moveNumber:t.moveNumber}]}}}),w.RoundRobin=s(N,{constructor:function(t,e,n){N.call(this,t,e),this.matchCount=isNaN(n)?t.players.length:+n,this.__advance__=this.__matches__().chain(p.repeat(null)).__iter__()},__matches__:function(){var e=this.game;return d(this.players).permutations(e.players.length).product(p.range(this.matchCount)).map(function(t){return new x(e,t[0])})},"static __SERMAT__":{identifier:"RoundRobin",serializer:function(t){return[t.game,t.players,t.matchCount]}}}),w.Measurement=s(N,{constructor:function(t,e,n,i){N.call(this,t,Array.isArray(e)?e:[e]),this.opponents=Array.isArray(n)?n:[n],f(this.opponents.length<t.players.length-1,"Not enough opponents."),this.matchCount=isNaN(i)?t.players.length:+i,this.__advance__=this.__matches__().chain(p.repeat(null)).__iter__()},__matches__:function(){var n=this.game,t=n.players.length,e=d(this.opponents);return e=2<t?e.product.apply(e,p.repeat(this.opponents,t-2).toArray()):e.map(function(t){return[t]}),d(this.players).product(p.range(t),e,p.range(this.matchCount)).map(function(t){var e=t[2].slice(0);return e.splice(t[1],0,t[0]),new x(n,e)})},"static __SERMAT__":{identifier:"Measurement",serializer:function(t){return[t.game,t.players,t.opponents,t.matchCount]}}}),w.Elimination=s(N,{constructor:function(t,e,n){N.call(this,t,e),this.matchCount=isNaN(n)?1:+n>>0},__bracket__:function(n){var i=this.game,r=this.matchCount,s=this.game.players.length;return(n=n||this.players).length<s?[]:p.range(0,n.length,s).map(function(t){var e=p.range(t,t+s).map(function(t){return n[t%n.length]}).toArray();return p.range(r).map(function(t){return e.unshift(e.pop()),new x(i,e)}).toArray()}).toArray()},__playoff__:function(t){var r={},s={};t.forEach(function(t){var i=t.result();if(!i)throw new Error("Unfinished match in playoff!");d(t.players).forEach(function(t){var e=t[0],n=t[1].name;r[n]=(+r[n]||0)+i[e],s[n]=t[1]})});var e=d(r).greater(function(t){return t[1]})[0][0];return s[e]},__advance__:function(){if(!this.__matches__||this.__matches__.length<1){if(this.__currentBracket__){if(this.__currentBracket__.length<1)return null;var t=this.__currentBracket__.map(this.__playoff__);this.__currentBracket__=this.__bracket__(t)}else this.__currentBracket__=this.__bracket__(this.players);this.__matches__=d(this.__currentBracket__).flatten().toArray()}return this.__matches__.shift()},"static __SERMAT__":{identifier:"Elimination",serializer:function(t){return[t.game,t.players,t.matchCount]}}}),[x,g.Bahab,g.Choose2Win,g.ConnectionGame,g.Mutropas,g.OddsAndEvens,g.Pig,g.Predefined,g.TicTacToe,g.ToadsAndFrogs,g.Puzzle15,E,b.AlphaBetaPlayer,b.MaxNPlayer,b.MiniMaxPlayer,b.MonteCarloPlayer,b.RandomPlayer,b.TracePlayer,b.UCTPlayer,N,w.Elimination,w.Measurement,w.RoundRobin,y.Aleatory,y.DieAleatory,A.CheckerboardFromString].forEach(function(t){t.__SERMAT__.identifier=v.__package__+"."+t.__SERMAT__.identifier,v.__SERMAT__.include.push(t)}),n.include(v),v});
//# sourceMappingURL=ludorum.min.js.map