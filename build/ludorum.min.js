//! ludorum 0.1.2

"use strict";!function(a,b){"function"==typeof define&&define.amd?define(["creatartis-base"],b):"object"==typeof module&&module.exports?module.exports=b(require("creatartis-base")):a.ludorum=b(a.base)}(this,function __init__(base){var declare=base.declare,unimplemented=base.objects.unimplemented,obj=base.obj,copy=base.copy,raiseIf=base.raiseIf,Iterable=base.Iterable,iterable=base.iterable,Future=base.Future,Randomness=base.Randomness,initialize=base.initialize,Statistics=base.Statistics,Events=base.Events,exports={__name__:"ludorum",__init__:__init__};__init__.dependencies={"creatartis-base":base};var utils=exports.utils={},Game=exports.Game=declare({constructor:function(a){this.activePlayers=a?Array.isArray(a)?a:[a]:[this.players[0]]},name:"?",players:[],moves:unimplemented("Game","moves"),next:unimplemented("Game","next"),result:unimplemented("Game","result"),scores:function(){return this.results()},view:function(){return this},isActive:function(){for(var a=0;a<arguments.length;a++)if(this.activePlayers.indexOf(arguments[a])<0)return!1;return!0},activePlayer:function(){var a=this.activePlayers.length;return raiseIf(1>a,"There is no active player."),raiseIf(a>1,"More than one player is active."),this.activePlayers[0]},opponents:function(a){return a=a||this.activePlayers,this.players.filter(function(b){return a.indexOf(b)<0})},opponent:function(a){var b=this.players.indexOf(a||this.activePlayer());return this.players[(b+1)%this.players.length]},perform:function(){for(var a,b={},c=0;c<arguments.length;c+=2)a=arguments[c+1],"undefined"==typeof a&&(a=this.activePlayer()),b[a]=arguments[c];return this.next(b)},possibleMoves:function(a){if(a=arguments.length<1?this.moves():a,!a||"object"!=typeof a)return[];var b=Object.keys(a);if(1===b.length){var c=b[0];return a[c].map(function(a){return obj(c,a)})}return Iterable.product.apply(this,iterable(a).mapApply(function(a,b){return b.map(function(b){return[a,b]})}).toArray()).map(function(a){return iterable(a).toObject()}).toArray()},resultBounds:function(){return[-1,1]},normalizedResult:function(a){if(a=a||this.result()){var b=this.resultBounds();a=base.copy(a);for(var c in a)a[c]=(a[c]-b[0])/(b[1]-b[0])*2-1;return a}return null},zerosumResult:function(a,b){b=b?Array.isArray(b)?b:[b]:this.activePlayers,a=+a/(b.length||1);for(var c,d={},e=-a/(this.players.length-b.length||1),f=0;f<this.players.length;f++)c=this.players[f],d[c]=b.indexOf(c)<0?e:a;return d},victory:function(a,b){return this.zerosumResult(b||1,a)},defeat:function(a,b){return this.zerosumResult(b||-1,a)},draw:function(a,b){b=+(b||0),a=a||this.players;var c={};for(var d in a)c[a[d]]=b;return c},__serialize__:unimplemented("Game","__serialize__"),clone:function(){var a=this.__serialize__();return a.shift(),new(this.constructor.bind.apply(this.constructor,a))},identifier:function(){var a=this.__serialize__();return a.shift()+a.map(JSON.stringify).join("")},toString:function(){var a=this.__serialize__();return a.shift()+"("+a.map(JSON.stringify).join(",")+")"},toJSON:function(){return JSON.stringify(this.__serialize__())},"static fromJSON":function(a){"string"==typeof a?(a=JSON.parse(a),raiseIf(!Array.isArray(a)||a.length<1,"Invalid JSON data: "+a+"!")):(raiseIf(!Array.isArray(a)||a.length<1,"Invalid JSON data: "+a+"!"),a=a.slice());var b=games[a[0]];return raiseIf("function"!=typeof b,"Unknown game '",a[0],"'!"),"function"==typeof b.fromJSON?b.fromJSON(a):(a[0]=this,new(b.bind.apply(b,a)))},"static cached":function(a){{var b=a.prototype.moves;a.prototype.result}return declare(a,{moves:function(){var a=b.call(this);return this.moves=function(){return a},a},result:function c(){var c=super_result.call(this);return this.result=function(){return c},c}})},"static serialized":function(a){var b=a.prototype.moves,c=a.prototype.next;return declare(a,{moves:function d(){for(var a,c=this.__fixedMoves__||(this.__fixedMoves__={}),e=b.call(this),d={},f=0;f<this.activePlayers.length;f++)if(c.hasOwnProperty(this.activePlayers[f])){a=this.activePlayers[f];break}return a&&e?(d[a]=e[a],d):null},next:function(a){var b,d=copy({},this.fixedMoves||{},a),e=iterable(this.players).all(function(a){return d.hasOwnProperty(a)});return e?(b=c.call(this,d),b.fixedMoves={}):(b=this.clone(),b.fixedMoves=d),b}})}}),games=exports.games={},Player=exports.Player=declare({constructor:function(){var a=0;return function(b){initialize(this,b).string("name",{defaultValue:"Player"+a++,coerce:!0})}}(),decision:function(a,b){return this.movesFor(a,b)[0]},movesFor:function(a,b){var c=a.moves();return raiseIf(!c||!c[b]||c[b].length<1,"Player ",b," has no moves for game ",a,"."),c[b]},participate:function(){return this},__serialize__:function(){return[this.constructor.name,{name:this.name}]},toString:function(){var a=this.__serialize__();return a.shift()+"("+a.map(JSON.stringify).join(",")+")"}}),players=exports.players={},Match=exports.Match=declare({constructor:function(a,b){this.game=a,this.players=Array.isArray(b)?iterable(a.players).zip(b).toObject():b,this.history=[a],this.events=new Events({events:["begin","move","next","end","quit"]});for(var c in this.players)this.players[c]=this.players[c].participate(this,c)||this.players[c]},ply:function(){return this.history.length-1},state:function(a){return a=isNaN(a)?this.ply():0>+a?this.ply()+ +a:+a,this.history[0|a]},result:function(){return this.state().result()},decisions:function(a){a=a||this.state();var b=this,c=this.players,d=a.activePlayers;return Future.all(d.map(function(b){return c[b].decision(a,b)})).then(function(c){var e=iterable(d).zip(c).toObject();return b.onMove(a,e),e})},run:function(a){if(a=isNaN(a)?1/0:+a,1>a)return Future.when(this);var b,c=this.ply(),d=this.state();if(1>c&&this.onBegin(d),d=this.__advanceAleatories__(d),b=d.result())return this.onEnd(d,b),Future.when(this);var e=this;return this.decisions(d).then(function(b){return e.__advance__(d,b)?e.run(a-1):e})},__advanceAleatories__:function(a){for(var b;a instanceof Aleatory;a=b)b=a.next(),this.history.push(b),this.onNext(a,b);return a},__advance__:function(a,b){var c=this,d=a.activePlayers.filter(function(a){return b[a]instanceof Match.CommandQuit});if(d.length>0)return c.onQuit(a,d[0]),!1;var e=a.next(b);return this.history.push(e),this.onNext(a,e),!0},"static CommandQuit":function(){},onBegin:function(a){this.events.emit("begin",a,this),this.logger&&this.logger.info("Match begins with ",iterable(this.players).map(function(a){return a[1]+" as "+a[0]}).join(", "),"; for ",a,".")},onMove:function(a,b){this.events.emit("move",a,b,this),this.logger&&this.logger.info("Players move: ",JSON.stringify(b)," in ",a)},onNext:function(a,b){this.events.emit("next",a,b,this),this.logger&&this.logger.info("Match advances from ",a," to ",b)},onEnd:function(a,b){this.events.emit("end",a,b,this),this.logger&&this.logger.info("Match for ",a,"ends with ",JSON.stringify(b))},onQuit:function(a,b){this.events.emit("quit",a,b,this),this.logger&&this.logger.info("Match for ",a," aborted because player "+b+" quitted.")},toString:function(){return"Match("+this.game+", "+JSON.stringify(this.players)+")"}}),Tournament=exports.Tournament=declare({constructor:function(a,b){this.game=a,this.players=Array.isArray(b)?b:iterables.iterable(b).toArray(),this.statistics=new Statistics,this.events=new Events({events:["begin","beforeMatch","afterMatch","end"]})},__advance__:unimplemented("Tournament","__advance__"),run:function(){this.onBegin();var a=this;return Future.doWhile(function(){return Future.then(a.__advance__(),function(b){return b?(a.beforeMatch(b),a.__runMatch__(b).then(function(b){return a.account(b),a.afterMatch(b),b})):null})}).then(this.onEnd.bind(this))},__runMatch__:function(a){return a.run()},account:function(a){var b=this.game,c=a.result(),d=this.statistics;raiseIf(!c,"Match doesn't have results. Has it finished?"),iterable(a.players).forEach(function(e){var f=e[0],g=e[1],h=c[e[0]];d.add({key:"results",game:b.name,role:f,player:g.name},h),d.add({key:h>0?"victories":0>h?"defeats":"draws",game:b.name,role:f,player:g.name},h),d.add({key:"length",game:b.name,role:f,player:g.name},a.ply()),a.history.forEach(function(a){if("function"==typeof a.moves){var c=a.moves();c&&c.hasOwnProperty(f)&&c[f].length>0&&d.add({key:"width",game:b.name,role:f,player:g.name},c[f].length)}})})},onBegin:function(){this.events.emit("begin",this),this.logger&&this.logger.info("Tournament begins for game ",game.name,".")},beforeMatch:function(a){this.events.emit("beforeMatch",a,this),this.logger&&this.logger.debug("Beginning match with ",JSON.stringify(a.players),".")},afterMatch:function(a){this.events.emit("afterMatch",a,this),this.logger&&this.logger.debug("Finishing match with ",JSON.stringify(a.players),".")},onEnd:function(){this.events.emit("end",this.statistics,this),this.logger&&this.logger.info("Tournament ends for game ",game.name,":\n",this.statistics,"\n")}}),tournaments=exports.tournaments={},Aleatory=exports.Aleatory=declare({constructor:function(a,b){this.random=b||Randomness.DEFAULT,"function"==typeof a&&(this.next=a)},value:function a(){var a,b=random.random();if(iterable(this.distribution()).forEach(function(c){if(b-=c[1],0>=b)throw a=c[0],Iterable.STOP_ITERATION}),"undefined"==typeof a)throw new Error("Random value could not be obtained.");return a},next:unimplemented("Aleatory","next"),distribution:unimplemented("Aleatory","distribution")}),aleatories=exports.aleatories={};players.RandomPlayer=declare(Player,{constructor:function(a){Player.call(this,a),initialize(this,a).object("random",{defaultValue:Randomness.DEFAULT})},decision:function(a,b){return this.random.choice(this.movesFor(a,b))}}),players.TracePlayer=declare(Player,{constructor:function(a){Player.call(this,a),this.trace=iterable(a.trace),this.__iterator__=this.trace.__iter__(),this.__decision__=this.__iterator__()},decision:function(){try{this.__decision__=this.__iterator__()}catch(a){Iterable.prototype.catchStop(a)}return this.__decision__},__serialize__:function(){return["TracePlayer",{name:this.name,trace:this.trace.toArray()}]}});var HeuristicPlayer=players.HeuristicPlayer=declare(Player,{constructor:function(a){Player.call(this,a),initialize(this,a).object("random",{defaultValue:Randomness.DEFAULT}).func("heuristic",{ignore:!0})},moveEvaluation:function(a,b,c){if(Object.keys(a).length<2)return this.stateEvaluation(b.next(a),c);var d=0,e=0,a=copy(obj(c,[a[c]]),a);return b.possibleMoves(a).forEach(function(a){d+=this.stateEvaluation(b.next(a),c),++e}),e>0?d/e:0},stateEvaluation:function(a,b){var c=a.result();return c?c[b]:this.heuristic(a,b)},heuristic:function(){return this.random.random(-.5,.5)},bestMoves:function(a){return iterable(a).greater(function(a){return a[1]}).map(function(a){return a[0]})},selectMoves:function(a,b,c){var d=this,e=!1,f=a.map(function(a){var f=d.moveEvaluation(a,b,c);return f instanceof Future?(e=e||!0,f.then(function(b){return[a,b]})):[a,f]});return e?Future.all(f).then(this.bestMoves):this.bestMoves(f)},decision:function(a,b){var c=this,d=a.moves();raiseIf(!d||!d.hasOwnProperty(b),"Player "+b+" is not active (moves= "+JSON.stringify(d)+"!");var e=d[b];raiseIf(!Array.isArray(e)||e.length<1,"Player "+b+" has no moves ("+e+")!"),d=e.map(function(a){return copy(obj(b,a),d)});var f=c.selectMoves(d,a,b);return Future.then(f,function(a){return c.random.choice(a)[b]})}}),MaxNPlayer=players.MaxNPlayer=declare(HeuristicPlayer,{constructor:function(a){HeuristicPlayer.call(this,a),initialize(this,a).integer("horizon",{defaultValue:3,coerce:!0})},stateEvaluation:function(a,b){return this.maxN(a,b,0)[b]},heuristics:function(a){var b={},c=this;return a.players.forEach(function(d){b[d]=c.heuristic(a,d)}),b},quiescence:function(a,b,c){var d=a.result();return d?d:c>=this.horizon?this.heuristics(a):null},maxN:function(a,b,c){var d=this.quiescence(a,b,c);if(!d){var e,f,g=a.activePlayer(),h=this.movesFor(a,g),d={};if(h.length<1)throw new Error("No moves for unfinished game "+a+".");for(var i=0;i<h.length;++i)f=a.next(obj(g,h[i])),e=this.maxN(f,b,c+1),e[g]>(d[g]||-1/0)&&(d=e)}return d},toString:function(){return(this.constructor.name||"MaxNPlayer")+"("+JSON.stringify({name:this.name,horizon:this.horizon})+")"}}),MiniMaxPlayer=players.MiniMaxPlayer=declare(HeuristicPlayer,{constructor:function(a){HeuristicPlayer.call(this,a),initialize(this,a).integer("horizon",{defaultValue:4,coerce:!0})},stateEvaluation:function(a,b){return this.minimax(a,b,0)},quiescence:function(a,b,c){var d=a.result();return d?d[b]:c>=this.horizon?this.heuristic(a,b):0/0},minimax:function(a,b,c){var d=this.quiescence(a,b,c);if(isNaN(d)){var e,f,g=a.activePlayer(),h=this.movesFor(a,g);if(h.length<1)throw new Error("No moves for unfinished game "+a+".");g==b?(d=-1/0,e=Math.max):(d=+1/0,e=Math.min);for(var i=0;i<h.length;++i)f=a.next(obj(g,h[i])),d=e(d,this.minimax(f,b,c+1))}return d},toString:function(){return(this.constructor.name||"MiniMaxPlayer")+"("+JSON.stringify({name:this.name,horizon:this.horizon})+")"}});players.AlphaBetaPlayer=declare(MiniMaxPlayer,{constructor:function(a){MiniMaxPlayer.call(this,a)},stateEvaluation:function(a,b){return this.minimax(a,b,0,-1/0,1/0)},minimax:function(a,b,c,d,e){var f=this.quiescence(a,b,c);if(!isNaN(f))return f;var g,h=a.activePlayer(),i=h==b,j=this.movesFor(a,h);if(j.length<1)throw new Error("No moves for unfinished game "+a+".");for(var k=0;k<j.length&&(g=a.next(obj(h,j[k])),f=this.minimax(g,b,c+1,d,e),i?f>d&&(d=f):e>f&&(e=f),!(d>=e));k++);return i?d:e}}),players.MonteCarloPlayer=declare(HeuristicPlayer,{constructor:function(a){HeuristicPlayer.call(this,a),initialize(this,a).number("simulationCount",{defaultValue:30,coerce:!0}).number("timeCap",{defaultValue:1e3,coerce:!0}).object("agent",{defaultValue:null})},selectMoves:function(a,b,c){for(var d=this,e=Date.now()+this.timeCap,f=a.map(function(a){return{move:a,nexts:Object.keys(a).length<2?[b.next(a)]:b.possibleMoves(copy(obj(c,[a[c]]),a)).map(function(a){return b.next(a)}),sum:0,count:0}}),g=0;g<this.simulationCount&&Date.now()<e;++g)f.forEach(function(a){a.nexts=a.nexts.filter(function(b){var e=d.simulation(b,c);return a.sum+=e.result[c],++a.count,e.plies>0})});return iterable(f).greater(function(a){return a.count>0?a.sum/a.count:0}).map(function(a){return a.move})},stateEvaluation:function(a,b){for(var c,d=0,e=this.simulationCount,f=0;e>f&&(c=this.simulation(a,b),d+=c.result[b],!(c.plies<1));++f);return e>0?d/e:0},simulation:function(a){var b,c,d,e=this;for(b=0;!0;++b)if(a instanceof Aleatory)a=a.next();else{if(d=a.moves(),!d)return{game:a,result:a.result(),plies:b};c={},a.activePlayers.forEach(function(b){c[b]=e.agent?e.agent.decision(a,b):e.random.choice(d[b])}),a=a.next(c)}return{game:a,result:a.result(),plies:b}},toString:function(){return(this.constructor.name||"MonteCarloPlayer")+"("+JSON.stringify({name:this.name,simulationCount:this.simulationCount,timeCap:this.timeCap})+")"}});var UserInterfacePlayer=players.UserInterfacePlayer=declare(Player,{constructor:function(a){Player.call(this,a)},participate:function(a,b){return this.role=b,this},decision:function(){return this.__future__&&this.__future__.isPending()&&this.__future__.resolve(new Match.CommandQuit),this.__future__=new Future},perform:function(a){var b=this.__future__;return b&&(this.__future__=null,b.resolve(a)),!!b}}),UserInterface=players.UserInterface=declare({constructor:function(a){this.onBegin=this.onBegin.bind(this),this.onNext=this.onNext.bind(this),this.onEnd=this.onEnd.bind(this),a.match&&this.show(a.match)},show:function(a){this.match&&(a.events.off("begin",this.onBegin),a.events.off("next",this.onNext),a.events.off("end",this.onEnd)),this.match=a,a.events.on("begin",this.onBegin),a.events.on("next",this.onNext),a.events.on("end",this.onEnd)},onBegin:function(a){this.display(a)},onNext:function(a,b){this.display(b)},onEnd:function(a,b){this.results=b,this.display(a)},display:function(){throw new Error("UserInterface.display is not defined. Please override.")},perform:function(a,b){iterable(this.match.players).forEach(function(c){var d=(c[0],c[1]);d instanceof UserInterfacePlayer&&(!b||d.role===b)&&d.perform(a)})}});UserInterface.BasicHTMLInterface=declare(UserInterface,{constructor:function(a){UserInterface.call(this,a),this.container=a.container,"string"==typeof this.container&&(this.container=document.getElementById(this.container))},display:function display(game){var ui=this,container=this.container;container.innerHTML=game.toHTML(),Array.prototype.slice.call(container.querySelectorAll("[data-ludorum]")).forEach(function(elem){var data=eval("({"+elem.getAttribute("data-ludorum")+"})");data.hasOwnProperty("move")&&(elem.onclick=ui.perform.bind(ui,data.move,data.activePlayer))})}});var WebWorkerPlayer=players.WebWorkerPlayer=declare(Player,{constructor:function(a){Player.call(this,a),initialize(this,a).object("worker"),this.worker.onmessage=base.Parallel.prototype.__onmessage__.bind(this)},"static createWorker":function(a){raiseIf("string function".indexOf(typeof a)<0,"Invalid player builder: "+a+"!");var b=new base.Parallel;return b.run("self.ludorum = ("+exports.__init__+')(self.base), "OK"').then(function(){return b.run("self.PLAYER = ("+a+').call(self), "OK"')}).then(function(){return b.worker})},"static create":function(a){var b=this;return b.createWorker(a.playerBuilder).then(function(a){return new b({name:name,worker:a})})},decision:function(a,b){return this.__future__&&this.__future__.isPending()&&this.__future__.resolve(Match.commandQuit),this.__future__=new Future,this.worker.postMessage("PLAYER.decision(ludorum.Game.fromJSON("+a.toJSON()+"), "+JSON.stringify(b)+")"),this.__future__}});aleatories.Dice=declare(Aleatory,{constructor:function(a,b,c){Aleatory.call(this,a,c),this.base=isNaN(b)?6:Math.max(2,+b)},value:function(){return this.random.randomInt(1,this.base+1)},distribution:function(){return this.__distribution__||(this.__distribution__=function(a){return Iterable.range(1,a+1).map(function(b){return[b,1/a]}).toArray()}(this.base))}});var Checkerboard=utils.Checkerboard=declare({constructor:function(a,b){isNaN(a)||(this.height=0|a),isNaN(b)||(this.width=0|b)},emptySquare:null,isValidCoord:function(a){return Array.isArray(a)&&!isNaN(a[0])&&!isNaN(a[1])&&a[0]>=0&&a[0]<this.height&&a[1]>=0&&a[1]<this.width},coordinates:function(){return Iterable.range(this.height).product(Iterable.range(this.width))},square:unimplemented("utils.Checkerboard","square"),isEmptySquare:function(a){return this.square(a)===this.emptySquare},horizontals:function(){var a=this.width;return Iterable.range(this.height).map(function(b){return Iterable.range(a).map(function(a){return[b,a]})})},verticals:function(){var a=this.height;return Iterable.range(this.width).map(function(b){return Iterable.range(a).map(function(a){return[a,b]})})},orthogonals:function(){return this.horizontals().chain(this.verticals())},positiveDiagonals:function(){var a=this.width,b=this.height,c=b+a-1;return Iterable.range(c).map(function(a){var d=Math.max(0,b-a-1),e=Math.max(0,a-b+1);return Iterable.range(Math.min(a+1,c-a)).map(function(a){return[d+a,e+a]})})},negativeDiagonals:function(){var a=this.width,b=this.height,c=b+a-1;return Iterable.range(c).map(function(a){var d=Math.min(a,b-1),e=Math.max(0,a-b+1);return Iterable.range(Math.min(a+1,c-a)).map(function(a){return[d-a,e+a]})})},diagonals:function(){return this.positiveDiagonals().chain(this.negativeDiagonals())},lines:function(){return this.orthogonals().chain(this.diagonals())},sublines:function(a,b){return iterable(a).map(function(a){return Array.isArray(a)?a:iterable(a).toArray()},function(a){return a.length>=b}).map(function(a){return Iterable.range(0,a.length-b+1).map(function(c){return a.slice(c,c+b)})}).flatten()},walk:function(a,b){var c=this;return new Iterable(function(){var d=a.slice();return function(){if(c.isValidCoord(d)){var a=d.slice();return d[0]+=b[0],d[1]+=b[1],a}throw Iterable.STOP_ITERATION}})},walks:function(a,b){var c=this;return b.map(function(b){return c.walk(a,b)})},"static DIRECTIONS":{HORIZONTAL:[[0,-1],[0,1]],VERTICAL:[[-1,0],[1,0]],ORTHOGONAL:[[0,-1],[0,1],[-1,0],[1,0]],DIAGONAL:[[-1,-1],[-1,1],[1,-1],[1,1]],EVERY:[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[-1,1],[1,-1],[1,1]]},clone:unimplemented("utils.Checkerboard","clone"),__place__:unimplemented("utils.Checkerboard","place"),place:function(a,b){return this.clone().__place__(a,b)},__move__:function(a,b,c){return this.__place__(b,this.square(a)).__place__(a,"undefined"==typeof c?this.emptySquare:c)},move:function(a,b,c){return this.clone().__move__(a,b,c)},__swap__:function(a,b){var c=this.square(b);return this.__place__(b,this.square(a)).__place__(a,c)},swap:function(a,b){return this.clone().__swap__(a,b)},asHTMLTable:function(a,b,c){var d=a.createElement("table");board.horizontals().reverse().forEach(function(b){var e=a.createElement("tr");d.appendChild(e),b.forEach(function(b){var d=board.square(b),f=a.createElement("td"),g=c(d,b);e.appendChild(f),f.ludorum_data=base.copy({},g,{id:"ludorum-square-"+b.join("-"),className:"ludorum-square",innerHTML:base.Text.escapeXML(d),game:this,coord:b}),f.id=g.id,f.className=g.className,f.innerHTML=g.innerHTML})})},weightedSum:function(a,b){var c=this;return this.coordinates().zip(a).mapApply(function(a,d){return b[c.square(a)]*d||0}).sum()}}),CheckerboardFromString=utils.CheckerboardFromString=declare(Checkerboard,{constructor:function(a,b,c,d){if(Checkerboard.call(this,a,b),d&&(this.emptySquare=(d+this.emptySquare).charAt(0)),c&&c.length!==a*b)throw new Error("Given string "+JSON.stringify(c)+" does not match board dimensions.");this.string=c||this.emptySquare.repeat(a*b)},emptySquare:".",toString:function(){var a=this.string,b=this.height,c=this.width;return Iterable.range(b).map(function(d){return a.substr((b-d-1)*c,c)}).join("\n")},square:function(a,b){var c=a[0],d=a[1],e=this.width;return c>=0&&c<this.height&&d>=0&&e>d?this.string.charAt(c*e+d):b},asString:function(a){var b=this;return a.map(function(a){return b.square(a)}).join("")},asStrings:function(a){var b=this;return a.map(function(a){return b.asString(a)})},asRegExp:function(a,b,c){c=c||".";var d=this.width,e=Iterable.repeat(!1,d*this.height).toArray();a.forEach(function(a){e[a[0]*d+a[1]]=!0});for(var f,g="",h=0,i=0;i<e.length;h=0){f=e[i];do++h;while(++i<e.length&&e[i]===f);g+=2>h?f?b:c:(f?b:c)+"{"+h+"}"}return g},asRegExps:function(a,b,c){var d=this;return a.map(function(a){return d.asRegExp(a,b,c)}).join("|")},clone:function(){return new this.constructor(this.height,this.width,this.string,this.hasOwnProperty("emptySquare")?this.emptySquare:void 0)},__place__:function(a,b){raiseIf(!this.isValidCoord(a),"Invalid coordinate ",a,"."),b=(b+this.emptySquare).charAt(0);var c=a[0]*this.width+a[1];return this.string=this.string.substr(0,c)+b+this.string.substr(c+1),this}});return exports.utils.Scanner=declare({constructor:function(a){initialize(this,a).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:Randomness.DEFAULT}).object("statistics",{defaultValue:new Statistics})},scan:function(a){var b=this,c=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),d=0;return Future.whileDo(function(){return c.length>0&&d<b.maxLength},function(){return Future.all(c.map(function(c){return b.__advance__(a,c,d)})).then(function(a){return c=iterable(a).flatten().sample(b.maxWidth,b.random).toArray(),++d})}).then(function(){return b.statistics.add({key:"aborted"},c.length),b.statistics})},scans:function(){return Future.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(a,b,c){if(b instanceof Aleatory)return iterable(b.distribution()).mapApply(function(a){return b.next(a)});if(this.account(a,b,c))return Iterable.EMPTY;var d=b.moves(),e=this.statistics;return Future.all(b.activePlayers.map(function(c){if(a&&a[c]){var f=a[c],g=e.stat({key:"decision.time",game:b.name,role:c,player:f.name});return g.startTime(),Future.when(f.decision(b,c)).then(function(a){return g.addTime(),[[c,a]]})}return d[c].map(function(a){return[c,a]})})).then(function(a){return Iterable.product.apply(this,a).map(function(a){return b.next(iterable(a).toObject())})})},account:function(a,b,c){var d=b.result(),e=this.statistics;if(d)return iterable(b.players).forEach(function(f){{var g=d[f],h=a&&a[f]?a[f].name:"";["game:"+b.name,"role:"+f,"player:"+h]}e.add({key:"game.result",game:b.name,role:f,player:h},g,b),e.add({key:"game.length",game:b.name,role:f,player:h},c,b),0>g?(e.add({key:"defeat.result",game:b.name,role:f,player:h},g,b),e.add({key:"defeat.length",game:b.name,role:f,player:h},c,b)):g>0?(e.add({key:"victory.result",game:b.name,role:f,player:h},g,b),e.add({key:"victory.length",game:b.name,role:f,player:h},c,b)):e.add({key:"draw.length",game:b.name,role:f,player:h},c,b)}),!0;var f=b.moves();return iterable(b.activePlayers).forEach(function(a){e.add({key:"game.width",game:b.name,role:a},f[a].length)}),!1}}),utils.Cache=declare({constructor:function(a){this.clear(),a&&this.root(a)},stateIdentifier:function(a){return a.identifier()},moveIdentifier:function(a){return JSON.stringify(a)},has:function(a){var b="string"==typeof a?a:this.stateIdentifier(a);return this.__entries__.hasOwnProperty(b)},get:function(a){var b="string"==typeof a?a:this.stateIdentifier(a);return this.__entries__[b]},size:function(){return Object.keys(this.__entries__).length},entry:function(a,b){if(b=b||this.stateIdentifier(a),this.has(b))return this.get(b);var c={id:b,state:a,precursors:[],descendants:{}};return this.__entries__[b]=c,c},descendant:function(a,b){var c=this.moveIdentifier(b),d=a.descendants;if(d.hasOwnProperty(c))return d[c][1];var e=a.state.next(b),f=this.stateIdentifier(e),g=this.get(f)||this.entry(e,f);return d[c]=[b,g],g.precursors.push([b,a]),g},descendants:function(a){var b=this.descendant.bind(this,a);return arguments.length>1?Array.prototype.slice.call(arguments,1).map(b):a.state.possibleMoves().map(b)},clear:function(){this.__entries__={},this.__root__=null},root:function(a){if(arguments.length>0){var b=this.stateIdentifier(a);this.__root__=this.get(b)||this.entry(a,b),this.prune(b)}return this.__root__},prune:function(a){for(var b,c=[a||this.__root__.id],d={};a=c.shift();)d.hasOwnProperty(a)||(b=this.get(a),d[a]=b,c.push.apply(c,iterable(b.descendants).mapApply(function(a,b){return b[1].id}).toArray()));return this.__entries__=d}}),games.Predefined=declare(Game,{constructor:function(a,b,c,d){b&&(this.__results__=b,this.players=Object.keys(b)),Game.call(this,a),this.height=isNaN(c)?5:+c,this.width=isNaN(d)?5:+d},name:"Predefined",players:["A","B"],__results__:{A:0,B:0},moves:function(){return this.height>0?obj(this.activePlayer(),Iterable.range(1,this.width+1).toArray()):void 0},result:function(){return this.height>0?null:this.__results__},next:function(){return new this.constructor(this.opponent(),this.__results__,this.height-1,this.width)},__serialize__:function(){return[this.name,this.activePlayer(),this.results,this.height,this.width]}}),games.Choose2Win=declare(Game,{constructor:function(a,b,c){Game.call(this,b),this.__turns__=isNaN(a)?1/0:+a,this.__winner__=c},name:"Choose2Win",players:["This","That"],moves:function(){return!this.__winner__&&this.__turns__>0?obj(this.activePlayer(),["win","lose","pass"]):void 0},result:function(){return this.__winner__?this.victory(this.__winner__):this.__turns__<1?this.draw():null},next:function(a){var b=this.activePlayer(),c=this.opponent(b);switch(a[b]){case"win":return new this.constructor(this.__turns__-1,c,b);case"lose":return new this.constructor(this.__turns__-1,c,c);case"pass":return new this.constructor(this.__turns__-1,c)}throw new Error("Invalid move "+a[b]+" for player "+b+".")},__serialize__:function(){return[this.name,this.__turns__,this.activePlayer(),this.__winner__]}}),games.ConnectionGame=declare(Game,{height:9,width:9,lineLength:5,constructor:function(a,b){Game.call(this,a),this.board=b instanceof CheckerboardFromString?b:new CheckerboardFromString(this.height,this.width,(b||".".repeat(this.height*this.width))+"")},name:"ConnectionGame",players:["First","Second"],__lines__:function(){function a(a,c,d){var e=a+"x"+c+"/"+d;if(!b.hasOwnProperty(e)){var f=new CheckerboardFromString(a,c,".".repeat(a*c));b[e]=f.lines().map(function(a){return a.toArray()},function(a){return a.length>=d}).toArray()}return b[e]}var b={};return a.CACHE=b,a}(),result:function(){if(this.hasOwnProperty("__result__"))return this.__result__;for(var a=this.lineLength,b=this.board.asStrings(this.__lines__(this.height,this.width,a)).join(" "),c=0;c<this.players.length;++c)if(b.indexOf(c.toString(36).repeat(a))>=0)return this.__result__=this.victory([this.players[c]]);return this.__result__=b.indexOf(".")<0?this.draw():null},moves:function(){return this.hasOwnProperty("__moves__")?this.__moves__:this.__moves__=this.result()?null:obj(this.activePlayer(),iterable(this.board.string).filter(function(a){return"."===a},function(a,b){return b}).toArray())},next:function(a){var b=this.activePlayer(),c=this.players.indexOf(b),d=+a[b],e=d/this.width>>0,f=d%this.width;return new this.constructor((c+1)%this.players.length,this.board.place([e,f],c.toString(36)))},toHTML:function(){var a=this.moves(),b=this.activePlayer(),c=this.board,d=this.width;return a=a&&a[b],"<table>"+c.horizontals().reverse().map(function(e){return"<tr>"+e.map(function(e){var f="",g=c.square(e),h=e[0]*d+e[1];return a&&a.indexOf(h)>=0&&(f=' data-ludorum="move: '+h+", activePlayer: '"+b+"'\""),"."===g?"<td "+f+">&nbsp;</td>":'<td class="ludorum-player'+g+'" '+f+">&#x25CF;</td>"}).join("")+"</tr>"}).join("")+"</table>"},__serialize__:function(){return[this.name,this.activePlayer(),this.board.string]}}),games.OddsAndEvens=declare(Game,{constructor:function(a,b){Game.call(this,this.players),this.turns=isNaN(a)?1:+a,this.points=b||{Evens:0,Odds:0}},name:"OddsAndEvens",players:["Evens","Odds"],moves:function(){return this.turns<1?null:{Evens:[1,2],Odds:[1,2]}},result:function(){var a=this.points.Evens-this.points.Odds;return this.turns>0?null:{Evens:+a,Odds:-a}},next:function(a){raiseIf("number"!=typeof a.Evens||"number"!=typeof a.Odds,"Invalid moves "+(JSON.stringify(a)||a)+"!");var b=!((a.Evens+a.Odds)%2);return new this.constructor(this.turns-1,{Evens:this.points.Evens+(b?1:0),Odds:this.points.Odds+(b?0:1)})},__serialize__:function(){return[this.name,this.turns,this.points]}}),games.TicTacToe=declare(Game,{constructor:function(a,b){Game.call(this,a),this.board=b||"_________"},name:"TicTacToe",players:["Xs","Os"],result:function(){return function(){return this.board.match(this.WIN_X)?this.victory(["Xs"]):this.board.match(this.WIN_O)?this.victory(["Os"]):this.board.indexOf("_")<0?this.draw():null}}(),moves:function(){if(this.result())return null;var a={};return a[this.activePlayer()]=iterable(this.board).filter(function(a){return"_"===a},function(a,b){return b}).toArray(),a},next:function(a){var b=this.activePlayer(),c=+a[b];if("_"!==this.board.charAt(c))throw new Error("Invalid move "+JSON.stringify(a)+" for board "+this.board+" (moves= "+JSON.stringify(a)+").");var d=this.board.substring(0,c)+b.charAt(0)+this.board.substring(c+1);return new this.constructor(this.opponent(b),d)},toString:function(){var a=this.board;return[a.substr(0,3).split("").join("|"),"-+-+-",a.substr(3,3).split("").join("|"),"-+-+-",a.substr(6,3).split("").join("|")].join("\n")},toHTML:function(){var a=this.activePlayer(),b=this.board.split("").map(function(b,c){return"_"===b?'<td data-ludorum="move: '+c+", activePlayer: '"+a+"'\">&nbsp;</td>":"<td>"+b+"</td>"});return"<table><tr>"+[b.slice(0,3).join(""),b.slice(3,6).join(""),b.slice(6,9).join("")].join("</tr><tr>")+"</tr></table>"},__serialize__:function(){return[this.name,this.activePlayer(),this.board]},"static heuristics":{heuristicFromWeights:function(a){function b(b,d){var e=d.charAt(0);return iterable(b.board).map(function(b,c){return"_"===b?0:a[c]*(b===e?1:-1)}).sum()/c}var c=iterable(a).map(Math.abs).sum();
return b.weights=a,b}},"":function(){var a=new CheckerboardFromString(3,3,"_".repeat(9)),b=a.sublines(a.lines(),3);this.prototype.WIN_X=new RegExp(a.asRegExps(b,"X",".")),this.prototype.WIN_O=new RegExp(a.asRegExps(b,"O","."))}}),games.TicTacToe.heuristics.defaultHeuristic=games.TicTacToe.heuristics.heuristicFromWeights([2,1,2,1,5,1,2,1,2]),games.ToadsAndFrogs=declare(Game,{constructor:function b(a,c){Game.call(this,a),this.board=c||b.board()},"static board":function(a,b){return a=isNaN(a)?3:+a,b=isNaN(b)?2:+b,"T".repeat(a)+"_".repeat(b)+"F".repeat(a)},name:"ToadsAndFrogs",players:["Toads","Frogs"],result:function(){return this.moves()?null:this.defeat()},moves:function(){var a=this.activePlayer(),b={},c=b[a]=[];return this.board.replace(a==this.players[0]?/TF?_/g:/_T?F/g,function(a,b){return c.push(b),a}),c.length>0?b:null},next:function(a){var b=this.activePlayer(),c=a[b],d=(b.charAt(0),this.board);if("T_"==d.substr(c,2))d=d.substring(0,c)+"_T"+d.substring(c+2);else if("_F"==d.substr(c,2))d=d.substring(0,c)+"F_"+d.substring(c+2);else if("TF_"==d.substr(c,3))d=d.substring(0,c)+"_FT"+d.substring(c+3);else{if("_TF"!=d.substr(c,3))throw new Error("Invalid move ",c," for board <",d,">.");d=d.substring(0,c)+"FT_"+d.substring(c+3)}return new this.constructor(this.opponent(),d)},__serialize__:function(){return[this.name,this.activePlayer,this.board]}}),games.Mancala=declare(Game,{constructor:function(a,b){Game.call(this,a),this.board=b||this.makeBoard()},makeBoard:function(a,b){a=isNaN(a)?4:+a,b=isNaN(b)?6:+b;for(var c=[],d=0;2>d;d++){for(var e=0;b>e;e++)c.push(a);c.push(0)}return c},name:"Mancala",players:["North","South"],emptyCapture:!1,countRemainingSeeds:!0,store:function(a){switch(this.players.indexOf(a)){case 0:return this.board.length/2-1;case 1:return this.board.length-1;default:throw new Error("Invalid player "+a+".")}},houses:function(a){switch(this.players.indexOf(a)){case 0:return Iterable.range(0,this.board.length/2-1).toArray();case 1:return Iterable.range(this.board.length/2,this.board.length-1).toArray();default:throw new Error("Invalid player "+a+".")}},oppositeHouse:function(a,b){var c=this.houses(a),d=this.houses(this.opponent(a)),e=c.indexOf(b);return 0>e?e:d.reverse()[e]},nextSquare:function(a,b){do b=(b+1)%this.board.length;while(b===this.store(this.opponent(a)));return b},moves:function(){if(this.result())return null;var a=this.board,b={},c=this.activePlayer();return b[c]=this.houses(c).filter(function(b){return a[b]>0}),b[c].length>0?b:null},scores:function(){var a=this,b=this.board,c=this.players.map(function(c){return iterable(a.houses(c)).map(function(a){return b[a]}).sum()});if(c[0]>0&&c[1]>0)return null;var d={};return this.players.forEach(function(e,f){d[e]=b[a.store(e)]+a.countRemainingSeeds*c[f]}),d},result:function(){var a=this.scores(),b=this.players;return a&&this.zerosumResult(a[b[0]]-a[b[1]],b[0])},next:function(a){var b,c,d=this.activePlayer(),e=+a[d],f=this.board.slice(0),g=f[e],h=!1;for(raiseIf(1>g,"Invalid move ",e," for game ",this),f[e]=0;g>0;g--)e=this.nextSquare(d,e),f[e]++;return h=e==this.store(d),h||(c=this.oppositeHouse(d,e),c>=0&&1==f[e]&&f[c]>0&&(b=this.store(d),f[b]++,f[e]=0,this.emptyCapture||(f[b]+=f[c],f[c]=0))),new this.constructor(h?d:this.opponent(),f)},resultBounds:function(){var a=iterable(this.board).sum();return[-a,+a]},__serialize__:function(){return[this.name,this.activePlayer(),this.board.slice()]},identifier:function(){return this.activePlayer().charAt(0)+this.board.map(function(a){return("00"+a.toString(36)).substr(-2)}).join("")},toString:function(){var a=this,b=base.Text.lpad,c=this.players[0],d=this.houses(c).map(function(c){return b(""+a.board[c],2,"0")}).reverse(),e=b(""+this.board[this.store(c)],2,"0"),f=this.players[1],g=this.houses(f).map(function(c){return b(""+a.board[c],2,"0")}),h=b(""+this.board[this.store(f)],2,"0");return"   "+d.join(" | ")+"   \n"+e+" ".repeat(2*d.length+3*(d.length-1)+2)+h+"\n   "+g.join(" | ")+"   "},toHTML:function(){function a(a,c){return!b||!b[a]||!b[a].indexOf(c)<0?"<td>"+this.board[c]+"</td>":'<td data-ludorum="move:'+c+", activePlayer: '"+a+"'\">"+this.board[c]+"</td>"}var b=this.moves(),c=this.players[0],d=this.players[1];return'<table><tr><td rowspan="2">'+this.board[this.store(c)]+"</td>"+this.houses(c).map(a.bind(this,c)).reverse().join("")+'<td rowspan="2">'+this.board[this.store(d)]+"</td></tr><tr>"+this.houses(d).map(a.bind(this,d)).join("")+"</tr></table>"},"static heuristics":{heuristicFromWeights:function(a){function b(b,d){var e,f=0;switch(b.players.indexOf(d)){case 0:e=1;break;case 1:e=-1;break;default:throw new Error("Invalid player "+d+".")}return iterable(b.board).map(function(b,c){return f+=b,b*a[c]}).sum()/c/f*e}var c=iterable(a).map(Math.abs).sum();return b.weights=a,b}},"":function(){this.makeBoard=this.prototype.makeBoard,this.heuristics.defaultHeuristic=this.heuristics.heuristicFromWeights([1,1,1,1,1,1,5,-1,-1,-1,-1,-1,-1,-5])}}),games.Pig=declare(Game,{constructor:function(a,b,c,d){Game.call(this,a),this.goal=isNaN(b)?100:+b,this.__scores__=c||iterable(this.players).zip([0,0]).toObject(),this.__rolls__=d||[]},name:"Pig",players:["One","Two"],moves:function(){if(!this.result()){var a=this.activePlayer(),b=this.__scores__[a]+iterable(this.__rolls__).sum();return obj(a,b<this.goal?["roll","hold"]:["hold"])}},result:function(){var a=this.__scores__[this.players[0]],b=this.__scores__[this.players[1]];if(a>=this.goal||b>=this.goal){var c={};return c[this.players[0]]=a-b,c[this.players[1]]=-c[this.players[0]],c}},next:function(a){var b=this.activePlayer(),c=a[b];if("hold"===c){var d=copy(this.__scores__);return d[b]+=iterable(this.__rolls__).sum(),new this.constructor(this.opponent(),this.goal,d,[])}if("roll"===c){var e=this;return new aleatories.Dice(function(a){return a=isNaN(a)?this.value():+a,a>1?new e.constructor(b,e.goal,e.__scores__,e.__rolls__.concat(a)):new e.constructor(e.opponent(),e.goal,e.__scores__,[])})}throw new Error("Invalid moves: "+JSON.stringify(a))},__serialize__:function(){return[this.name,this.activePlayer(),this.goal,this.__scores__,this.__rolls__]}}),games.ConnectFour=declare(games.ConnectionGame,{height:6,width:7,lineLength:4,name:"ConnectFour",players:["Yellow","Red"],moves:function(){var a=null;if(!this.result()){for(var b=[],c=this.board.string,d=(this.height-1)*this.width,e=0;e<c.length;++e)"."===c.charAt(d+e)&&b.push(e);b.length>0&&(a={},a[this.activePlayer()]=b)}return a},next:function(a){for(var b=this.activePlayer(),c=this.board.string,d=+a[b],e=this.height,f=this.width,g=0;e>g;++g)if("."===c.charAt(g*f+d))return new this.constructor(this.opponent(),this.board.place([g,d],b===this.players[0]?"0":"1"));throw new Error("Invalid move "+JSON.stringify(a)+"!")},toHTML:function(){var a=this.moves(),b=this.activePlayer(),c=this.board;return a=a&&a[b],"<table><colgroup>"+"<col/>".repeat(this.board.width)+"</colgroup>"+c.horizontals().reverse().map(function(d){return"<tr>"+d.map(function(d){var e="",f=c.square(d);return a&&a.indexOf(d[1])>=0&&(e=' data-ludorum="move: '+d[1]+", activePlayer: '"+b+"'\""),"."===f?"<td "+e+">&nbsp;</td>":'<td class="ludorum-player'+f+'" '+e+">&#x25CF;</td>"}).join("")+"</tr>"}).join("")+"</table>"},__serialize__:function(){return[this.name,this.activePlayer(),this.board.string]}}),games.Mutropas=declare(Game,{allPieces:Iterable.range(9).toArray(),name:"Mutropas",players:["Left","Right"],constructor:function(a){Game.call(this,this.players),a=a||{},this._pieces=a.pieces||this.dealtPieces(a.random),this._scores=a.scores||obj(this.players[0],0,this.players[1],0)},result:function(){var a=this.players[0];return this._pieces[a].length<1?copy({},this._scores):null},moves:function(){var a=this.players[0],b=this.players[1];return this.result()?null:obj(a,this._pieces[a].slice(),b,this._pieces[b].slice())},next:function(a){var b=this.players[0],c=this.players[1],d=a[b],e=a[c];raiseIf(this._pieces[b].indexOf(d)<0,"Invalid move "+JSON.stringify(d)+" for player "+b+"! (moves= "+JSON.stringify(a)+")"),raiseIf(this._pieces[c].indexOf(e)<0,"Invalid move "+JSON.stringify(e)+" for player "+c+"! (moves= "+JSON.stringify(a)+")");var f=this.moveResult(d,e),g=this._pieces[b].slice(),h=this._pieces[c].slice();return g.splice(g.indexOf(d),1),h.splice(h.indexOf(e),1),new this.constructor({pieces:obj(b,g,c,h),scores:obj(b,this._scores[b]+f,c,this._scores[c]-f)})},__serialize__:function(){return[this.name,{pieces:this._pieces,scores:this._scores}]},dealtPieces:function(a){var a=a||Randomness.DEFAULT,b=this.allPieces.length>>1,c=a.split(b,this.allPieces),d=a.split(b,c[1]);return obj(this.players[0],c[0],this.players[1],d[0])},moveResult:function(a,b){var c=iterable(this.allPieces).max(0)+1;return b>a?c>>1>=b-a?1:-1:a>b?a-b>=(c>>1)+1?1:-1:0}}),games.Othello=declare(Game,{constructor:function(a,b){if(Game.call(this,a),this.board=this.makeBoard.apply(this,b||[]),!this.moves()){var c=this.opponent();this.moves(c)&&(this.activePlayers=[c])}},makeBoard:function(a,b,c){return a=isNaN(a)?8:+a,b=isNaN(b)?8:+b,raiseIf(4>a||4>b||a%2||b%2,"An Othello board must have even dimensions greater than 3."),"string"==typeof c?new CheckerboardFromString(a,b,c):new CheckerboardFromString(a,b).__place__([a/2,b/2-1],"W").__place__([a/2-1,b/2],"W").__place__([a/2,b/2],"B").__place__([a/2-1,b/2-1],"B")},name:"Othello",players:["Black","White"],lines:function(a){return function(b,c){var d=b+"x"+c,e=a[d];return"undefined"==typeof e&&(e=a[d]=new utils.Checkerboard(b,c).lines().map(function(a){return a.toArray()},function(a){return a.length>2}).toArray()),e}}({}),__MOVE_REGEXPS__:{Black:[/\.W+B/g,/BW+\./g],White:[/\.B+W/g,/WB+\./g]},moves:function(a){if(!a&&this.__moves__)return this.__moves__;a=a||this.activePlayer();var b=this.board,c={},d=this.__MOVE_REGEXPS__[a];this.lines(b.height,b.width).forEach(function(a){d.forEach(function(d){b.asString(a).replace(d,function(b,d){var e="."===b.charAt(0)?a[d]:a[b.length-1+d];return c[e]=e,b})})});var e=[];for(var f in c)e.push(c[f]);return this.__moves__=e.length>0?obj(a,e):null},next:function(a){var b,c,d=this.board.clone(),e=this.activePlayer();if(!a.hasOwnProperty(e)||!d.isValidCoord(a[e]))throw new Error("Invalid moves "+JSON.stringify(a)+"!");return e==this.players[0]?(b="B",c=/^W+B/):(b="W",c=/^B+W/),d.walks(a[e],Checkerboard.DIRECTIONS.EVERY).forEach(function(a){var e=c.exec(d.asString(a).substr(1));e&&a.toArray().slice(0,e[0].length).forEach(function(a){d.__place__(a,b)})}),new this.constructor(this.opponent(),[d.height,d.width,d.string])},result:function(){if(this.moves())return null;var a={W:-1,B:1},b=iterable(this.board.string).map(function(b){return a[b]||0}).sum();return this.zerosumResult(b,"Black")},resultBounds:function(){var a=this.board.width*this.board.height;return[-a,+a]},__serialize__:function(){var a=this.board;return[this.name,this.activePlayer(),[a.height,a.width,a.string]]},toHTML:function(){var a=this.moves(),b=this.activePlayer(),c=this.board;return a=a&&a[b].map(JSON.stringify),"<table>"+c.horizontals().reverse().map(function(d){return"<tr>"+d.map(function(d){switch(c.square(d)){case"B":return'<td class="ludorum-square-Black">&nbsp;</td>';case"W":return'<td class="ludorum-square-White">&nbsp;</td>';default:var e=JSON.stringify(d);return a&&a.indexOf(e)>=0?'<td class="ludorum-square-move" data-ludorum="move: '+e+", activePlayer: '"+b+"'\">&nbsp;</td>":'<td class="ludorum-square-empty">&nbsp;</td>'}}).join("")+"</tr>"}).join("")+"</table>"},"static heuristics":{heuristicFromWeights:function(a){var b=a.length,c=iterable(a).map(Math.abs).sum();a=iterable(a).map(function(a){return a/(c+1)});var d=function(c,d){var e=c.board;return raiseIf(e.height*e.width!==b,"Wrong amount of weights!"),e.weightedSum(a,{W:"W"===d.charAt(0)?1:-1,B:"B"===d.charAt(0)?1:-1})};return d.weights=a.toArray(),d},heuristicFromSymmetricWeights:function(a,b,c){b=isNaN(b)?8:0|b,c=isNaN(c)?8:0|c;var d=Math.ceil(b/2);return raiseIf(d*Math.ceil(c/2)>a.length,"Not enough weights!"),a=Iterable.range(c).map(function(e){var f=c/2>e?e:c-e-1,g=f*d,h=(f+1)*d;return a.slice(g,h).concat(a.slice(g,h-b%2).reverse())}).flatten().toArray(),this.heuristicFromWeights(a)}}}),games.Othello.makeBoard=games.Othello.prototype.makeBoard,games.Bahab=declare(Game,{initialBoard:["BBABB","BBBBB",".....","bbbbb","bbabb"].join(""),name:"Bahab",players:["Uppercase","Lowercase"],constructor:function(a,b){Game.call(this,a),this.board=b instanceof CheckerboardFromString?b:new CheckerboardFromString(5,5,b||this.initialBoard)},__PLAYER_PIECES_RE__:{Uppercase:/[AB]/g,Lowercase:/[ab]/g},result:function(){var a=this.board.string;return a.match(/^[.bAB]+$|[A].{0,4}$/)?this.defeat(this.players[1]):a.match(/^[.Bab]+$|^.{0,4}[a]/)?this.defeat(this.players[0]):null},moves:function(){var a=this.activePlayer(),b=this.__PLAYER_PIECES_RE__[a],c=this.board,d=[];return c.string.replace(b,function(a,e){var f,g=[e/5|0,e%5];switch(a){case"A":f=[[1,-1],[1,0],[1,1]];break;case"B":f=[[1,-1],[1,1]];break;case"a":f=[[-1,-1],[-1,0],[-1,1]];break;case"b":f=[[-1,-1],[-1,1]]}return iterable(f).forEachApply(function(e,f){var h=[g[0]+e,g[1]+f],i=c.square(h);!c.isValidCoord(h)||i.match(b)||"b"==a.toLowerCase()&&"a"==i.toLowerCase()||d.push([g,h])}),a}),d.length>0?obj(a,d):null},next:function(a){if(!a)throw new Error("Invalid moves "+a+"!");var b=this.activePlayer(),c=a[b];if(!Array.isArray(a[b]))throw new Error("Invalid moves "+JSON.stringify(a)+"!");return new this.constructor(this.opponent(),this.board.move(c[0],c[1]))},__serialize__:function(){return[this.name,this.activePlayer(),this.board.string]},toHTML:function(){var a=(this.moves(),this.activePlayer(),this.board);return"<table>"+a.horizontals().reverse().map(function(b){return"<tr>"+b.map(function(b){var c=a.square(b);switch(c){case"A":case"B":return'<td class="ludorum-square-Uppercase">'+c+"</td>";case"a":case"b":return'<td class="ludorum-square-Lowercase">'+c+"</td>";default:return'<td class="ludorum-square-empty">&nbsp;</td>'}}).join("")+"</tr>"}).join("")+"</table>"}}),games.Colograph=declare(Game,{constructor:function(a){Game.call(this,a?a.activePlayer:void 0),initialize(this,a).object("colours",{defaultValue:{}}).array("edges",{defaultValue:[[1,3],[2],[3],[]]}).array("shapes",{defaultValue:["circle","triangle","square","star"]}).number("scoreSameShape",{defaultValue:-1,coerce:!0}).number("scoreDifferentShape",{defaultValue:-1,coerce:!0})},name:"Colograph",players:["Red","Blue"],__serialize__:function(){return[this.name,this.activePlayer(),{colours:this.colours,edges:this.edges,shapes:this.shapes,scoreSameShape:this.scoreSameShape,scoreDifferentShape:this.scoreDifferentShape}]},score:function(){var a={},b=this.shapes,c=this.colours,d=this.scoreSameShape,e=this.scoreDifferentShape,f=this.edges.length;return this.players.forEach(function(b){a[b]=f}),iterable(this.edges).forEach(function(f,g){f.forEach(function(f){var h=g+","+f;c.hasOwnProperty(h)&&(a[c[h]]+=b[g]===b[f]?d:e)})}),a},result:function(){if(this.moves())return null;var a=this.score(),b=this.players;return this.zerosumResult(a[b[0]]-a[b[1]],b[0])},moves:function(){for(var a=(this.colours,[]),b=0;b<this.edges.length;b++)this.colours.hasOwnProperty(b)||a.push(b);return a.length<1?null:obj(this.activePlayer(),a)},next:function(a){var b=this.activePlayer(),c=+a[b]>>0;raiseIf(0>c||c>=this.colours.length,"Invalid move: node ",c," does not exist in ",this,"."),raiseIf(this.colours[c]>=0,"Invalid move: node ",c," has already been coloured in ",this,".");var d=copy(obj(c,b),this.colours);return this.edges[c].forEach(function(a){d[a]===b&&(d[c+","+a]=b)}),this.edges.forEach(function(a,e){e!==c&&a.indexOf(c)>=0&&d[e]===b&&(d[e+","+c]=b)}),new this.constructor({activePlayer:this.opponent(b),colours:d,edges:this.edges,shapes:this.shapes,scoreSameShape:this.scoreSameShape,scoreDifferentShape:this.scoreDifferentShape})},edgeColour:function(a,b){var c=this.edges[a].indexOf(b)>=0||this.edges[b].indexOf(a)>=0,d=this.colours[a],e=this.colours[b];return c&&d>=0&&d===e?d:-1},"static heuristics":{scoreDifference:function(a,b){var c=a.score(),d=0;for(var e in c)d+=e===b?c[e]:-c[e];return d/a.edges.length/2}},"static randomGraph":function(a,b,c){a=Math.max(2,+a>>0),b=Math.max(a-1,+b>>0);for(var d,e,f=basis.iterables.range(a-1).map(function(b){return c.split(1,basis.iterables.range(b+1,a).toArray())}).toArray(),g=b-(a-1);g>0;g--)d=c.choice(f),d[1].length>0&&(e=c.split(1,d[1]),d[0].push(e[0][0]),d[1]=e[1],g--);return f=f.map(function(a){return a[0]}),f.push([]),f},"static randomGame":function(){params=base.initialize({},params).object("random",{defaultValue:randomness.DEFAULT}).integer("nodeCount",{defaultValue:8,coerce:!0}).integer("edgeCount",{defaultValue:11,coerce:!0}).integer("shapeCount",{defaultValue:4,coerce:!0,minimum:1,maximum:4}).subject;var a=["circle","triangle","square","star"];return new Colograph({edges:this.randomGraph(params.nodeCount,params.edgeCount,params.random),shapes:params.random.randoms(params.nodeCount,0,params.shapeCount).map(function(b){return a[0|b]}),scoreSameShape:1})},"static KineticUI":declare(UserInterface,{constructor:function(a){UserInterface.call(this,a),initialize(this,a).string("container",{defaultValue:"colograph-container"}).object("Kinetic",{defaultValue:window.Kinetic}).integer("canvasRadius",{defaultValue:0/0,coerce:!0}).integer("nodeRadius",{defaultValue:15,coerce:!0}).array("playerColours",{defaultValue:["red","blue"]}),isNaN(this.canvasRadius)&&(this.canvasRadius=.6*Math.min(screen.width,screen.height)>>1);var b=this.stage=new Kinetic.Stage({container:this.container,width:2*this.canvasRadius,height:2*this.canvasRadius}),c=this.layer=new Kinetic.Layer({clearBeforeDraw:!0,offsetX:-this.canvasRadius,offsetY:-this.canvasRadius}),d=this.match.state();b.add(c),setInterval(b.draw.bind(b),1e3/30),c.destroyChildren(),this.edges={},this.nodes={},this.drawEdges(d),this.drawNodes(d)},drawEdges:function(a){var b=2*Math.PI/a.edges.length,c=this.canvasRadius-2*this.nodeRadius,d=this;a.edges.forEach(function(a,e){a.forEach(function(a){var f=new d.Kinetic.Line({points:[c*Math.cos(b*e),c*Math.sin(b*e),c*Math.cos(b*a),c*Math.sin(b*a)],stroke:"black",strokeWidth:2});d.edges[e+","+a]=f,d.layer.add(f)})})},drawNodes:function(a){var b=2*Math.PI/a.edges.length,c=this.canvasRadius-2*this.nodeRadius,d=this;a.edges.forEach(function(e,f){var g,h=c*Math.cos(b*f),i=c*Math.sin(b*f);switch(a.shapes[f]){case"square":g=d.drawSquare(h,i,d.nodeRadius,f);break;case"triangle":g=d.drawTriangle(h,i,d.nodeRadius,f);break;case"star":g=d.drawStar(h,i,d.nodeRadius,f);break;default:g=d.drawCircle(h,i,d.nodeRadius,f)}g.on("mouseover",function(){g.setScale(1.2)}),g.on("mouseout",function(){g.setScale(1)}),g.on("click tap",function(){d.perform(f)}),g.setRotation(2*Math.random()*Math.PI),d.nodes[f]=g,d.layer.add(g)})},drawCircle:function(a,b,c){return new this.Kinetic.Circle({x:a,y:b,radius:c,fill:"white",stroke:"black",strokeWidth:2})},drawSquare:function(a,b,c){return new this.Kinetic.Rect({x:a,y:b,width:2*c,height:2*c,offsetX:c,offsetY:c,fill:"white",stroke:"black",strokeWidth:2})},drawStar:function(a,b,c){return new Kinetic.Star({numPoints:5,x:a,y:b,innerRadius:.6*c,outerRadius:1.5*c,fill:"white",stroke:"black",strokeWidth:2})},drawTriangle:function(a,b,c){return new Kinetic.RegularPolygon({sides:3,x:a,y:b,radius:1.25*c,fill:"white",stroke:"black",strokeWidth:2})},display:function(a){this.updateEdges(a),this.updateNodes(a)},updateEdges:function(a){var b=this;a.edges.forEach(function(c,d){c.forEach(function(c){var e=d+","+c;b.edges[e].setStroke(a.colours[e]||"black")})})},updateNodes:function(a){var b=this;a.edges.forEach(function(c,d){var e=a.colours[d];e&&(b.nodes[d].setFill(e),b.nodes[d].off("mouseover mouseout click tap"))})}})}),tournaments.RoundRobin=declare(Tournament,{constructor:function(a,b,c){Tournament.call(this,a,b),this.matchCount=isNaN(c)?a.players.length:+c,this.__advance__=this.__matches__().chain(Iterable.repeat(null)).__iter__()},__matches__:function(){var a=this.game,b=iterable(this.players);return b=b.product.apply(b,Iterable.repeat(this.players,a.players.length-1).toArray()),b.filter(function(a){for(var b=1;b<a.length;b++)for(var c=0;b>c;c++)if(a[b]===a[c])return!1;return!0}).product(Iterable.range(this.matchCount)).map(function(b){return new Match(a,b[0])})}}),tournaments.Measurement=declare(Tournament,{constructor:function(a,b,c,d){Tournament.call(this,a,Array.isArray(b)?b:[b]),this.opponents=Array.isArray(c)?c:[c],raiseIf(this.opponents.length<a.players.length-1,"Not enough opponents."),this.matchCount=isNaN(d)?a.players.length:+d,this.__advance__=this.__matches__().chain(Iterable.repeat(null)).__iter__()},__matches__:function(){var a=this.game,b=a.players.length,c=iterable(this.opponents);return c=b>2?c.product.apply(c,Iterable.repeat(this.opponents,b-2).toArray()):c.map(function(a){return[a]}),iterable(this.players).product(Iterable.range(b),c,Iterable.range(this.matchCount)).map(function(b){var c=b[2].slice(0);return c.splice(b[1],0,b[0]),new Match(a,c)})}}),tournaments.Elimination=declare(Tournament,{constructor:function(a,b,c){Tournament.call(this,a,b),this.matchCount=isNaN(c)?1:+c>>0},__bracket__:function(a){var b=this.game,c=this.matchCount,d=this.game.players.length;return a=a||this.players,a.length<d?[]:Iterable.range(0,a.length,d).map(function(e){var f=Iterable.range(e,e+d).map(function(b){return a[b%a.length]}).toArray();return Iterable.range(c).map(function(){return f.unshift(f.pop()),new Match(b,f)}).toArray()}).toArray()},__playoff__:function(a){var b={},c={};a.forEach(function(a){var d=a.result();if(!d)throw new Error("Unfinished match in playoff!");iterable(a.players).forEach(function(a){var e=a[0],f=a[1].name;b[f]=(+b[f]||0)+d[e],c[f]=a[1]})});var d=iterable(b).greater(function(a){return a[1]})[0][0];return c[d]},__advance__:function(){if(!this.__matches__||this.__matches__.length<1){if(this.__currentBracket__){if(this.__currentBracket__.length<1)return null;var a=this.__currentBracket__.map(this.__playoff__);this.__currentBracket__=this.__bracket__(a)}else this.__currentBracket__=this.__bracket__(this.players);this.__matches__=iterable(this.__currentBracket__).flatten().toArray()}return this.__matches__.shift()}}),exports});
//# sourceMappingURL=ludorum.min.js.map