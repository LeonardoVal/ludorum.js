//! ludorum 0.2.2-alpha

(function(t){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat"],t):"object"==typeof exports&&module.exports?module.exports=t(require("creatartis-base"),require("sermat")):this.ludorum=t(this.base,this.Sermat)}).call(this,function t(e,n){"use strict";var i,r=e.objects.unimplemented,s=e.obj,a=e.copy,o=e.raise,u=e.raiseIf,c=e.declare,h=e.Iterable,l=e.iterable,_=e.Future,f=e.Randomness,p=e.initialize,d=e.Statistics,m=e.Events,v={__package__:"ludorum",__name__:"ludorum",__init__:t,__dependencies__:[e,n],__SERMAT__:{include:[e]}},y=v.aleatories={},g=v.games={},b=v.players={},w=v.tournaments={},A=v.utils={},P=v.Game=c({constructor:function(t){this.activatePlayers(t)},name:"?",players:[],moves:r("Game","moves()"),next:r("Game","next(moves, haps, update)"),result:r("Game","result()"),scores:function(){return this.results()},view:function(t){return this},isActive:function(){for(var t=0;t<arguments.length;t++)if(this.activePlayers.indexOf(arguments[t])<0)return!1;return!0},activePlayer:function(){var t=this.activePlayers.length;return u(t<1,"There are no active players!"),u(t>1,"More than one player is active!"),this.activePlayers[0]},activatePlayers:function(t){return this.activePlayers=t?Array.isArray(t)?t:[t]:[this.players[0]]},opponents:function(t){return t=t||this.activePlayers,this.players.filter(function(e){return t.indexOf(e)<0})},opponent:function(t){var e=this.players.indexOf(t||this.activePlayer());return this.players[(e+1)%this.players.length]},perform:function(){for(var t,e={},n=0;n<arguments.length;n+=2)void 0===(t=arguments[n+1])&&(t=this.activePlayer()),e[t]=arguments[n];return this.next(e)},possibleMoves:function(t){if(!(t=arguments.length<1?this.moves():t)||"object"!=typeof t)return[];var e=Object.keys(t);if(1===e.length){var n=e[0];return t[n].map(function(t){return s(n,t)})}return h.product.apply(h,l(t).mapApply(function(t,e){return e.map(function(e){return[t,e]})}).toArray()).map(function(t){return l(t).toObject()}).toArray()},contingent:function(t,e,n){return new M(this,t,e,n)},randomNext:function(t,e){var n=this.moves(),i={};return this.activePlayers.forEach(function(e){i[e]=t.choice(n[e])}),{state:this.next(i,null,e),moves:i}},resultBounds:function(){return[-1,1]},normalizedResult:function(t){var n;if((t=t||this.result())&&"object"==typeof t){for(var i in n=this.resultBounds(),t=e.copy(t))t[i]=(t[i]-n[0])/(n[1]-n[0])*2-1;return t}return"number"==typeof t?(+t-(n=this.resultBounds())[0])/(n[1]-n[0])*2-1:null},zerosumResult:function(t,e){e=e?Array.isArray(e)?e:[e]:this.activePlayers;var n=-(t=+t/(e.length||1))/(this.players.length-e.length||1);return l(this.players).map(function(i){return[i,e.indexOf(i)<0?n:t]}).toObject()},victory:function(t,e){return this.zerosumResult(e||1,t)},defeat:function(t,e){return this.zerosumResult(e||-1,t)},tied:function(t,e){return e=+(e||0),l(t||this.players).map(function(t){return[t,e]}).toObject()},isZeroSum:!0,isDeterministic:!1,isSimultaneous:!1,__hash__:function(){return n.hashCode(this).toString(36)},clone:function(){return n.clone(this)},toString:function(){return n.ser(this)},"static make":function(t){return(t=a({},t)).hasOwnProperty("name")||"function"!=typeof t.constructor||(t.name=t.constructor.name),u("string"!=typeof t.name||!t.name,"A game must have a `name`!"),u(!Array.isArray(t.players),"A game must have `players`!"),c(this,t)},"static cacheProperties":function(){var t=this;return Array.prototype.slice.call(arguments).forEach(function(e){var n="__"+e+"$cache__",i=t.prototype[e];t.prototype[e]=function(){return arguments.length>0?i.apply(this,arguments):(this.hasOwnProperty(n)||(this[n]=i.call(this)),this[n])}}),t},"static serialized":function(t){var e=t.prototype.moves,n=t.prototype.next;return c(t,{moves:function(){for(var t,n=this.__fixedMoves__||(this.__fixedMoves__={}),i=e.call(this),r=0;r<this.activePlayers.length;r++)if(n.hasOwnProperty(this.activePlayers[r])){t=this.activePlayers[r];break}return t&&i?s(t,i[t]):null},next:function(t){var e,i=a({},this.fixedMoves||{},t);return l(this.players).all(function(t){return i.hasOwnProperty(t)})?(e=n.call(this,i)).fixedMoves={}:(e=this.clone()).fixedMoves=i,e}})}}),E=v.Player=c({constructor:(i=0,function(t){var e=Object.getPrototypeOf(this);p(this,t).string("name",{defaultValue:"Player"+i++,coerce:!0}).object("random",{defaultValue:e.random})}),random:f.DEFAULT,decision:function(t,e){return this.movesFor(t,e)[0]},movesFor:function(t,e){var n=t.moves();return u(!n||!n[e]||n[e].length<1,"Player ",e," has no moves for game ",t,"."),n[e]},isCompatibleWith:function(t){return!0},participate:function(t,e){return this},"static make":function(t){return c(this,t)},"dual playTo":function(t){var e=this,n=t.players.map(function(t){return"function"==typeof e?new e:e});return new x(t,n)},"static __SERMAT__":{identifier:"Player",serializer:function(t){return[{name:t.name}]}},toString:function(){return n.ser(this)}}),x=v.Match=c({constructor:function(t,e){for(var n in this.game=t,this.players=Array.isArray(e)?l(t.players).zip(e).toObject():e,this.history=[{state:t}],this.events=new m({events:["begin","next","end","quit"]}),this.players)this.players[n]=this.players[n].participate(this,n)||this.players[n]},ply:function(){return this.history.length-1},state:function(t){return t=isNaN(t)?this.ply():+t<0?this.ply()+ +t:+t,this.history[0|t].state},result:function(){return this.state().result()},decisions:function(t){t=t||this.state();var e=this.players,n=t.activePlayers;return _.all(n.map(function(n){return e[n].decision(t.view(n),n)})).then(function(t){return l(n).zip(t).toObject()})},run:function(t){if((t=isNaN(t)?1/0:+t)<1)return _.when(this);var e,n=this.ply(),i=this.state();if(n<1&&this.onBegin(i),e=(i=this.__advanceContingents__(i)).result())return this.onEnd(i,e),_.when(this);var r=this;return this.decisions(i).then(function(e){return r.__advance__(i,e)?r.run(t-1):r})},__advanceContingents__:function(t){for(var e,n;t.isContingent;)e=t.randomHaps(),this.history[this.history.length-1].haps=e,n=t.next(e),this.history.push({state:n}),this.onNext(t,null,e,n),t=n;return t},__advance__:function(t,e){var n=this;if(!l(t.activePlayers).all(function(t){var i=e[t];return"function"!=typeof i.__command__||i.__command__(n,t)}))return!1;var i=t.next(e);return this.history[this.history.length-1].moves=e,this.history.push({state:i}),this.onNext(t,e,null,i),!0},"static commands":{Quit:c({__command__:function(t,e){return t.onQuit(t.state(),e),!1}})},onBegin:function(t){this.events.emit("begin",t,this),this.logger&&this.logger.info("Match begins with ",l(this.players).map(function(t){return t[1]+" as "+t[0]}).join(", "),"; for ",t,".")},onNext:function(t,e,n,i){this.events.emit("next",t,e,n,i,this),this.logger&&this.logger.info("Match advances from ",t," to ",i)},onEnd:function(t,e){this.events.emit("end",t,e,this),this.logger&&this.logger.info("Match for ",t,"ends with ",JSON.stringify(e))},onQuit:function(t,e){this.events.emit("quit",t,e,this),this.logger&&this.logger.info("Match for ",t," aborted because player "+e+" quitted.")},"static randomMatch":function(t,n){n=n||{};var i=b.RandomPlayer.playTo(t);return n.log&&("object"==typeof n.log?i.logger=n.log:(i.logger=new e.Logger("string"==typeof n.log?n.log:"Match"),i.logger.appendToConsole())),i},toString:function(){return n.ser(this)},"static __SERMAT__":{identifier:"Match",serializer:function(t){return[t.game,t.players,t.history]},materializer:function(t,e){if(e){var n=new x(e[0],e[1]);return n.history=e[2],n}return null}}}),M=v.Contingent=c({isContingent:!0,constructor:function(t,e,n,i){this.state=t,this.moves=e,this.haps=n,this.update=!!i},next:function(t){return this.state.next(this.moves,t||this.randomHaps(),this.update)},randomHaps:function(t){return l(this.haps).mapApply(function(e,n){return[e,n.randomValue(t)]}).toObject()},randomNext:function(t){return this.next(this.randomHaps(t))},possibleHaps:function(){return h.product.apply(h,l(this.haps).mapApply(function(t,e){return e.distribution().mapApply(function(e,n){return[t,e,n]})}).toArray()).map(function(t){var e=1;return[l(t).mapApply(function(t,n,i){return e*=i,[t,n]}).toObject(),e]}).toArray()},expectedEvaluation:function(t,e,n){var i=this,r=!1,s=this.possibleHaps().map(function(s){var a=i.next(s[0]),o=a.isContingent?a.expectedEvaluation(t,e,n):e(a,t);return r=r||_.__isFuture__(o),_.then(o,function(t){return s.push(t),s})});return _.then(r?_.all(s):s,n||function(t){var e=0;return t.forEach(function(t){e+=t[1]*t[2]}),e})},toString:function(){return n.ser(this)},"static __SERMAT__":{identifier:"Contingent",serializer:function(t){return[t.state,t.moves,t.haps]}}}),N=v.Tournament=c({constructor:function(t,e){this.game=t,this.players=Array.isArray(e)?e:iterables.iterable(e).toArray(),this.statistics=new d,this.events=new m({events:["begin","beforeMatch","afterMatch","end"]})},__advance__:r("Tournament","__advance__"),run:function(){this.onBegin();var t=this;return _.doWhile(function(){return _.then(t.__advance__(),function(e){return e?(t.beforeMatch(e),t.__runMatch__(e).then(function(e){return t.account(e),t.afterMatch(e),e})):null})}).then(this.onEnd.bind(this))},__runMatch__:function(t){return t.run()},account:function(t){var e=this.game,n=t.result(),i=this.statistics;u(!n,"Match doesn't have results. Has it finished?"),l(t.players).forEach(function(r){var s=r[0],a=r[1],o=n[r[0]];i.add({key:"results",game:e.name,role:s,player:a.name},o),i.add({key:o>0?"victories":o<0?"defeats":"draws",game:e.name,role:s,player:a.name},o),i.add({key:"length",game:e.name,role:s,player:a.name},t.ply()),t.history.forEach(function(t){var e=t.state;if("function"==typeof e){var n=e.moves();n&&n.hasOwnProperty(s)&&n[s].length>0&&i.add({key:"width",game:e.name,role:s,player:a.name},n[s].length)}})})},onBegin:function(){this.events.emit("begin",this),this.logger&&this.logger.info("Tournament begins for game ",game.name,".")},beforeMatch:function(t){this.events.emit("beforeMatch",t,this),this.logger&&this.logger.debug("Beginning match with ",JSON.stringify(t.players),".")},afterMatch:function(t){this.events.emit("afterMatch",t,this),this.logger&&this.logger.debug("Finishing match with ",JSON.stringify(t.players),".")},onEnd:function(){this.events.emit("end",this.statistics,this),this.logger&&this.logger.info("Tournament ends for game ",game.name,":\n",this.statistics,"\n")},toString:function(){return n.ser(this)},"static __SERMAT__":{identifier:"Tournament",serializer:function(t){return[t.game,t.players]}}}),S=A.Checkerboard=c({constructor:function(t,e){isNaN(t)||(this.height=0|t),isNaN(e)||(this.width=0|e)},emptySquare:null,isValidCoord:function(t){return Array.isArray(t)&&!isNaN(t[0])&&!isNaN(t[1])&&t[0]>=0&&t[0]<this.height&&t[1]>=0&&t[1]<this.width},coordinates:function(){return h.range(this.height).product(h.range(this.width))},square:r("utils.Checkerboard","square"),isEmptySquare:function(t){return this.square(t)===this.emptySquare},horizontals:function(){var t=this.width;return h.range(this.height).map(function(e){return h.range(t).map(function(t){return[e,t]})})},verticals:function(){var t=this.height;return h.range(this.width).map(function(e){return h.range(t).map(function(t){return[t,e]})})},orthogonals:function(){return this.horizontals().chain(this.verticals())},positiveDiagonals:function(){var t=this.width,e=this.height,n=e+t-1;return h.range(n).map(function(t){var i=Math.max(0,e-t-1),r=Math.max(0,t-e+1);return h.range(Math.min(t+1,n-t)).map(function(t){return[i+t,r+t]})})},negativeDiagonals:function(){var t=this.width,e=this.height,n=e+t-1;return h.range(n).map(function(t){var i=Math.min(t,e-1),r=Math.max(0,t-e+1);return h.range(Math.min(t+1,n-t)).map(function(t){return[i-t,r+t]})})},diagonals:function(){return this.positiveDiagonals().chain(this.negativeDiagonals())},lines:function(){return this.orthogonals().chain(this.diagonals())},sublines:function(t,e){return l(t).map(function(t){return Array.isArray(t)?t:l(t).toArray()},function(t){return t.length>=e}).map(function(t){return h.range(0,t.length-e+1).map(function(n){return t.slice(n,n+e)})}).flatten()},walk:function(t,e){var n=this;return new h(function(){var i=t.slice();return function(){if(n.isValidCoord(i)){var t=i.slice();return i[0]+=e[0],i[1]+=e[1],t}throw h.STOP_ITERATION}})},walks:function(t,e){var n=this;return e.map(function(e){return n.walk(t,e)})},"static DIRECTIONS":{HORIZONTAL:[[0,-1],[0,1]],VERTICAL:[[-1,0],[1,0]],ORTHOGONAL:[[0,-1],[0,1],[-1,0],[1,0]],DIAGONAL:[[-1,-1],[-1,1],[1,-1],[1,1]],EVERY:[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[-1,1],[1,-1],[1,1]]},clone:r("utils.Checkerboard","clone"),__place__:r("utils.Checkerboard","place"),place:function(t,e){return this.clone().__place__(t,e)},__move__:function(t,e,n){return this.__place__(e,this.square(t)).__place__(t,void 0===n?this.emptySquare:n)},move:function(t,e,n){return this.clone().__move__(t,e,n)},__swap__:function(t,e){var n=this.square(e);return this.__place__(e,this.square(t)).__place__(t,n)},swap:function(t,e){return this.clone().__swap__(t,e)},transform:function(t){var e=this.clone(),n=this;return this.coordinates().forEach(function(i){var r=t.apply(n,[n,i].concat(i));e.__place__(r,n.square(i))}),e},horizontalSymmetry:function(){return this.transform(function(t,e,n,i){return[n,t.width-i-1]})},verticalSymmetry:function(){return this.transform(function(t,e,n,i){return[t.height-n-1,i]})},clockwiseRotation:function(){return this.transform(function(t,e,n,i){return[i,t.height-n-1]})},counterClockwiseRotation:function(){return this.transform(function(t,e,n,i){return[t.width-i-1,n]})},renderAsHTMLTable:function(t,n,i){var r=this,s=t.createElement("table");return n.appendChild(s),r.horizontals().reverse().forEach(function(n){var a=t.createElement("tr");s.appendChild(a),n.forEach(function(n){var s=r.square(n),o=t.createElement("td"),u={id:"ludorum-square-"+n.join("-"),className:"ludorum-square",square:s,coord:n,innerHTML:e.Text.escapeXML(s)};i&&(u=i(u)||u),o["ludorum-data"]=u,o.id=u.id,o.className=u.className,o.innerHTML=u.innerHTML,u.onclick&&(o.onclick=u.onclick),a.appendChild(o)})}),s},weightedSum:function(t,e){var n=this;return this.coordinates().zip(t).mapApply(function(t,i){return e[n.square(t)]*i||0}).sum()}}),T=A.CheckerboardFromString=c(S,{constructor:function(t,e,n,i){if(S.call(this,t,e),i&&i!==this.emptySquare&&(this.emptySquare=(i+"").charAt(0)),n&&n.length!==t*e)throw new Error("Given string "+JSON.stringify(n)+" does not match board dimensions.");this.string=n||this.emptySquare.repeat(t*e)},emptySquare:".",toString:function(){var t=this.string,e=this.height,n=this.width;return h.range(e).map(function(i){return t.substr((e-i-1)*n,n)}).join("\n")},square:function(t,e){var n=t[0],i=t[1],r=this.width;return n>=0&&n<this.height&&i>=0&&i<r?this.string.charAt(n*r+i):e},asString:function(t){var e=this;return t.map(function(t){return e.square(t)}).join("")},asStrings:function(t){var e=this;return t.map(function(t){return e.asString(t)})},asRegExp:function(t,e,n){n=n||".";var i=this.width,r=h.repeat(!1,i*this.height).toArray();t.forEach(function(t){r[t[0]*i+t[1]]=!0});for(var s,a="",o=0,u=0;u<r.length;o=0){s=r[u];do{++o}while(++u<r.length&&r[u]===s);a+=o<2?s?e:n:(s?e:n)+"{"+o+"}"}return a},asRegExps:function(t,e,n){var i=this;return t.map(function(t){return i.asRegExp(t,e,n)}).join("|")},clone:function(){return new this.constructor(this.height,this.width,this.string,this.hasOwnProperty("emptySquare")?this.emptySquare:void 0)},__place__:function(t,e){u(!this.isValidCoord(t),"Invalid coordinate ",t,"."),e=(e+this.emptySquare).charAt(0);var n=t[0]*this.width+t[1];return this.string=this.string.substr(0,n)+e+this.string.substr(n+1),this},"static __SERMAT__":{identifier:"CheckerboardFromString",serializer:function(t){var e=[t.height,t.width,t.string];return t.hasOwnProperty("emptySquare")&&e.push(t.emptySquare),e}}});A.CheckerboardFromPieces=c(S,{constructor:function(t,n,i,r){S.call(this,t,n);var s=this;r!==this.emptySquare&&(this.emptySquare=r),Array.isArray(i)?(this.pieces={},l(i||[]).forEach(function(t){u(!Array.isArray(t.position),"Piece has not a position (",t,")!"),s.pieces[t.position+""]=t})):"object"==typeof i?this.pieces=e.copy({},i):o("Invalid pieces definition: ",i,"!")},emptySquare:null,toString:function(){return"["+l(this.pieces).select(1).join(", ")+"]"},square:function(t,e){return this.pieces[t]||e},clone:function(){return new this.constructor(this.height,this.width,this.pieces,this.emptySquare)},__place__:function(t,e){u(!this.isValidCoord(t),"Invalid coordinate ",t,"!");var n=t+"";return delete this.pieces[n],e&&(this.pieces[n]=e),this},"static __SERMAT__":{identifier:"CheckerboardFromPieces",serializer:function(t){var e=[t.height,t.width,t.pieces];return t.hasOwnProperty("emptySquare")&&e.push(t.emptySquare),e}}});v.utils.Scanner=c({constructor:function(t){p(this,t).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:f.DEFAULT}).object("statistics",{defaultValue:new d})},scan:function(t){var e=this,n=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),i=0;return _.whileDo(function(){return n.length>0&&i<e.maxLength},function(){return _.all(n.map(function(n){return e.__advance__(t,n,i)})).then(function(t){return n=l(t).flatten().sample(e.maxWidth,e.random).toArray(),++i})}).then(function(){return e.statistics.add({key:"aborted"},n.length),e.statistics})},scans:function(){return _.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(t,e,n){if(e instanceof I)return l(e.distribution()).mapApply(function(t,n){return e.next(t)});if(this.account(t,e,n))return h.EMPTY;var i=e.moves(),r=this.statistics;return _.all(e.activePlayers.map(function(n){if(t&&t[n]){var s=t[n],a=r.stat({key:"decision.time",game:e.name,role:n,player:s.name});return a.startTime(),_.when(s.decision(e,n)).then(function(t){return a.addTime(),[[n,t]]})}return i[n].map(function(t){return[n,t]})})).then(function(t){return h.product.apply(h,t).map(function(t){return e.next(l(t).toObject())})})},account:function(t,e,n){var i=e.result(),r=this.statistics;if(i)return l(e.players).forEach(function(s){var a=i[s],o=t&&t[s]?t[s].name:"";e.name;r.add({key:"game.result",game:e.name,role:s,player:o},a,e),r.add({key:"game.length",game:e.name,role:s,player:o},n,e),a<0?(r.add({key:"defeat.result",game:e.name,role:s,player:o},a,e),r.add({key:"defeat.length",game:e.name,role:s,player:o},n,e)):a>0?(r.add({key:"victory.result",game:e.name,role:s,player:o},a,e),r.add({key:"victory.length",game:e.name,role:s,player:o},n,e)):r.add({key:"draw.length",game:e.name,role:s,player:o},n,e)}),!0;var s=e.moves();return l(e.activePlayers).forEach(function(t){r.add({key:"game.width",game:e.name,role:t},s[t].length)}),!1}}),A.Cache=c({constructor:function(t){this.clear(),t&&this.root(t)},stateIdentifier:function(t){return t.identifier()},moveIdentifier:function(t){return JSON.stringify(t)},has:function(t){var e="string"==typeof t?t:this.stateIdentifier(t);return this.__entries__.hasOwnProperty(e)},get:function(t){var e="string"==typeof t?t:this.stateIdentifier(t);return this.__entries__[e]},size:function(){return Object.keys(this.__entries__).length},entry:function(t,e){if(e=e||this.stateIdentifier(t),this.has(e))return this.get(e);var n={id:e,state:t,precursors:[],descendants:{}};return this.__entries__[e]=n,n},descendant:function(t,e){var n=this.moveIdentifier(e),i=t.descendants;if(i.hasOwnProperty(n))return i[n][1];var r=t.state.next(e),s=this.stateIdentifier(r),a=this.get(s)||this.entry(r,s);return i[n]=[e,a],a.precursors.push([e,t]),a},descendants:function(t){var e=this.descendant.bind(this,t);return arguments.length>1?Array.prototype.slice.call(arguments,1).map(e):t.state.possibleMoves().map(e)},clear:function(){this.__entries__={},this.__root__=null},root:function(t){if(arguments.length>0){var e=this.stateIdentifier(t);this.__root__=this.get(e)||this.entry(t,e),this.prune(e)}return this.__root__},prune:function(t){for(var e,n=[t||this.__root__.id],i={};t=n.shift();)i.hasOwnProperty(t)||(e=this.get(t),i[t]=e,n.push.apply(n,l(e.descendants).mapApply(function(t,e){return e[1][t]}).toArray()));return this.__entries__=i}});var C=A.GameTree=c({constructor:function(t){this.parent=t&&t.parent,this.state=t&&t.state,this.transition=t&&t.transition,this.probability=t&&+t.probability,this.children=t&&t.children,this.state&&!this.children&&(this.children=this.possibleTransitions())},possibleTransitions:function(){var t=this.state,e=this.constructor,n=this;return u(!t,"GameTree node has no state!"),t.isContingent?t.possibleHaps().map(function(t){return new e({parent:n,transition:t[0],probability:t[1]})}):t.possibleMoves().map(function(t){return new e({parent:n,transition:t})})},childrenCount:function(){return this.children||(this.children=this.possibleTransitions()),this.children.length},__expandChild__:function(t){if(!t.state)try{t.state=t.parent.state.next(t.transition)}catch(e){o("Node expansion for ",t.parent.state," with ",JSON.stringify(t.transition)," failed with: ",e)}return t},expand:function(t){return u(t<0||t>=this.childrenCount(),"Cannot expand children ",t,"!"),this.__expandChild__(this.children[t])},expandRandom:function(t){return t=t||f.DEFAULT,this.expand(t.randomInt(this.childrenCount()))},expandAll:function(){for(var t=0,e=this.childrenCount;t<e;t++)this.__expandChild__(this.children[t]);return this.children},toString:function(){return"GameTree("+this.state+")"},"static __SERMAT__":{identifier:"GameTree",serializer:function(t){return[{parent:t.parent,state:t.state,transition:t.transition,probability:t.probability,children:t.children}]}}});b.RandomPlayer=c(E,{constructor:function(t){E.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).object("random",{defaultValue:e.random})},random:f.DEFAULT,decision:function(t,e){return u(t.isContingent,"Contingent game state has no moves!"),this.random.choice(this.movesFor(t,e))},"static __SERMAT__":{identifier:"RandomPlayer",serializer:function(t){return this.serializeAsProperties(t,["name","random"])}}}),b.TracePlayer=c(E,{constructor:function(t){E.call(this,t),this.trace=l(t.trace),this.__iter__=this.trace.__iter__(),this.__decision__=this.__iter__()},decision:function(t,e){try{this.__decision__=this.__iter__()}catch(t){h.prototype.catchStop(t)}return this.__decision__},"static __SERMAT__":{identifier:"TracePlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t);return e[0].trace=t.trace.toArray(),e}}});var O=b.HeuristicPlayer=c(E,{constructor:function(t){E.call(this,t);Object.getPrototypeOf(this);p(this,t).func("heuristic",{ignore:!0})},moveEvaluation:function(t,e,n){var i=this;if(Object.keys(t).length<2)return this.stateEvaluation(e.next(t),n);var r=0,o=0;return t=a(s(n,[t[n]]),t),e.possibleMoves(t).forEach(function(t){r+=i.stateEvaluation(e.next(t),n),++o}),o>0?r/o:0},stateEvaluation:function(t,e){if(t.isContingent)return t.expectedEvaluation(e,this.stateEvaluation.bind(this));var n=t.result();return n?n[e]:this.heuristic(t,e)},heuristic:function(t,e){return this.random.random(-.5,.5)},evaluatedMoves:function(t,e){var n=this,i=!1;u(t.isContingent,"Contingent game state has no moves!");var r=this.possibleMoves(t,e).map(function(r){var s=n.moveEvaluation(r,t,e);return i=i||_.__isFuture__(s),_.then(s,function(t){return[r,t]})});return i?_.all(r):r},possibleMoves:function(t,e){var n=t.moves();return u(!n||!n[e]||!Array.isArray(n[e])||n[e].length<1,"Player "+e+" has no moves in "+t+" (moves= "+n+")!"),n[e].map(function(t){return a(s(e,t),n)})},bestMoves:function(t){return _.then(t,function(t){return l(t).greater(function(t){return t[1]}).map(function(t){return t[0]})})},decision:function(t,e){var n=this.random;return _.then(this.bestMoves(this.evaluatedMoves(t,e)),function(i){return u(!i||!i.length,"No moves where selected at ",t," for player ",e,"!"),n.choice(i)[e]})},"static composite":function(){var t=Array.prototype.slice.call(arguments);u(t.length<1,"HeuristicPlayer.composite() cannot take an odd number of arguments!");for(var e=0;e<t.length;e+=2)u("function"!=typeof t[e],"HeuristicPlayer.composite() argument ",e," (",t[e],") is not a function!"),t[e+1]=+t[e+1],u(isNaN(t[e+1])||t[e+1]<0||t[e+1]>1,"HeuristicPlayer.composite() argument ",e+1," (",t[e+1],") is not a valid weight!");return function(e,n){for(var i=0,r=0;r+1<t.length;r+=2)i+=t[r](e,n)*t[r+1];return i}},"static __SERMAT__":{identifier:"HeuristicPlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t),n=e[0];return t.hasOwnProperty("heuristic")&&(n.heuristic=t.heuristic),e}}}),R=(b.MaxNPlayer=c(O,{constructor:function(t){O.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).integer("horizon",{defaultValue:e.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(t){return!t.isSimultaneous&&t.isDeterministic},stateEvaluation:function(t,e){if(!t.isContingent)return this.maxN(t,e,0)[e];o("MaxNPlayer.stateEvalution() does not support contingent game states!")},heuristics:function(t){var e={},n=this;return t.players.forEach(function(i){e[i]=n.heuristic(t,i)}),e},quiescence:function(t,e,n){var i=t.result();return i||(n>=this.horizon?this.heuristics(t):null)},maxN:function(t,e,n){var i=this.quiescence(t,e,n);if(!i){var r,a,o=t.activePlayer(),u=this.movesFor(t,o);if(i={},u.length<1)throw new Error("No moves for unfinished game "+t+".");for(var c=0;c<u.length;++c)a=t.next(s(o,u[c])),(r=this.maxN(a,e,n+1))[o]>(i[o]||-1/0)&&(i=r)}return i},"static __SERMAT__":{identifier:"MaxNPlayer",serializer:function(t){var e=O.__SERMAT__.serializer(t);return e[0].horizon=t.horizon,e}}}),b.MiniMaxPlayer=c(O,{constructor:function(t){O.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).integer("horizon",{defaultValue:e.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(t){return!t.isSimultaneous},stateEvaluation:function(t,e,n){return this.minimax(t,e,0,n)},quiescence:function(t,e,n){var i=t.result();return i?i[e]:n>=this.horizon?this.heuristic(t,e):NaN},minimax:function(t,e,n,i){if(t.isContingent)return this.expectiMinimax(t,e,n,i);var r=this.quiescence(t,e,n);if(isNaN(r)){var a,o,u=t.activePlayer(),c=this.movesFor(t,u);if(c.length<1)throw new Error("No moves for unfinished game "+t+".");u==e?(r=-1/0,a=Math.max):(r=1/0,a=Math.min);for(var h=0;h<c.length;++h)o=t.next(s(u,c[h])),r=a(r,this.minimax(o,e,n+1,i))}if(i&&"function"==typeof i.hook){var l=i.hook(t,r);isNaN(l)||(r=l)}return r},expectiMinimax:function(t,e,n,i){if(t.isContingent){var r=this;return t.expectedEvaluation(e,function(t,e){return r.minimax(t,e,n+1,i)})}return this.minimax(t,e,n,i)},"static solution":function(t,e){var n=e&&e.evals||{},i=new this({horizon:1e8}),r=e.gameKey||function(t){return t.toString()};return i.minimax(t,t.activePlayer(),0,{hook:function(t,e){var i=r(t);u(n.hasOwnProperty(i)&&n[i]!==e,"Game ",t,"(key ",i,") has different values ",n[i]," and ",e,"!"),n[i]=e}}),n},"static __SERMAT__":{identifier:"MiniMaxPlayer",serializer:function(t){var e=O.__SERMAT__.serializer(t);return e[0].horizon=t.horizon,e}}}));b.AlphaBetaPlayer=c(R,{constructor:function(t){R.call(this,t)},stateEvaluation:function(t,e){return this.minimax(t,e,0,-1/0,1/0)},minimax:function(t,e,n,i,r){if(t.isContingent)return this.expectiMinimax(t,e,n,i,r);var a=this.quiescence(t,e,n);if(!isNaN(a))return a;var u,c=t.activePlayer(),h=c==e,l=this.movesFor(t,c);l.length<1&&o("No moves for unfinished game "+t+"!");for(var _=0;_<l.length&&(u=t.next(s(c,l[_])),a=this.minimax(u,e,n+1,i,r),h?i<a&&(i=a):r>a&&(r=a),!(r<=i));_++);return h?i:r},expectiMinimax:function(t,e,n,i,r){if(t.isContingent){var s=this;return t.expectedEvaluation(e,function(t,e){return s.minimax(t,e,n+1,i,r)})}return this.minimax(t,e,n)},"static __SERMAT__":{identifier:"AlphaBetaPlayer",serializer:function(t){return R.__SERMAT__.serializer(t)}}});var z=b.MonteCarloPlayer=c(O,{constructor:function(t){O.call(this,t);var e=Object.getPrototypeOf(this);if(p(this,t).number("simulationCount",{defaultValue:e.simulationCount,coerce:!0}).number("timeCap",{defaultValue:e.timeCap,coerce:!0}).number("horizon",{defaultValue:e.horizon,coerce:!0}),t)switch(typeof t.agent){case"function":this.agent=new O({heuristic:t.agent});break;case"object":this.agent=t.agent;break;default:this.agent=null}},simulationCount:30,timeCap:1e3,horizon:500,evaluatedMoves:function(t,e){u(t.isContingent,"MonteCarloPlayer cannot evaluate root contingent states!");for(var n=this,i=Date.now(),r=this.possibleMoves(t,e).map(function(n){return{move:n,nexts:Object.keys(n).length<2?[t.next(n)]:t.possibleMoves(a(s(e,[n[e]]),n)).map(function(e){return t.next(e)}),sum:0,count:0}}),o=0;!this.__finishMoveEvaluation__(o,i,r);)r.forEach(function(t){t.nexts=t.nexts.filter(function(i){var r=n.simulation(i,e);return t.sum+=r.result,++t.count,r.plies>0}),o++});return r.map(function(t){return u(isNaN(t.sum),"State evaluation is NaN for move ",t.move,"!"),[t.move,t.count>0?t.sum/t.count:0,t.count]})},__finishMoveEvaluation__:function(t,e,n){return t>this.simulationCount||e+this.timeCap<Date.now()},stateEvaluation:function(t,e){for(var n,i=0,r=this.simulationCount,s=0;s<r&&(i+=(n=this.simulation(t,e)).result[e],!(n.plies<1));++s);return r>0?i/r:0},quiescence:function(t,e,n){var i=t.result();return i?i[e]:n>=this.horizon?this.heuristic(t,e):NaN},simulation:function(t,e){var n,i={game:t};for(n=0;;++n)if(t.isContingent)t=t.randomNext(this.random);else{var r=this.quiescence(t,e,n+1);if(!isNaN(r))return i.result=r,i.plies=n,i;t=t.randomNext(this.random,n>0).state}o("Simulation ended unexpectedly for player ",e," in game ",t,"!")},"static __SERMAT__":{identifier:"MonteCarloPlayer",serializer:function(t){var e=O.__SERMAT__.serializer(t),n=e[0];return n.simulationCount=t.simulationCount,n.timeCap=t.timeCap,n.horizon=t.horizon,t.agent&&(n.agent=t.agent),e}}});b.UCTPlayer=c(z,{constructor:function(t){z.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).number("explorationConstant",{defaultValue:e.explorationConstant,coerce:!0})},explorationConstant:Math.sqrt(2),selectNode:function(t,e,n){return n=isNaN(n)?this.explorationConstant:+n,this.random.choice(l(t.children).greater(function(t){return(t.uct.rewards+t.uct.visits)/t.uct.visits/2+n*Math.sqrt(Math.log(e)/t.uct.visits)}))},evaluatedMoves:function(t,e){var n,i,r=new C({state:t}),s=Date.now();r.uct={pending:r.childrenCount(),visits:0,rewards:0};for(var a=0;!this.__finishMoveEvaluation__(a,s,r);a++){for(n=r;n.uct.pending<1&&n.childrenCount()>0;)n=this.selectNode(n,a+1,this.explorationConstant);for(n.uct.pending>0&&((n=n.expandRandom(this.random)).uct={pending:r.childrenCount(),visits:0,rewards:0}),i=this.simulation(n.state,e);n;n=n.parent)++n.uct.visits,n.uct.rewards+=t.normalizedResult(i.result)}return l(r.children).map(function(t){return t.uct?[t.transition,t.uct.rewards/t.uct.visits,t.uct.visits]:[t.transition,0,0]}).toArray()},"static __SERMAT__":{identifier:"UCTPlayer",serializer:function(t){var e=z.__SERMAT__.serializer(t);return e[0].explorationConstant=t.explorationConstant,e}}}),b.RuleBasedPlayer=c(E,{constructor:function(t){E.call(this,t),p(this,t).array("rules",{defaultValue:[]}).func("features",{ignore:!0})},features:function(t,e){return[t,e]},decision:function(t,e){for(var n=null,i=this.features(t,e),r=this.movesFor(t,e),s=0,a=this.rules.length;s<a;s++)if(null!==(n=this.rules[s].call(this,i))&&r.indexOf(n)>=0)return n;return this.random.choice(r)},rule:function(t){return u("function"!=typeof t,"A rule must be in the form of a function!"),this.rules.push(t),this},"static regExpRule":function(t,e){return function(n){return t.test(n)?e:null}},regExpRule:function(t,e){return this.rule(this.constructor.regExpRule(t,e))},"static __SERMAT__":{identifier:"RuleBasedPlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t),n=e[0];return n.rules=t.rules,t.hasOwnProperty("features")&&(n.features=t.features),e}}}),b.EnsemblePlayer=c(E,{constructor:function(t){E.call(this,t),p(this,t).array("players",{ignore:!0})},players:[],playerSelection:function(t,e){return this.players},decision:function(t,e){return this.randomDecision(t,e)},randomDecision:function(t,e,n){return n=n||this.playerSelection(t,e),u(n.length<1,"No player was selected!"),(1==n.length?n[0]:this.random.choice(n)).decision(t,e)},heuristicCombination:function(){function t(t,e,n,i){return l(e).sum()/e.length}return function(e){return e=e||t,function(t,n,i){var r=!1,s=this,a=(i=i||this.playerSelection(t,n)).map(function(e){u(!e.evaluatedMoves,"Cannot call `evaluatedMoves()` on player ",e.name,"(",e.constructor.name,")!");var i=e.evaluatedMoves(t,n);return r=r||_.__isFuture__(i),i});return r?_.all(a).then(function(i){return s.__bestAggregatedEvaluationMove__(t,n,e,i)}):s.__bestAggregatedEvaluationMove__(t,n,e,a)}}}(),__aggregateEvaluatedMoves__:function(t,e,n,i){var r=l(i).flatten().groupAll(function(t){return JSON.stringify(t[0])},function(t,e){return t?(t[1].push(e[1]),t):[e[0],[e[1]]]});return l(r).mapApply(function(i,r){return[r[0],n(r[0],r[1],t,e)]})},__bestAggregatedEvaluationMove__:function(t,e,n,i){var r=this.__aggregateEvaluatedMoves__(t,e,n,i);u(r.isEmpty(),"There are no evaluated moves for ",e," to choose from in ",t,"!");var s=O.prototype.bestMoves(r);return this.random.choice(s)[e]},"static parallelizeHeuristicPlayer":function(t,n){t=t||navigator.hardwareConcurrency;var i=e.Iterable.range(t).map(function(){return ludorum.players.WebWorkerPlayer.create(n)}),r=this;return e.Future.all(i.toArray()).then(function(t){var e=new r({players:t});return e.decision=e.heuristicCombination(),e})},"static __SERMAT__":{identifier:"EnsemblePlayer",serializer:function(t){return this.serializeAsProperties(t,["name","random","players"])}}});var k=b.UserInterfacePlayer=c(E,{constructor:function(t){E.call(this,t)},participate:function(t,e){return this.role=e,this},decision:function(t,e){return this.__future__&&this.__future__.isPending()&&this.__future__.resolve(new x.commands.Quit),this.__future__=new _,this.__future__},perform:function(t){var e=this.__future__;return e&&(this.__future__=null,e.resolve(t)),!!e}}),q=b.UserInterface=c({constructor:function(t){this.onBegin=this.onBegin.bind(this),this.onNext=this.onNext.bind(this),this.onEnd=this.onEnd.bind(this),t.match&&this.show(t.match)},show:function(t){this.match&&(t.events.off("begin",this.onBegin),t.events.off("next",this.onNext),t.events.off("end",this.onEnd)),this.match=t,t.events.on("begin",this.onBegin),t.events.on("next",this.onNext),t.events.on("end",this.onEnd)},onBegin:function(t){this.display(t)},onNext:function(t,e,n,i){this.display(i)},onEnd:function(t,e){this.results=e,this.display(t)},display:r("UserInterface","display"),perform:function(t,e){l(this.match.players).forEach(function(n){n[0];var i=n[1];i instanceof k&&(!e||i.role===e)&&i.perform(t)})}});q.BasicHTMLInterface=c(q,{constructor:function(t){q.call(this,t),this.document=t.document||e.global.document,this.container=t.container,"string"==typeof this.container&&(this.container=this.document.getElementById(this.container))},display:function(t){for(var e,n=this.container;e=n.firstChild;)n.removeChild(e);t.display(this)},build:function(t,e){var n=this;return e.forEach(function(e){var i;if(Array.isArray(e)){if(i=n.document.createElement(e[0]),e.length>2&&e[1]){var r=e[1];for(var s in r)attr.hasOwnProperty(s)&&i.setAttribute(s,r[s])}e.length>1&&e[e.length-1]&&n.build(i,e[e.length-1])}else"string"==typeof e&&(i=n.document.createTextNode(e));i&&t&&t.appendChild(i)}),t}});b.WebWorkerPlayer=c(E,{constructor:function(t){E.call(this,t),p(this,t).object("worker"),this.worker.onmessage=e.Parallel.prototype.__onmessage__.bind(this)},"static createWorker":function(t){u("string function".indexOf(typeof t.playerBuilder)<0,"Invalid player builder: "+t.playerBuilder+"!"),u(t.workerSetup&&"string function".indexOf(typeof t.workerSetup)<0,"Invalid worker setup: "+t.workerSetup+"!");var n=new e.Parallel,i=[v].concat(t.dependencies||[]);return _.sequence(i,function(t){return n.loadModule(t,!0)}).then(function(){return n.run((t.workerSetup?"("+t.workerSetup+")(),\n":"")+"self.PLAYER = ("+t.playerBuilder+').call(self),\n"OK"')}).then(function(){var t=n.worker;return t.__parallel__=n,t})},"static create":function(t){var e=this;return e.createWorker(t).then(function(t){return new e({name:name,worker:t})})},__newFuture__:function(t){var e=this.__future__;return e&&e.isPending()&&(e.hasOwnProperty("__cancelValue__")?e.resolve(e.__cancelValue__):e.reject("Canceled!")),e=new _,void 0!==t&&(e.__cancelValue__=t),this.__future__=e,e},__onmessage__:function(t){var e=this.__future__;e&&(e.hasOwnProperty("__cancelValue__")?e.resolve(e.__cancelValue__):e.reject("Canceled!")),this.__future__=null;try{var n=JSON.parse(t.data);n.error?e.reject(n.error):e.resolve(n.result)}catch(t){e.reject(t)}},__run__:function(t){var e=this.__newFuture__(x.commandQuit);return this.worker.postMessage(t),e},decision:function(t,e){return this.__run__("PLAYER.decision(Sermat.mat("+JSON.stringify(n.ser(t))+"),"+JSON.stringify(e)+")")},evaluatedMoves:function(t,e){return this.__run__("PLAYER.evaluatedMoves(Sermat.mat("+JSON.stringify(n.ser(t))+"),"+JSON.stringify(e)+")")}}),b.NewPlayer=c(O,{constructor:function(t){O.call(this,t)},evaluatedMoves:function(t,e){for(var n=this.possibleMoves(t,e).map(function(t){return{move:t,count:0,sum:0}}),i=this.randomlyComplete([{state:t}]),r=0;r<100;r++)this.accountResult(n,i,e),this.step(i,t.players[r%t.players.length],5);return this.accountResult(n,i,e),n.map(function(t){return u(isNaN(t.sum),"State evaluation is NaN for move ",t.move,"!"),[t.move,t.count>0?t.sum/t.count:0,t.count]})},step:function(t,e,n){var i=this,r=l(t).filter(function(t){return t.state.isActive(e)},function(t,e){return e}).toArray(),s=this.random.choices(n,r).map(function(e){return i.randomlyComplete(t.slice(0,e))}),a=l(s).greater(function(t){return t[t.length-1].result[e]});return this.random.choice(a)},randomlyComplete:function(t){var e,n=t[t.length-1];for(n.result=n.state.result();!n.result;)e=n.state.randomNext(this.random),n.moves=e.moves,n={state:e.state},t.push(n),n.result=n.state.result();return t},accountResult:function(t,e,n){var i=e[0],r=e[e.length-1].result;return count=0,t.forEach(function(t){l(i.activePlayers).all(function(e){return t.moves[e]==i.moves[e]})&&(count++,t.count++,t.sum+=r[n])}),count}});var B,j,I=v.aleatories.Aleatory=c({constructor:function(t){this.__distribution__=l(t).toArray(),u(this.__distribution__.length<1,"Aleatories must have at least one value!")},count:function(){return this.__distribution__.length},value:function(t){return this.__distribution__[t][0]},probability:function(t){return+this.__distribution__[t][1]},randomValue:function(t){return(t=t||f.DEFAULT).weightedChoice(this.__distribution__)},distribution:function(){var t=this;return h.range(this.count()).map(function(e){return[t.value(e),t.probability(e)]})},"static tries":function(t,n){var i=e.math.combinations;return n<=0?[[0,1]]:h.range(n+1).map(function(e){return[e,Math.pow(t,e)*Math.pow(1-t,n-e)*i(n,e)]}).toArray()},"static aggregate":function(t,e,n,i){var r=[];return n=n||function(t,e){return t+e},i=i||function(t,e){return t===e},h.product(t,e).forEachApply(function(t,e){for(var s=n(t[0],e[0]),a=0;a<r.length;a++)if(i(r[a][0],s))return void(r[a][1]+=t[1]*e[1]);r.push([s,t[1]*e[1]])}),r},"static __SERMAT__":{identifier:"Aleatory",serializer:function(t){return[t.distribution().toArray()]}}}),F=v.aleatories.DieAleatory=c(I,{constructor:function(t,e){1===arguments.length&&(e=t,t=1),this.min=0|t,this.max=0|e},count:function(){return this.max-this.min+1},value:function(t){return t>this.max-this.min?void 0:t+this.min},probability:function(t){return t>this.max-this.min?NaN:1/(this.max-this.min+1)},randomValue:function(t){return(t||f.DEFAULT).randomInt(this.min,this.max+1)},"static __SERMAT__":{identifier:"DiceAleatory",serializer:function(t){return[t.min,t.max]}}});return y.dice={D4:new F(4),D6:new F(6),D8:new F(8),D10:new F(10),D12:new F(12),D20:new F(20)},y.uniformAleatory=function(t){var e=1/(t=l(t).toArray()).length;return new I(t.map(function(t){return[t,e]}))},y.normalization=function(t){var e=0,n=[];return l(t).forEachApply(function(t,i){u(i<0,"aleatories.normalization: probabilities cannot be negative ("+i+")!"),e+=i;for(var r=0;r<n.length;r++)if(n[r][0]===t)return void(n[r][1]+=i);n.push([t,i])}),e>0&&n.forEach(function(t){t[1]/=e}),n},y.sumProbability=function(t,n,i){if(n|=0,i|=0,t|=0,isNaN(n)||isNaN(i)||isNaN(t)||n<1||i<2)return NaN;if(t<n||t>n*i)return 0;var r=e.math.factorial,s=r(n),a=s/n;return Math.pow(i,-n)*h.range(0,Math.floor((t-n)/i)+1).map(function(e){var o=s/r(e)/r(n-e),u=t-i*e-1,c=r(u)/a/r(u-n+1);return(e%2?-1:1)*o*c}).sum()},g.Predefined=c(P,{name:"Predefined",height:5,width:5,constructor:function(t,e,n,i){e&&(this.__results__=e,this.players=Object.keys(e)),P.call(this,t),isNaN(n)||(this.height=+n),isNaN(i)||(this.width=+i)},players:["A","B"],__results__:{A:0,B:0},moves:function(){if(this.height>0)return s(this.activePlayer(),h.range(1,this.width+1).toArray())},result:function(){return this.height>0?null:this.__results__},next:function(t,e,n){return u(e,"Haps are not required (given ",e,")!"),n?(this.height--,this.activatePlayers(this.opponent()),this):new this.constructor(this.opponent(),this.__results__,this.height-1,this.width)},"static __SERMAT__":{identifier:"Predefined",serializer:function(t){return[t.activePlayer(),t.__results__,t.height,t.width]}}}),g.Choose2Win=c(P,{constructor:function(t,e,n){P.call(this,e),this.__turns__=isNaN(t)?1/0:+t,this.__winner__=n},name:"Choose2Win",players:["This","That"],moves:function(){if(!this.__winner__&&this.__turns__>0)return s(this.activePlayer(),["win","lose","pass"])},result:function(){return this.__winner__?this.victory(this.__winner__):this.__turns__<1?this.draw():null},next:function(t,e,n){var i=this.activePlayer(),r=this.opponent(i);u(!t.hasOwnProperty(i),"No move for active player ",i," at ",this,"!"),u(e,"Haps are not required (given ",e,")!");var s={win:i,lose:r,pass:void 0},a=t[i];if(s.hasOwnProperty(a))return n?(this.activatePlayers(r),this.__turns__--,this.__winner__=s[a],this):new this.constructor(this.__turns__-1,r,s[a]);o("Invalid move ",t[i]," for ",i," at ",this,"!")},"static __SERMAT__":{identifier:"Choose2Win",serializer:function(t){var e=[t.__turns__,t.activePlayer()];return t.__winner__&&e.push(t.__winner__),e}}}),g.ConnectionGame=c(P,{name:"ConnectionGame",height:9,width:9,lineLength:5,constructor:function(t,e){P.call(this,t),this.board=e instanceof T?e:new T(this.height,this.width,e),this.height=this.board.height,this.width=this.board.width},players:["First","Second"],__lines__:function(){var t={};function e(e,n,i){var r=e+"x"+n+"/"+i;if(!t.hasOwnProperty(r)){var s=new T(e,n,".".repeat(e*n));t[r]=s.lines().map(function(t){return t.toArray()},function(t){return t.length>=i}).toArray()}return t[r]}return e.CACHE=t,e}(),result:function(){if(this.hasOwnProperty("__result__"))return this.__result__;for(var t=this.lineLength,e=this.board.asStrings(this.__lines__(this.height,this.width,t)).join(" "),n=0;n<this.players.length;++n)if(e.indexOf(n.toString(36).repeat(t))>=0)return this.__result__=this.victory([this.players[n]]);return e.indexOf(".")<0?this.__result__=this.tied():this.__result__=null},moves:function(){if(this.hasOwnProperty("__moves__"))return this.__moves__;if(this.result())this.__moves__=null;else{var t=this.board;this.__moves__=s(this.activePlayer(),t.coordinates().filter(function(e){return t.isEmptySquare(e)}).toArray())}return this.__moves__},next:function(t,e,n){u(e,"Haps are not required (given ",e,")!");var i=this.activePlayer(),r=this.players.indexOf(i),s=t[i],a=(r+1)%this.players.length,o=this.board.place(s,r.toString(36));return n?(this.activatePlayers(a),this.board=o,this):new this.constructor(a,o)},display:function(t){u(!(t&&t instanceof q.BasicHTMLInterface),"Unsupported UI!");var e=this.moves(),n=this.activePlayer(),i=this.board;e=e&&e[n];this.board.renderAsHTMLTable(t.document,t.container,function(r){r.className="."===r.square?"ludorum-empty":"ludorum-player"+r.square,r.innerHTML="."===r.square?"&nbsp;":"&#x25CF;";var s=r.coord[0]*i.height+r.coord[1];e&&e.indexOf(s)>=0&&(r.move=s,r.activePlayer=n,r.onclick=t.perform.bind(t,r.move,n))});return t},"static __SERMAT__":{identifier:"ConnectionGame",serializer:function(t){return[t.activePlayer(),t.board]}}}),g.OddsAndEvens=c(P,{name:"OddsAndEvens",constructor:function(t,e){P.call(this,this.players),this.turns=isNaN(t)?1:+t,this.points=e||{Evens:0,Odds:0}},isSimultaneous:!0,players:["Evens","Odds"],moves:function(){return this.turns<1?null:{Evens:[1,2],Odds:[1,2]}},result:function(){var t=this.points.Evens-this.points.Odds;return this.turns>0?null:{Evens:+t,Odds:-t}},next:function(t,e,n){u("number"!=typeof t.Evens||"number"!=typeof t.Odds,"Invalid moves ",t,"!"),u(e,"Haps are not required (given ",e,")!");var i=(t.Evens+t.Odds)%2==0,r={Evens:this.points.Evens+(i?1:0),Odds:this.points.Odds+(i?0:1)};return n?(this.turns--,this.points=r,this):new this.constructor(this.turns-1,r)},"static __SERMAT__":{identifier:"OddsAndEvens",serializer:function(t){return[t.turns,t.points]}}}),g.TicTacToe=c(P,{name:"TicTacToe",constructor:function(t,e){P.call(this,t),this.board=e||"_________"},players:["Xs","Os"],result:function(){return this.board.match(this.WIN_X)?this.victory(["Xs"]):this.board.match(this.WIN_O)?this.victory(["Os"]):this.board.indexOf("_")<0?this.tied():null},moves:function(){if(this.result())return null;var t={};return t[this.activePlayer()]=l(this.board).filter(function(t,e){return"_"===t},function(t,e){return e}).toArray(),t},next:function(t,e,n){u(e,"Haps are not required (given ",e,")!");var i=this.activePlayer(),r=+t[i];if(isNaN(r)||"_"!==this.board.charAt(r))throw new Error("Invalid move "+JSON.stringify(t)+" for board "+this.board+" (moves= "+JSON.stringify(t)+").");var s=this.board.substring(0,r)+i.charAt(0)+this.board.substring(r+1);return n?(this.activatePlayers(this.opponent(i)),this.board=s,this):new this.constructor(this.opponent(i),s)},"static __SERMAT__":{identifier:"TicTacToe",serializer:function(t){return[t.activePlayer(),t.board]}},__hash__:function(t){var e={_:0,X:1,O:2};return parseInt((t||this.board).split("").map(function(t){return e[t]}).join(""),3)},equivalent:(B="210543876 678345012 630741852 258147036 876543210 852741630 036147258".split(" ").map(function(t){return t.split("").map(function(t){return+t})}),j=function(){var t=this.board,e=B.map(function(e){return e.map(function(e){return t.charAt(e)}).join("")});return e.sort(),e},j.MAPPINGS=B,j),printBoard:function(){var t=this.board;return[0,3,6].map(function(e){return t.substr(0,3).split("").join("|")}).join("\n-+-+-\n")},"static heuristics":{heuristicFromWeights:function(t){var e=l(t).map(Math.abs).sum();function n(n,i){var r=i.charAt(0);return l(n.board).map(function(e,n){return"_"===e?0:t[n]*(e===r?1:-1)}).sum()/e}return n.weights=t,n}},"":function(){var t=new T(3,3,"_".repeat(9)),e=t.sublines(t.lines(),3);this.prototype.WIN_X=new RegExp(t.asRegExps(e,"X",".")),this.prototype.WIN_O=new RegExp(t.asRegExps(e,"O",".")),this.heuristics.defaultHeuristic=this.heuristics.heuristicFromWeights([2,1,2,1,5,1,2,1,2])}}),g.ToadsAndFrogs=c(P,{name:"ToadsAndFrogs",constructor:function t(e,n){P.call(this,e),this.board=n||t.board()},"static board":function(t,e){return t=isNaN(t)?3:+t,e=isNaN(e)?2:+e,"T".repeat(t)+"_".repeat(e)+"F".repeat(t)},players:["Toads","Frogs"],result:function(){return this.moves()?null:this.defeat()},moves:function(){var t=this.activePlayer(),e={},n=e[t]=[];return this.board.replace(t==this.players[0]?/TF?_/g:/_T?F/g,function(t,e){return n.push(e),t}),n.length>0?e:null},next:function(t,e,n){u(e,"Haps are not required (given ",e,")!");var i,r=this.activePlayer(),s=t[r],a=(r.charAt(0),this.board);if("T_"==a.substr(s,2))i=a.substring(0,s)+"_T"+a.substring(s+2);else if("_F"==a.substr(s,2))i=a.substring(0,s)+"F_"+a.substring(s+2);else if("TF_"==a.substr(s,3))i=a.substring(0,s)+"_FT"+a.substring(s+3);else{if("_TF"!=a.substr(s,3))throw new Error("Invalid move ",s," for board <",a,">.");i=a.substring(0,s)+"FT_"+a.substring(s+3)}return n?(this.activatePlayers(this.opponent()),this.board=i,this):new this.constructor(this.opponent(),i)},"static __SERMAT__":{identifier:"ToadsAndFrogs",serializer:function(t){return[t.activePlayer(),t.board]}},__hash__:function(t,e){var n={_:0,T:1,F:2};return t=(t||this.activePlayer()).charAt(0),e=e||this.board,parseInt((t+e).split("").map(function(t){return n[t]}).join(""),3)}}),g.Pig=c(P,{name:"Pig",constructor:function(t,e,n,i){P.call(this,t),this.goal=isNaN(e)?100:+e,this.__scores__=n||l(this.players).zip([0,0]).toObject(),this.__rolls__=i||[]},isDeterministic:!1,players:["One","Two"],moves:function(){if(!this.result()){var t=this.activePlayer(),e=this.__scores__[t]+l(this.__rolls__).sum();return s(t,this.__rolls__.length<1?["roll"]:e>=this.goal?["hold"]:["roll","hold"])}},result:function(){var t=this.__scores__[this.players[0]],e=this.__scores__[this.players[1]];if(t>=this.goal||e>=this.goal){var n={};return n[this.players[0]]=Math.min(this.goal,t)-Math.min(this.goal,e),n[this.players[1]]=-n[this.players[0]],n}},next:function(t,e,n){var i=this.activePlayer(),r=t&&t[i];u(!r,"No move for active player ",i," at ",this,"!");var s=this.opponent(),c=this.__scores__,h=[];if("hold"===r||"roll"===r){if("hold"===r)(c=a(c))[i]+=l(this.__rolls__).sum();else{var _=0|(e&&e.die);if(!_)return new M(this,t,{die:y.dice.D6},n);if(_>1)return s=i,h=this.__rolls__.concat(_),new this.constructor(i,this.goal,this.__scores__,this.__rolls__.concat(_))}return n?(this.activatePlayers(s),this.__scores__=c,this.__rolls__=h,this):new this.constructor(s,this.goal,c,h)}o("Invalid moves ",JSON.stringify(t)," at ",this,"!")},resultBounds:function(){return[-this.goal,+this.goal]},"static __SERMAT__":{identifier:"Pig",serializer:function(t){return[t.activePlayer(),t.goal,t.__scores__,t.__rolls__]}}}),g.Mutropas=c(P,{name:"Mutropas",players:["Left","Right"],constructor:function(t){P.call(this,this.players),t=t||{},this.playedPieces=t.playedPieces||[],this.pieces=t.pieces||this.dealPieces(t.random),this.__scores__=t.scores||s(this.players[0],0,this.players[1],0)},isDeterministic:!1,isSimultaneous:!0,allPieces:h.range(9).toArray(),dealPieces:function(t){t=t||f.DEFAULT;var e=this.allPieces.length/2|0,n=t.split(e,this.allPieces),i=t.split(e,n[1]);return s(this.players[0],n[0],this.players[1],i[0])},moves:function(){return this.result()?null:a({},this.pieces)},moveResult:function(t,e){var n=l(this.allPieces).max(0)+1;return t<e?e-t<=n/2?1:-1:t>e?t-e>=n/2+1?1:-1:0},next:function(t,e,n){var i=this.players[0],r=this.players[1];if(!this.pieces[i]||!this.pieces[r])return this.__viewNext__(t,e,n);var a=t[i],o=t[r],c=this.pieces;u(c[i].indexOf(a)<0,"Invalid move ",JSON.stringify(a)," for player ",i,"! (moves= ",JSON.stringify(t),")"),u(c[r].indexOf(o)<0,"Invalid move ",JSON.stringify(o)," for player ",r,"! (moves= ",JSON.stringify(t),")");var h=this.moveResult(a,o),l=this.playedPieces.concat([a,o]),_=s(i,c[i].filter(function(t){return t!==a}),r,c[r].filter(function(t){return t!==o})),f=s(i,this.__scores__[i]+h,r,this.__scores__[r]-h);return n?(this.playedPieces=l,this.pieces=_,this.__scores__=f,this):new this.constructor({playedPieces:l,pieces:_,scores:f})},__viewNext__:function(t,e,n){var i=this.pieces[this.players[0]]?this.players[0]:this.players[1],r=this.opponent(i);return e?new this.constructor({pieces:s(i,this.pieces[i],r,e[r]),playedPieces:this.playedPieces,scores:this.__scores__}).next(t,null,n):this.contingent(t,s(i,y.uniformAleatory(this.__possiblePieces__(r))),n)},scores:function(){return a({},this.__scores__)},result:function(){var t=this.players;if(this.playedPieces.length>=this.allPieces.length-1){var e=this.scores();return this.zerosumResult(e[t[0]]-e[t[1]],t[0])}return null},__possiblePieces__:function(t){var e=this.playedPieces,n=this.pieces[this.opponent(t)],i=l(this.allPieces).filter(function(t){return e.indexOf(t)<0&&n.indexOf(t)<0});return i.combinations(i.count()-1)},view:function(t){return new this.constructor({pieces:s(t,this.pieces[t]),playedPieces:this.playedPieces,scores:this.__scores__})},"static __SERMAT__":{identifier:"Mutropas",serializer:function(t){return[{pieces:t.pieces,playedPieces:t.playedPieces,scores:t.__scores__}]}}}),g.Bahab=c(P,{name:"Bahab",players:["Uppercase","Lowercase"],constructor:function(t,e){P.call(this,t),this.board=e instanceof T?e:new T(5,5,e||this.initialBoard)},initialBoard:["BBABB","BBBBB",".....","bbbbb","bbabb"].join(""),__PLAYER_ENDGAME_RE__:{Uppercase:/^[.Bab]+$|^.{0,4}[a]/,Lowercase:/^[.bAB]+$|[A].{0,4}$/},result:function(){for(var t,e=this.board.string,n=0;n<2;++n)if(t=this.players[n],e.match(this.__PLAYER_ENDGAME_RE__[t]))return this.defeat(t);return this.moves()?null:this.defeat(this.activePlayer())},__PLAYER_PIECES_RE__:{Uppercase:/[AB]/g,Lowercase:/[ab]/g},moves:function(){var t=this.activePlayer(),e=this.__PLAYER_PIECES_RE__[t],n=this.board,i=[];return n.string.replace(e,function(t,r){var s,a=[r/5|0,r%5];switch(t){case"A":s=[[1,-1],[-1,0],[1,1]];break;case"B":s=[[1,-1],[1,1]];break;case"a":s=[[-1,-1],[1,0],[-1,1]];break;case"b":s=[[-1,-1],[-1,1]]}return l(s).forEachApply(function(r,s){var o=[a[0]+r,a[1]+s],u=n.square(o);!n.isValidCoord(o)||u.match(e)||"."!=u&&t.toLowerCase()!=u.toLowerCase()||i.push([a,o])}),t}),i.length>0?s(t,i):null},next:function(t,e,n){u(e,"Haps are not required (given ",e,")!"),u(!t,"Invalid moves ",t,"!");var i=this.activePlayer(),r=t[i];u(!Array.isArray(t[i]),"Invalid moves ",t,"!");var s=this.board.move(r[0],r[1]);return n?(this.activatePlayers(this.opponent()),this.board=s,this):new this.constructor(this.opponent(),s)},"static __SERMAT__":{identifier:"Bahab",serializer:function(t){return[t.activePlayer(),t.board]}}}),g.Puzzle15=c(P,{name:"Puzzle15",players:["Player"],width:4,height:4,target:"0123456789ABCDE ",maxMoves:81,constructor:function(t){P.call(this,this.players[0]),t=t||{},this.board=t.board||this.randomBoard(),this.moveNumber=0|t.moveNumber},randomBoard:function(t,e,n,i){return t=0|t||this.width,e=0|e||this.height,n=n||f.DEFAULT,i=i||h.range(t*e-1).map(function(t){return t.toString(36)}).join("").toUpperCase(),new T(t,e,n.shuffle(" "+i.substr(0,t*e-1)).join("")," ")},differences:function(t){t=t||this.target;var e=this.board.string;return l(e).zip(t).map(function(t){return t[0]===t[1]?0:1}).sum()},scores:function(){return s(this.players[0],this.maxMoves-this.moveNumber)},result:function(){return 0===this.differences()?this.victory():this.moveNumber>=this.maxMoves?this.defeat():null},emptyCoord:function(){var t=this.board.string.indexOf(" "),e=this.board.width;return[t/e|0,t%e]},moves:function(){var t=this.emptyCoord();this.board;return this.result()?null:{Player:l(S.DIRECTIONS.ORTHOGONAL).mapApply(function(e,n){return[t[0]+e,t[1]+n]},this.board.isValidCoord.bind(this.board)).toArray()}},next:function(t,e,n){u(e,"Haps are not required (given ",e,")!");var i=this.board.swap(this.emptyCoord(),t.Player);return n?(this.board=i,this.moveNumber++,this):new this.constructor({board:i,moveNumber:this.moveNumber+1})},"static __SERMAT__":{identifier:"Puzzle15",serializer:function(t){return[{board:t.board,moveNumber:t.moveNumber}]}}}),w.RoundRobin=c(N,{constructor:function(t,e,n){N.call(this,t,e),this.matchCount=isNaN(n)?t.players.length:+n,this.__advance__=this.__matches__().chain(h.repeat(null)).__iter__()},__matches__:function(){var t=this.game;return l(this.players).permutations(t.players.length).product(h.range(this.matchCount)).map(function(e){return new x(t,e[0])})},"static __SERMAT__":{identifier:"RoundRobin",serializer:function(t){return[t.game,t.players,t.matchCount]}}}),w.Measurement=c(N,{constructor:function(t,e,n,i){N.call(this,t,Array.isArray(e)?e:[e]),this.opponents=Array.isArray(n)?n:[n],u(this.opponents.length<t.players.length-1,"Not enough opponents."),this.matchCount=isNaN(i)?t.players.length:+i,this.__advance__=this.__matches__().chain(h.repeat(null)).__iter__()},__matches__:function(){var t=this.game,e=t.players.length,n=l(this.opponents);return n=e>2?n.product.apply(n,h.repeat(this.opponents,e-2).toArray()):n.map(function(t){return[t]}),l(this.players).product(h.range(e),n,h.range(this.matchCount)).map(function(e){var n=e[2].slice(0);return n.splice(e[1],0,e[0]),new x(t,n)})},"static __SERMAT__":{identifier:"Measurement",serializer:function(t){return[t.game,t.players,t.opponents,t.matchCount]}}}),w.Elimination=c(N,{constructor:function(t,e,n){N.call(this,t,e),this.matchCount=isNaN(n)?1:+n>>0},__bracket__:function(t){var e=this.game,n=this.matchCount,i=this.game.players.length;return(t=t||this.players).length<i?[]:h.range(0,t.length,i).map(function(r){var s=h.range(r,r+i).map(function(e){return t[e%t.length]}).toArray();return h.range(n).map(function(t){return s.unshift(s.pop()),new x(e,s)}).toArray()}).toArray()},__playoff__:function(t){var e={},n={};t.forEach(function(t){var i=t.result();if(!i)throw new Error("Unfinished match in playoff!");l(t.players).forEach(function(t){var r=t[0],s=t[1].name;e[s]=(+e[s]||0)+i[r],n[s]=t[1]})});var i=l(e).greater(function(t){return t[1]})[0][0];return n[i]},__advance__:function(){if(!this.__matches__||this.__matches__.length<1){if(this.__currentBracket__){if(this.__currentBracket__.length<1)return null;var t=this.__currentBracket__.map(this.__playoff__);this.__currentBracket__=this.__bracket__(t)}else this.__currentBracket__=this.__bracket__(this.players);this.__matches__=l(this.__currentBracket__).flatten().toArray()}return this.__matches__.shift()},"static __SERMAT__":{identifier:"Elimination",serializer:function(t){return[t.game,t.players,t.matchCount]}}}),[x,g.Bahab,g.Choose2Win,g.ConnectionGame,g.Mutropas,g.OddsAndEvens,g.Pig,g.Predefined,g.TicTacToe,g.ToadsAndFrogs,g.Puzzle15,E,b.AlphaBetaPlayer,b.MaxNPlayer,b.MiniMaxPlayer,b.MonteCarloPlayer,b.RandomPlayer,b.TracePlayer,b.UCTPlayer,N,w.Elimination,w.Measurement,w.RoundRobin,y.Aleatory,y.DieAleatory,A.CheckerboardFromString].forEach(function(t){t.__SERMAT__.identifier=v.__package__+"."+t.__SERMAT__.identifier,v.__SERMAT__.include.push(t)}),n.include(v),v});
//# sourceMappingURL=ludorum.min.js.map