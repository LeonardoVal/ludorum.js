//! ludorum 0.2.2-alpha

(function(t){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat"],t):"object"==typeof exports&&module.exports?module.exports=t(require("creatartis-base"),require("sermat")):this.ludorum=t(this.base,this.Sermat)}).call(this,function t(e,i){"use strict";var n,r=e.objects.unimplemented,s=e.obj,a=e.copy,o=e.raise,u=e.raiseIf,c=e.declare,h=e.Iterable,l=e.iterable,_=e.Future,f=e.Randomness,p=e.initialize,d=e.Statistics,m=e.Events,v={__package__:"ludorum",__name__:"ludorum",__init__:t,__dependencies__:[e,i],__SERMAT__:{include:[e]}},y=v.aleatories={},g=v.games={},b=v.players={},w=v.tournaments={},A=v.utils={},P=v.Game=c({constructor:function(t){this.activatePlayers(t)},name:"?",players:[],moves:r("Game","moves()"),next:r("Game","next(moves, haps, update)"),result:r("Game","result()"),scores:function(){return this.results()},view:function(t){return this},isActive:function(){for(var t=0;t<arguments.length;t++)if(this.activePlayers.indexOf(arguments[t])<0)return!1;return!0},activePlayer:function(){var t=this.activePlayers.length;return u(t<1,"There are no active players!"),u(t>1,"More than one player is active!"),this.activePlayers[0]},activatePlayers:function(t){return this.activePlayers=t?Array.isArray(t)?t:[t]:[this.players[0]]},opponents:function(t){return t=t||this.activePlayers,this.players.filter(function(e){return t.indexOf(e)<0})},opponent:function(t){var e=this.players.indexOf(t||this.activePlayer());return this.players[(e+1)%this.players.length]},perform:function(){for(var t,e={},i=0;i<arguments.length;i+=2)void 0===(t=arguments[i+1])&&(t=this.activePlayer()),e[t]=arguments[i];return this.next(e)},possibleMoves:function(t){if(!(t=arguments.length<1?this.moves():t)||"object"!=typeof t)return[];var e=Object.keys(t);if(1===e.length){var i=e[0];return t[i].map(function(t){return s(i,t)})}return h.product.apply(h,l(t).mapApply(function(t,e){return e.map(function(e){return[t,e]})}).toArray()).map(function(t){return l(t).toObject()}).toArray()},contingent:function(t,e,i){return new x(this,t,e,i)},randomNext:function(t,e){var i=this.moves(),n={};return this.activePlayers.forEach(function(e){n[e]=t.choice(i[e])}),{state:this.next(n,null,e),moves:n}},resultBounds:function(){return[-1,1]},normalizedResult:function(t){var i;if((t=t||this.result())&&"object"==typeof t){for(var n in i=this.resultBounds(),t=e.copy(t))t[n]=(t[n]-i[0])/(i[1]-i[0])*2-1;return t}return"number"==typeof t?(+t-(i=this.resultBounds())[0])/(i[1]-i[0])*2-1:null},zerosumResult:function(t,e){e=e?Array.isArray(e)?e:[e]:this.activePlayers;var i=-(t=+t/(e.length||1))/(this.players.length-e.length||1);return l(this.players).map(function(n){return[n,e.indexOf(n)<0?i:t]}).toObject()},victory:function(t,e){return this.zerosumResult(e||1,t)},defeat:function(t,e){return this.zerosumResult(e||-1,t)},tied:function(t,e){return e=+(e||0),l(t||this.players).map(function(t){return[t,e]}).toObject()},isZeroSum:!0,isDeterministic:!1,isSimultaneous:!1,__hash__:function(){return i.hashCode(this).toString(36)},clone:function(){return i.clone(this)},toString:function(){return i.ser(this)},"static make":function(t){return(t=a({},t)).hasOwnProperty("name")||"function"!=typeof t.constructor||(t.name=t.constructor.name),u("string"!=typeof t.name||!t.name,"A game must have a `name`!"),u(!Array.isArray(t.players),"A game must have `players`!"),c(this,t)},"static cacheProperties":function(){var t=this;return Array.prototype.slice.call(arguments).forEach(function(e){var i="__"+e+"$cache__",n=t.prototype[e];t.prototype[e]=function(){return arguments.length>0?n.apply(this,arguments):(this.hasOwnProperty(i)||(this[i]=n.call(this)),this[i])}}),t},"static serialized":function(t){var e=t.prototype.moves,i=t.prototype.next;return c(t,{moves:function(){for(var t,i=this.__fixedMoves__||(this.__fixedMoves__={}),n=e.call(this),r=0;r<this.activePlayers.length;r++)if(i.hasOwnProperty(this.activePlayers[r])){t=this.activePlayers[r];break}return t&&n?s(t,n[t]):null},next:function(t){var e,n=a({},this.fixedMoves||{},t);return l(this.players).all(function(t){return n.hasOwnProperty(t)})?(e=i.call(this,n)).fixedMoves={}:(e=this.clone()).fixedMoves=n,e}})}}),E=v.Player=c({constructor:(n=0,function(t){var e=Object.getPrototypeOf(this);p(this,t).string("name",{defaultValue:"Player"+n++,coerce:!0}).object("random",{defaultValue:e.random})}),random:f.DEFAULT,decision:function(t,e){return this.movesFor(t,e)[0]},movesFor:function(t,e){var i=t.moves();return u(!i||!i[e]||i[e].length<1,"Player ",e," has no moves for game ",t,"."),i[e]},isCompatibleWith:function(t){return!0},participate:function(t,e){return this},"static make":function(t){return c(this,t)},"dual playTo":function(t){var e=this,i=t.players.map(function(t){return"function"==typeof e?new e:e});return new M(t,i)},"static __SERMAT__":{identifier:"Player",serializer:function(t){return[{name:t.name}]}},toString:function(){return i.ser(this)}}),M=v.Match=c({constructor:function(t,e){for(var i in this.game=t,this.players=Array.isArray(e)?l(t.players).zip(e).toObject():e,this.history=[{state:t}],this.events=new m({events:["begin","next","end","quit"]}),this.players)this.players[i]=this.players[i].participate(this,i)||this.players[i]},ply:function(){return this.history.length-1},state:function(t){return t=isNaN(t)?this.ply():+t<0?this.ply()+ +t:+t,this.history[0|t].state},result:function(){return this.state().result()},decisions:function(t){t=t||this.state();var e=this.players,i=t.activePlayers;return _.all(i.map(function(i){return e[i].decision(t.view(i),i)})).then(function(t){return l(i).zip(t).toObject()})},run:function(t){if((t=isNaN(t)?1/0:+t)<1)return _.when(this);var e,i=this.ply(),n=this.state();if(i<1&&this.onBegin(n),e=(n=this.__advanceContingents__(n)).result())return this.onEnd(n,e),_.when(this);var r=this;return this.decisions(n).then(function(e){return r.__advance__(n,e)?r.run(t-1):r})},__advanceContingents__:function(t){for(var e,i;t.isContingent;)e=t.randomHaps(),this.history[this.history.length-1].haps=e,i=t.next(e),this.history.push({state:i}),this.onNext(t,null,e,i),t=i;return t},__advance__:function(t,e){var i=this;if(!l(t.activePlayers).all(function(t){var n=e[t];return"function"!=typeof n.__command__||n.__command__(i,t)}))return!1;var n=t.next(e);return this.history[this.history.length-1].moves=e,this.history.push({state:n}),this.onNext(t,e,null,n),!0},"static commands":{Quit:c({__command__:function(t,e){return t.onQuit(t.state(),e),!1}})},onBegin:function(t){this.events.emit("begin",t,this),this.logger&&this.logger.info("Match begins with ",l(this.players).map(function(t){return t[1]+" as "+t[0]}).join(", "),"; for ",t,".")},onNext:function(t,e,i,n){this.events.emit("next",t,e,i,n,this),this.logger&&this.logger.info("Match advances from ",t," to ",n)},onEnd:function(t,e){this.events.emit("end",t,e,this),this.logger&&this.logger.info("Match for ",t,"ends with ",JSON.stringify(e))},onQuit:function(t,e){this.events.emit("quit",t,e,this),this.logger&&this.logger.info("Match for ",t," aborted because player "+e+" quitted.")},"static randomMatch":function(t,i){i=i||{};var n=b.RandomPlayer.playTo(t);return i.log&&("object"==typeof i.log?n.logger=i.log:(n.logger=new e.Logger("string"==typeof i.log?i.log:"Match"),n.logger.appendToConsole())),n},toString:function(){return i.ser(this)},"static __SERMAT__":{identifier:"Match",serializer:function(t){return[t.game,t.players,t.history]},materializer:function(t,e){if(e){var i=new M(e[0],e[1]);return i.history=e[2],i}return null}}}),x=v.Contingent=c({isContingent:!0,constructor:function(t,e,i,n){this.state=t,this.moves=e,this.haps=i,this.update=!!n},next:function(t){return this.state.next(this.moves,t||this.randomHaps(),this.update)},randomHaps:function(t){return l(this.haps).mapApply(function(e,i){return[e,i.randomValue(t)]}).toObject()},randomNext:function(t){return this.next(this.randomHaps(t))},possibleHaps:function(){return h.product.apply(h,l(this.haps).mapApply(function(t,e){return e.distribution().mapApply(function(e,i){return[t,e,i]})}).toArray()).map(function(t){var e=1;return[l(t).mapApply(function(t,i,n){return e*=n,[t,i]}).toObject(),e]}).toArray()},expectedEvaluation:function(t,e,i){var n=this,r=!1,s=this.possibleHaps().map(function(s){var a=n.next(s[0]),o=a.isContingent?a.expectedEvaluation(t,e,i):e(a,t);return r=r||_.__isFuture__(o),_.then(o,function(t){return s.push(t),s})});return _.then(r?_.all(s):s,i||function(t){var e=0;return t.forEach(function(t){e+=t[1]*t[2]}),e})},toString:function(){return i.ser(this)},"static __SERMAT__":{identifier:"Contingent",serializer:function(t){return[t.state,t.moves,t.haps]}}}),N=v.Tournament=c({constructor:function(t,e){this.game=t,this.players=Array.isArray(e)?e:iterables.iterable(e).toArray(),this.statistics=new d,this.events=new m({events:["begin","beforeMatch","afterMatch","end"]})},__advance__:r("Tournament","__advance__"),run:function(){this.onBegin();var t=this;return _.doWhile(function(){return _.then(t.__advance__(),function(e){return e?(t.beforeMatch(e),t.__runMatch__(e).then(function(e){return t.account(e),t.afterMatch(e),e})):null})}).then(this.onEnd.bind(this))},__runMatch__:function(t){return t.run()},account:function(t){var e=this.game,i=t.result(),n=this.statistics;u(!i,"Match doesn't have results. Has it finished?"),l(t.players).forEach(function(r){var s=r[0],a=r[1],o=i[r[0]];n.add({key:"results",game:e.name,role:s,player:a.name},o),n.add({key:o>0?"victories":o<0?"defeats":"draws",game:e.name,role:s,player:a.name},o),n.add({key:"length",game:e.name,role:s,player:a.name},t.ply()),t.history.forEach(function(t){var e=t.state;if("function"==typeof e){var i=e.moves();i&&i.hasOwnProperty(s)&&i[s].length>0&&n.add({key:"width",game:e.name,role:s,player:a.name},i[s].length)}})})},onBegin:function(){this.events.emit("begin",this),this.logger&&this.logger.info("Tournament begins for game ",game.name,".")},beforeMatch:function(t){this.events.emit("beforeMatch",t,this),this.logger&&this.logger.debug("Beginning match with ",JSON.stringify(t.players),".")},afterMatch:function(t){this.events.emit("afterMatch",t,this),this.logger&&this.logger.debug("Finishing match with ",JSON.stringify(t.players),".")},onEnd:function(){this.events.emit("end",this.statistics,this),this.logger&&this.logger.info("Tournament ends for game ",game.name,":\n",this.statistics,"\n")},toString:function(){return i.ser(this)},"static __SERMAT__":{identifier:"Tournament",serializer:function(t){return[t.game,t.players]}}}),S=A.Checkerboard=c({constructor:function(t,e){isNaN(t)||(this.height=0|t),isNaN(e)||(this.width=0|e)},emptySquare:null,isValidCoord:function(t){return Array.isArray(t)&&!isNaN(t[0])&&!isNaN(t[1])&&t[0]>=0&&t[0]<this.height&&t[1]>=0&&t[1]<this.width},coordinates:function(){return h.range(this.height).product(h.range(this.width))},square:r("utils.Checkerboard","square"),isEmptySquare:function(t){return this.square(t)===this.emptySquare},horizontals:function(){var t=this.width;return h.range(this.height).map(function(e){return h.range(t).map(function(t){return[e,t]})})},verticals:function(){var t=this.height;return h.range(this.width).map(function(e){return h.range(t).map(function(t){return[t,e]})})},orthogonals:function(){return this.horizontals().chain(this.verticals())},positiveDiagonals:function(){var t=this.width,e=this.height,i=e+t-1;return h.range(i).map(function(t){var n=Math.max(0,e-t-1),r=Math.max(0,t-e+1);return h.range(Math.min(t+1,i-t)).map(function(t){return[n+t,r+t]})})},negativeDiagonals:function(){var t=this.width,e=this.height,i=e+t-1;return h.range(i).map(function(t){var n=Math.min(t,e-1),r=Math.max(0,t-e+1);return h.range(Math.min(t+1,i-t)).map(function(t){return[n-t,r+t]})})},diagonals:function(){return this.positiveDiagonals().chain(this.negativeDiagonals())},lines:function(){return this.orthogonals().chain(this.diagonals())},sublines:function(t,e){return l(t).map(function(t){return Array.isArray(t)?t:l(t).toArray()},function(t){return t.length>=e}).map(function(t){return h.range(0,t.length-e+1).map(function(i){return t.slice(i,i+e)})}).flatten()},walk:function(t,e){var i=this;return new h(function(){var n=t.slice();return function(){if(i.isValidCoord(n)){var t=n.slice();return n[0]+=e[0],n[1]+=e[1],t}throw h.STOP_ITERATION}})},walks:function(t,e){var i=this;return e.map(function(e){return i.walk(t,e)})},"static DIRECTIONS":{HORIZONTAL:[[0,-1],[0,1]],VERTICAL:[[-1,0],[1,0]],ORTHOGONAL:[[0,-1],[0,1],[-1,0],[1,0]],DIAGONAL:[[-1,-1],[-1,1],[1,-1],[1,1]],EVERY:[[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[-1,1],[1,-1],[1,1]]},clone:r("utils.Checkerboard","clone"),__place__:r("utils.Checkerboard","place"),place:function(t,e){return this.clone().__place__(t,e)},__move__:function(t,e,i){return this.__place__(e,this.square(t)).__place__(t,void 0===i?this.emptySquare:i)},move:function(t,e,i){return this.clone().__move__(t,e,i)},__swap__:function(t,e){var i=this.square(e);return this.__place__(e,this.square(t)).__place__(t,i)},swap:function(t,e){return this.clone().__swap__(t,e)},transform:function(t){var e=this.clone(),i=this;return this.coordinates().forEach(function(n){var r=t.apply(i,[i,n].concat(n));e.__place__(r,i.square(n))}),e},horizontalSymmetry:function(){return this.transform(function(t,e,i,n){return[i,t.width-n-1]})},verticalSymmetry:function(){return this.transform(function(t,e,i,n){return[t.height-i-1,n]})},clockwiseRotation:function(){return this.transform(function(t,e,i,n){return[n,t.height-i-1]})},counterClockwiseRotation:function(){return this.transform(function(t,e,i,n){return[t.width-n-1,i]})},renderAsHTMLTable:function(t,i,n){var r=this,s=t.createElement("table");return i.appendChild(s),r.horizontals().reverse().forEach(function(i){var a=t.createElement("tr");s.appendChild(a),i.forEach(function(i){var s=r.square(i),o=t.createElement("td"),u={id:"ludorum-square-"+i.join("-"),className:"ludorum-square",square:s,coord:i,innerHTML:e.Text.escapeXML(s)};n&&(u=n(u)||u),o["ludorum-data"]=u,o.id=u.id,o.className=u.className,o.innerHTML=u.innerHTML,u.onclick&&(o.onclick=u.onclick),a.appendChild(o)})}),s},weightedSum:function(t,e){var i=this;return this.coordinates().zip(t).mapApply(function(t,n){return e[i.square(t)]*n||0}).sum()}}),T=A.CheckerboardFromString=c(S,{constructor:function(t,e,i,n){if(S.call(this,t,e),n&&n!==this.emptySquare&&(this.emptySquare=(n+"").charAt(0)),i&&i.length!==t*e)throw new Error("Given string "+JSON.stringify(i)+" does not match board dimensions.");this.string=i||this.emptySquare.repeat(t*e)},emptySquare:".",toString:function(){var t=this.string,e=this.height,i=this.width;return h.range(e).map(function(n){return t.substr((e-n-1)*i,i)}).join("\n")},square:function(t,e){var i=t[0],n=t[1],r=this.width;return i>=0&&i<this.height&&n>=0&&n<r?this.string.charAt(i*r+n):e},asString:function(t){var e=this;return t.map(function(t){return e.square(t)}).join("")},asStrings:function(t){var e=this;return t.map(function(t){return e.asString(t)})},asRegExp:function(t,e,i){i=i||".";var n=this.width,r=h.repeat(!1,n*this.height).toArray();t.forEach(function(t){r[t[0]*n+t[1]]=!0});for(var s,a="",o=0,u=0;u<r.length;o=0){s=r[u];do{++o}while(++u<r.length&&r[u]===s);a+=o<2?s?e:i:(s?e:i)+"{"+o+"}"}return a},asRegExps:function(t,e,i){var n=this;return t.map(function(t){return n.asRegExp(t,e,i)}).join("|")},clone:function(){return new this.constructor(this.height,this.width,this.string,this.hasOwnProperty("emptySquare")?this.emptySquare:void 0)},__place__:function(t,e){u(!this.isValidCoord(t),"Invalid coordinate ",t,"."),e=(e+this.emptySquare).charAt(0);var i=t[0]*this.width+t[1];return this.string=this.string.substr(0,i)+e+this.string.substr(i+1),this},"static __SERMAT__":{identifier:"CheckerboardFromString",serializer:function(t){var e=[t.height,t.width,t.string];return t.hasOwnProperty("emptySquare")&&e.push(t.emptySquare),e}}});A.CheckerboardFromPieces=c(S,{constructor:function(t,i,n,r){S.call(this,t,i);var s=this;r!==this.emptySquare&&(this.emptySquare=r),Array.isArray(n)?(this.pieces={},l(n||[]).forEach(function(t){u(!Array.isArray(t.position),"Piece has not a position (",t,")!"),s.pieces[t.position+""]=t})):"object"==typeof n?this.pieces=e.copy({},n):o("Invalid pieces definition: ",n,"!")},emptySquare:null,toString:function(){return"["+l(this.pieces).select(1).join(", ")+"]"},square:function(t,e){return this.pieces[t]||e},clone:function(){return new this.constructor(this.height,this.width,this.pieces,this.emptySquare)},__place__:function(t,e){u(!this.isValidCoord(t),"Invalid coordinate ",t,"!");var i=t+"";return delete this.pieces[i],e&&(this.pieces[i]=e),this},"static __SERMAT__":{identifier:"CheckerboardFromPieces",serializer:function(t){var e=[t.height,t.width,t.pieces];return t.hasOwnProperty("emptySquare")&&e.push(t.emptySquare),e}}});A.Cache=c({constructor:function(t){this.clear(),t&&this.root(t)},stateIdentifier:function(t){return t.identifier()},moveIdentifier:function(t){return JSON.stringify(t)},has:function(t){var e="string"==typeof t?t:this.stateIdentifier(t);return this.__entries__.hasOwnProperty(e)},get:function(t){var e="string"==typeof t?t:this.stateIdentifier(t);return this.__entries__[e]},size:function(){return Object.keys(this.__entries__).length},entry:function(t,e){if(e=e||this.stateIdentifier(t),this.has(e))return this.get(e);var i={id:e,state:t,precursors:[],descendants:{}};return this.__entries__[e]=i,i},descendant:function(t,e){var i=this.moveIdentifier(e),n=t.descendants;if(n.hasOwnProperty(i))return n[i][1];var r=t.state.next(e),s=this.stateIdentifier(r),a=this.get(s)||this.entry(r,s);return n[i]=[e,a],a.precursors.push([e,t]),a},descendants:function(t){var e=this.descendant.bind(this,t);return arguments.length>1?Array.prototype.slice.call(arguments,1).map(e):t.state.possibleMoves().map(e)},clear:function(){this.__entries__={},this.__root__=null},root:function(t){if(arguments.length>0){var e=this.stateIdentifier(t);this.__root__=this.get(e)||this.entry(t,e),this.prune(e)}return this.__root__},prune:function(t){for(var e,i=[t||this.__root__.id],n={};t=i.shift();)n.hasOwnProperty(t)||(e=this.get(t),n[t]=e,i.push.apply(i,l(e.descendants).mapApply(function(t,e){return e[1][t]}).toArray()));return this.__entries__=n}});var O=A.GameTree=c({constructor:function(t){this.parent=t&&t.parent,this.state=t&&t.state,this.transition=t&&t.transition,this.probability=t&&+t.probability,this.__children__=t&&t.children,this.children()},children:function(){if(!this.__children__){if(!this.state)return null;this.__children__=this.possibleTransitions()}return this.__children__},possibleTransitions:function(){var t=this.state,e=this.constructor,i=this;return u(!t,"GameTree node has no state!"),t.isContingent?t.possibleHaps().map(function(t){return new e({parent:i,transition:t[0],probability:t[1]})}):t.possibleMoves().map(function(t){return new e({parent:i,transition:t})})},expand:function(){return u(this.state,"Node `",this,"` is already expanded!"),u(!this.parent,"Cannot expand node `",this,"` without a parent!"),this.state=this.parent.state.next(this.transition),this.children(),this},pending:function(){return this.children().filter(function(t){return!t.state})},expandRandom:function(t,e){return t=t||f.DEFAULT,(e=e||this.pending()).length<1?null:(1===e.length?e[0]:t.choice(e)).expand()},toString:function(){return"GameTree("+this.state+")"},"static __SERMAT__":{identifier:"GameTree",serializer:function(t){return[{parent:t.parent,state:t.state,transition:t.transition,probability:t.probability,children:t.children}]}}});b.RandomPlayer=c(E,{constructor:function(t){E.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).object("random",{defaultValue:e.random})},random:f.DEFAULT,decision:function(t,e){return u(t.isContingent,"Contingent game state has no moves!"),this.random.choice(this.movesFor(t,e))},"static __SERMAT__":{identifier:"RandomPlayer",serializer:function(t){return this.serializeAsProperties(t,["name","random"])}}}),b.TracePlayer=c(E,{constructor:function(t){E.call(this,t),this.trace=l(t.trace),this.__iter__=this.trace.__iter__(),this.__decision__=this.__iter__()},decision:function(t,e){try{this.__decision__=this.__iter__()}catch(t){h.prototype.catchStop(t)}return this.__decision__},"static __SERMAT__":{identifier:"TracePlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t);return e[0].trace=t.trace.toArray(),e}}});var C=b.HeuristicPlayer=c(E,{constructor:function(t){E.call(this,t);Object.getPrototypeOf(this);p(this,t).func("heuristic",{ignore:!0})},moveEvaluation:function(t,e,i){var n=this;if(Object.keys(t).length<2)return this.stateEvaluation(e.next(t),i);var r=0,o=0;return t=a(s(i,[t[i]]),t),e.possibleMoves(t).forEach(function(t){r+=n.stateEvaluation(e.next(t),i),++o}),o>0?r/o:0},stateEvaluation:function(t,e){if(t.isContingent)return t.expectedEvaluation(e,this.stateEvaluation.bind(this));var i=t.result();return i?i[e]:this.heuristic(t,e)},heuristic:function(t,e){return this.random.random(-.5,.5)},evaluatedMoves:function(t,e){var i=this,n=!1;u(t.isContingent,"Contingent game state has no moves!");var r=this.possibleMoves(t,e).map(function(r){var s=i.moveEvaluation(r,t,e);return n=n||_.__isFuture__(s),_.then(s,function(t){return[r,t]})});return n?_.all(r):r},possibleMoves:function(t,e){var i=t.moves();return u(!i||!i[e]||!Array.isArray(i[e])||i[e].length<1,"Player "+e+" has no moves in "+t+" (moves= "+i+")!"),i[e].map(function(t){return a(s(e,t),i)})},bestMoves:function(t){return _.then(t,function(t){return l(t).greater(function(t){return t[1]}).map(function(t){return t[0]})})},decision:function(t,e){var i=this.random;return _.then(this.bestMoves(this.evaluatedMoves(t,e)),function(n){return u(!n||!n.length,"No moves where selected at ",t," for player ",e,"!"),i.choice(n)[e]})},"static composite":function(){var t=Array.prototype.slice.call(arguments);u(t.length<1,"HeuristicPlayer.composite() cannot take an odd number of arguments!");for(var e=0;e<t.length;e+=2)u("function"!=typeof t[e],"HeuristicPlayer.composite() argument ",e," (",t[e],") is not a function!"),t[e+1]=+t[e+1],u(isNaN(t[e+1])||t[e+1]<0||t[e+1]>1,"HeuristicPlayer.composite() argument ",e+1," (",t[e+1],") is not a valid weight!");return function(e,i){for(var n=0,r=0;r+1<t.length;r+=2)n+=t[r](e,i)*t[r+1];return n}},"static __SERMAT__":{identifier:"HeuristicPlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t),i=e[0];return t.hasOwnProperty("heuristic")&&(i.heuristic=t.heuristic),e}}}),R=(b.MaxNPlayer=c(C,{constructor:function(t){C.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).integer("horizon",{defaultValue:e.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(t){return!t.isSimultaneous&&t.isDeterministic},stateEvaluation:function(t,e){if(!t.isContingent)return this.maxN(t,e,0)[e];o("MaxNPlayer.stateEvalution() does not support contingent game states!")},heuristics:function(t){var e={},i=this;return t.players.forEach(function(n){e[n]=i.heuristic(t,n)}),e},quiescence:function(t,e,i){var n=t.result();return n||(i>=this.horizon?this.heuristics(t):null)},maxN:function(t,e,i){var n=this.quiescence(t,e,i);if(!n){var r,a,o=t.activePlayer(),u=this.movesFor(t,o);if(n={},u.length<1)throw new Error("No moves for unfinished game "+t+".");for(var c=0;c<u.length;++c)a=t.next(s(o,u[c])),(r=this.maxN(a,e,i+1))[o]>(n[o]||-1/0)&&(n=r)}return n},"static __SERMAT__":{identifier:"MaxNPlayer",serializer:function(t){var e=C.__SERMAT__.serializer(t);return e[0].horizon=t.horizon,e}}}),b.MiniMaxPlayer=c(C,{constructor:function(t){C.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).integer("horizon",{defaultValue:e.horizon,coerce:!0})},horizon:4,isCompatibleWith:function(t){return!t.isSimultaneous},stateEvaluation:function(t,e,i){return this.minimax(t,e,1,i)},quiescence:function(t,e,i){var n=t.result();return n?n[e]:i>=this.horizon?this.heuristic(t,e):NaN},minimax:function(t,e,i,n){if(t.isContingent)return this.expectiMinimax(t,e,i,n);var r=this.quiescence(t,e,i);if(isNaN(r)){var a,o,u=t.activePlayer(),c=this.movesFor(t,u);if(c.length<1)throw new Error("No moves for unfinished game "+t+".");u==e?(r=-1/0,a=Math.max):(r=1/0,a=Math.min);for(var h=0;h<c.length;++h)o=t.next(s(u,c[h])),r=a(r,this.minimax(o,e,i+1,n))}if(n&&"function"==typeof n.hook){var l=n.hook(t,r);isNaN(l)||(r=l)}return r},expectiMinimax:function(t,e,i,n){if(t.isContingent){var r=this;return t.expectedEvaluation(e,function(t,e){return r.minimax(t,e,i+1,n)})}return this.minimax(t,e,i,n)},"static solution":function(t,e){var i=e&&e.evals||{},n=new this({horizon:1e8}),r=e.gameKey||function(t){return t.toString()};return n.minimax(t,t.activePlayer(),0,{hook:function(t,e){var n=r(t);u(i.hasOwnProperty(n)&&i[n]!==e,"Game ",t,"(key ",n,") has different values ",i[n]," and ",e,"!"),i[n]=e}}),i},"static __SERMAT__":{identifier:"MiniMaxPlayer",serializer:function(t){var e=C.__SERMAT__.serializer(t);return e[0].horizon=t.horizon,e}}}));b.AlphaBetaPlayer=c(R,{constructor:function(t){R.call(this,t)},stateEvaluation:function(t,e){return this.minimax(t,e,1,-1/0,1/0)},minimax:function(t,e,i,n,r){if(t.isContingent)return this.expectiMinimax(t,e,i,n,r);var a=this.quiescence(t,e,i);if(!isNaN(a))return a;var u,c=t.activePlayer(),h=c==e,l=this.movesFor(t,c);l.length<1&&o("No moves for unfinished game "+t+"!");for(var _=0;_<l.length&&(u=t.next(s(c,l[_])),a=this.minimax(u,e,i+1,n,r),h?n<a&&(n=a):r>a&&(r=a),!(r<=n));_++);return h?n:r},expectiMinimax:function(t,e,i,n,r){if(t.isContingent){var s=this;return t.expectedEvaluation(e,function(t,e){return s.minimax(t,e,i+1,n,r)})}return this.minimax(t,e,i)},"static __SERMAT__":{identifier:"AlphaBetaPlayer",serializer:function(t){return R.__SERMAT__.serializer(t)}}});var z=b.MonteCarloPlayer=c(C,{constructor:function(t){C.call(this,t);var e=Object.getPrototypeOf(this);if(p(this,t).number("simulationCount",{defaultValue:e.simulationCount,coerce:!0}).number("timeCap",{defaultValue:e.timeCap,coerce:!0}).number("horizon",{defaultValue:e.horizon,coerce:!0}),t)switch(typeof t.agent){case"function":this.agent=new C({heuristic:t.agent});break;case"object":this.agent=t.agent;break;default:this.agent=null}},simulationCount:30,timeCap:1e3,horizon:500,evaluatedMoves:function(t,e){u(t.isContingent,"MonteCarloPlayer cannot evaluate root contingent states!");for(var i=this,n=Date.now(),r=this.possibleMoves(t,e).map(function(i){return{move:i,nexts:Object.keys(i).length<2?[t.next(i)]:t.possibleMoves(a(s(e,[i[e]]),i)).map(function(e){return t.next(e)}),sum:0,count:0}}),o=0;!this.__finishMoveEvaluation__(o,n,r);)r.forEach(function(t){t.nexts=t.nexts.filter(function(n){var r=i.simulation(n,e);return t.sum+=r.result,++t.count,r.plies>0}),o++});return r.map(function(t){return u(isNaN(t.sum),"State evaluation is NaN for move ",t.move,"!"),[t.move,t.count>0?t.sum/t.count:0,t.count]})},__finishMoveEvaluation__:function(t,e,i){return t>this.simulationCount||e+this.timeCap<Date.now()},stateEvaluation:function(t,e){for(var i,n=0,r=this.simulationCount,s=0;s<r&&(n+=(i=this.simulation(t,e)).result[e],!(i.plies<1));++s);return r>0?n/r:0},quiescence:function(t,e,i){var n=t.result();return n?n[e]:i>=this.horizon?this.heuristic(t,e):NaN},simulation:function(t,e){var i,n={game:t};for(i=0;;++i)if(t.isContingent)t=t.randomNext(this.random);else{var r=this.quiescence(t,e,i+1);if(!isNaN(r))return n.result=r,n.plies=i,n;t=t.randomNext(this.random,i>0).state}o("Simulation ended unexpectedly for player ",e," in game ",t,"!")},"static __SERMAT__":{identifier:"MonteCarloPlayer",serializer:function(t){var e=C.__SERMAT__.serializer(t),i=e[0];return i.simulationCount=t.simulationCount,i.timeCap=t.timeCap,i.horizon=t.horizon,t.agent&&(i.agent=t.agent),e}}});b.UCTPlayer=c(z,{constructor:function(t){z.call(this,t);var e=Object.getPrototypeOf(this);p(this,t).number("explorationConstant",{defaultValue:e.explorationConstant,coerce:!0})},explorationConstant:Math.sqrt(2),selectNode:function(t,e,i){i=isNaN(i)?this.explorationConstant:+i;var n=l(t.children()).greater(function(e){e.uct||(e.uct={visits:0,wins:0,rewards:0});var n=e.uct.visits;return e.uct.wins/(n+1e-10)+i*Math.sqrt(Math.log(t.uct.visits+1)/(n+1e-10))});return this.random.choice(n)},evaluatedMoves:function(t,e){var i,n,r=new O({state:t}),s=Date.now();r.uct={visits:0,wins:0,rewards:0};for(var a=0;!this.__finishMoveEvaluation__(a,s,r);a++){for(i=r;i.__children__&&i.__children__.length>0;)i=this.selectNode(i,a+1,this.explorationConstant);for(i.state||i.expand(),n=this.simulation(i.state,e);i;i=i.parent)i.uct.visits++,n.result>0&&i.uct.wins++,i.uct.rewards+=t.normalizedResult(n.result)}return l(r.children()).map(function(t){t.uct||console.log(t);var e=t.uct.visits;return t.uct?[t.transition,t.uct.rewards/(e+1e-10),e]:[t.transition,0,0]}).toArray()},"static __SERMAT__":{identifier:"UCTPlayer",serializer:function(t){var e=z.__SERMAT__.serializer(t);return e[0].explorationConstant=t.explorationConstant,e}}}),b.RuleBasedPlayer=c(E,{constructor:function(t){E.call(this,t),p(this,t).array("rules",{defaultValue:[]}).func("features",{ignore:!0})},features:function(t,e){return[t,e]},decision:function(t,e){for(var i=null,n=this.features(t,e),r=this.movesFor(t,e),s=0,a=this.rules.length;s<a;s++)if(null!==(i=this.rules[s].call(this,n))&&r.indexOf(i)>=0)return i;return this.random.choice(r)},rule:function(t){return u("function"!=typeof t,"A rule must be in the form of a function!"),this.rules.push(t),this},"static regExpRule":function(t,e){return function(i){return t.test(i)?e:null}},regExpRule:function(t,e){return this.rule(this.constructor.regExpRule(t,e))},"static __SERMAT__":{identifier:"RuleBasedPlayer",serializer:function(t){var e=E.__SERMAT__.serializer(t),i=e[0];return i.rules=t.rules,t.hasOwnProperty("features")&&(i.features=t.features),e}}}),b.EnsemblePlayer=c(E,{constructor:function(t){E.call(this,t),p(this,t).array("players",{ignore:!0})},players:[],playerSelection:function(t,e){return this.players},decision:function(t,e){return this.randomDecision(t,e)},randomDecision:function(t,e,i){return i=i||this.playerSelection(t,e),u(i.length<1,"No player was selected!"),(1==i.length?i[0]:this.random.choice(i)).decision(t,e)},heuristicCombination:function(){function t(t,e,i,n){return l(e).sum()/e.length}return function(e){return e=e||t,function(t,i,n){var r=!1,s=this,a=(n=n||this.playerSelection(t,i)).map(function(e){u(!e.evaluatedMoves,"Cannot call `evaluatedMoves()` on player ",e.name,"(",e.constructor.name,")!");var n=e.evaluatedMoves(t,i);return r=r||_.__isFuture__(n),n});return r?_.all(a).then(function(n){return s.__bestAggregatedEvaluationMove__(t,i,e,n)}):s.__bestAggregatedEvaluationMove__(t,i,e,a)}}}(),__aggregateEvaluatedMoves__:function(t,e,i,n){var r=l(n).flatten().groupAll(function(t){return JSON.stringify(t[0])},function(t,e){return t?(t[1].push(e[1]),t):[e[0],[e[1]]]});return l(r).mapApply(function(n,r){return[r[0],i(r[0],r[1],t,e)]})},__bestAggregatedEvaluationMove__:function(t,e,i,n){var r=this.__aggregateEvaluatedMoves__(t,e,i,n);u(r.isEmpty(),"There are no evaluated moves for ",e," to choose from in ",t,"!");var s=C.prototype.bestMoves(r);return this.random.choice(s)[e]},"static parallelizeHeuristicPlayer":function(t,i){t=t||navigator.hardwareConcurrency;var n=e.Iterable.range(t).map(function(){return ludorum.players.WebWorkerPlayer.create(i)}),r=this;return e.Future.all(n.toArray()).then(function(t){var e=new r({players:t});return e.decision=e.heuristicCombination(),e})},"static __SERMAT__":{identifier:"EnsemblePlayer",serializer:function(t){return this.serializeAsProperties(t,["name","random","players"])}}});var k=b.UserInterfacePlayer=c(E,{constructor:function(t){E.call(this,t)},participate:function(t,e){return this.role=e,this},decision:function(t,e){return this.__future__&&this.__future__.isPending()&&this.__future__.resolve(new M.commands.Quit),this.__future__=new _,this.__future__},perform:function(t){var e=this.__future__;return e&&(this.__future__=null,e.resolve(t)),!!e}}),q=b.UserInterface=c({constructor:function(t){this.onBegin=this.onBegin.bind(this),this.onNext=this.onNext.bind(this),this.onEnd=this.onEnd.bind(this),t.match&&this.show(t.match)},show:function(t){this.match&&(t.events.off("begin",this.onBegin),t.events.off("next",this.onNext),t.events.off("end",this.onEnd)),this.match=t,t.events.on("begin",this.onBegin),t.events.on("next",this.onNext),t.events.on("end",this.onEnd)},onBegin:function(t){this.display(t)},onNext:function(t,e,i,n){this.display(n)},onEnd:function(t,e){this.results=e,this.display(t)},display:r("UserInterface","display"),perform:function(t,e){l(this.match.players).forEach(function(i){i[0];var n=i[1];n instanceof k&&(!e||n.role===e)&&n.perform(t)})}});q.BasicHTMLInterface=c(q,{constructor:function(t){q.call(this,t),this.document=t.document||e.global.document,this.container=t.container,"string"==typeof this.container&&(this.container=this.document.getElementById(this.container))},display:function(t){for(var e,i=this.container;e=i.firstChild;)i.removeChild(e);t.display(this)},build:function(t,e){var i=this;return e.forEach(function(e){var n;if(Array.isArray(e)){if(n=i.document.createElement(e[0]),e.length>2&&e[1]){var r=e[1];for(var s in r)attr.hasOwnProperty(s)&&n.setAttribute(s,r[s])}e.length>1&&e[e.length-1]&&i.build(n,e[e.length-1])}else"string"==typeof e&&(n=i.document.createTextNode(e));n&&t&&t.appendChild(n)}),t}});b.WebWorkerPlayer=c(E,{constructor:function(t){E.call(this,t),p(this,t).object("worker"),this.worker.onmessage=e.Parallel.prototype.__onmessage__.bind(this)},"static createWorker":function(t){u("string function".indexOf(typeof t.playerBuilder)<0,"Invalid player builder: "+t.playerBuilder+"!"),u(t.workerSetup&&"string function".indexOf(typeof t.workerSetup)<0,"Invalid worker setup: "+t.workerSetup+"!");var i=new e.Parallel,n=[v].concat(t.dependencies||[]);return _.sequence(n,function(t){return i.loadModule(t,!0)}).then(function(){return i.run((t.workerSetup?"("+t.workerSetup+")(),\n":"")+"self.PLAYER = ("+t.playerBuilder+').call(self),\n"OK"')}).then(function(){var t=i.worker;return t.__parallel__=i,t})},"static create":function(t){var e=this;return e.createWorker(t).then(function(t){return new e({name:name,worker:t})})},__newFuture__:function(t){var e=this.__future__;return e&&e.isPending()&&(e.hasOwnProperty("__cancelValue__")?e.resolve(e.__cancelValue__):e.reject("Canceled!")),e=new _,void 0!==t&&(e.__cancelValue__=t),this.__future__=e,e},__onmessage__:function(t){var e=this.__future__;e&&(e.hasOwnProperty("__cancelValue__")?e.resolve(e.__cancelValue__):e.reject("Canceled!")),this.__future__=null;try{var i=JSON.parse(t.data);i.error?e.reject(i.error):e.resolve(i.result)}catch(t){e.reject(t)}},__run__:function(t){var e=this.__newFuture__(M.commandQuit);return this.worker.postMessage(t),e},decision:function(t,e){return this.__run__("PLAYER.decision(Sermat.mat("+JSON.stringify(i.ser(t))+"),"+JSON.stringify(e)+")")},evaluatedMoves:function(t,e){return this.__run__("PLAYER.evaluatedMoves(Sermat.mat("+JSON.stringify(i.ser(t))+"),"+JSON.stringify(e)+")")}});var B,I,j=v.aleatories.Aleatory=c({constructor:function(t){this.__distribution__=l(t).toArray(),u(this.__distribution__.length<1,"Aleatories must have at least one value!")},count:function(){return this.__distribution__.length},value:function(t){return this.__distribution__[t][0]},probability:function(t){return+this.__distribution__[t][1]},randomValue:function(t){return(t=t||f.DEFAULT).weightedChoice(this.__distribution__)},distribution:function(){var t=this;return h.range(this.count()).map(function(e){return[t.value(e),t.probability(e)]})},"static tries":function(t,i){var n=e.math.combinations;return i<=0?[[0,1]]:h.range(i+1).map(function(e){return[e,Math.pow(t,e)*Math.pow(1-t,i-e)*n(i,e)]}).toArray()},"static aggregate":function(t,e,i,n){var r=[];return i=i||function(t,e){return t+e},n=n||function(t,e){return t===e},h.product(t,e).forEachApply(function(t,e){for(var s=i(t[0],e[0]),a=0;a<r.length;a++)if(n(r[a][0],s))return void(r[a][1]+=t[1]*e[1]);r.push([s,t[1]*e[1]])}),r},"static __SERMAT__":{identifier:"Aleatory",serializer:function(t){return[t.distribution().toArray()]}}}),F=v.aleatories.DieAleatory=c(j,{constructor:function(t,e){1===arguments.length&&(e=t,t=1),this.min=0|t,this.max=0|e},count:function(){return this.max-this.min+1},value:function(t){return t>this.max-this.min?void 0:t+this.min},probability:function(t){return t>this.max-this.min?NaN:1/(this.max-this.min+1)},randomValue:function(t){return(t||f.DEFAULT).randomInt(this.min,this.max+1)},"static __SERMAT__":{identifier:"DiceAleatory",serializer:function(t){return[t.min,t.max]}}});return y.dice={D4:new F(4),D6:new F(6),D8:new F(8),D10:new F(10),D12:new F(12),D20:new F(20)},y.uniformAleatory=function(t){var e=1/(t=l(t).toArray()).length;return new j(t.map(function(t){return[t,e]}))},y.normalization=function(t){var e=0,i=[];return l(t).forEachApply(function(t,n){u(n<0,"aleatories.normalization: probabilities cannot be negative ("+n+")!"),e+=n;for(var r=0;r<i.length;r++)if(i[r][0]===t)return void(i[r][1]+=n);i.push([t,n])}),e>0&&i.forEach(function(t){t[1]/=e}),i},y.sumProbability=function(t,i,n){if(i|=0,n|=0,t|=0,isNaN(i)||isNaN(n)||isNaN(t)||i<1||n<2)return NaN;if(t<i||t>i*n)return 0;var r=e.math.factorial,s=r(i),a=s/i;return Math.pow(n,-i)*h.range(0,Math.floor((t-i)/n)+1).map(function(e){var o=s/r(e)/r(i-e),u=t-n*e-1,c=r(u)/a/r(u-i+1);return(e%2?-1:1)*o*c}).sum()},g.Predefined=c(P,{name:"Predefined",height:5,width:5,constructor:function(t,e,i,n){e&&(this.__results__=e,this.players=Object.keys(e)),P.call(this,t),isNaN(i)||(this.height=+i),isNaN(n)||(this.width=+n)},players:["A","B"],__results__:{A:0,B:0},moves:function(){if(this.height>0)return s(this.activePlayer(),h.range(1,this.width+1).toArray())},result:function(){return this.height>0?null:this.__results__},next:function(t,e,i){return u(e,"Haps are not required (given ",e,")!"),i?(this.height--,this.activatePlayers(this.opponent()),this):new this.constructor(this.opponent(),this.__results__,this.height-1,this.width)},"static __SERMAT__":{identifier:"Predefined",serializer:function(t){return[t.activePlayer(),t.__results__,t.height,t.width]}}}),g.Choose2Win=c(P,{constructor:function(t,e,i){P.call(this,e),this.__turns__=isNaN(t)?1/0:+t,this.__winner__=i},name:"Choose2Win",players:["This","That"],moves:function(){if(!this.__winner__&&this.__turns__>0)return s(this.activePlayer(),["win","lose","pass"])},result:function(){return this.__winner__?this.victory(this.__winner__):this.__turns__<1?this.draw():null},next:function(t,e,i){var n=this.activePlayer(),r=this.opponent(n);u(!t.hasOwnProperty(n),"No move for active player ",n," at ",this,"!"),u(e,"Haps are not required (given ",e,")!");var s={win:n,lose:r,pass:void 0},a=t[n];if(s.hasOwnProperty(a))return i?(this.activatePlayers(r),this.__turns__--,this.__winner__=s[a],this):new this.constructor(this.__turns__-1,r,s[a]);o("Invalid move ",t[n]," for ",n," at ",this,"!")},"static __SERMAT__":{identifier:"Choose2Win",serializer:function(t){var e=[t.__turns__,t.activePlayer()];return t.__winner__&&e.push(t.__winner__),e}}}),g.ConnectionGame=c(P,{name:"ConnectionGame",height:9,width:9,lineLength:5,constructor:function(t,e){P.call(this,t),this.board=e instanceof T?e:new T(this.height,this.width,e),this.height=this.board.height,this.width=this.board.width},players:["First","Second"],__lines__:function(){var t={};function e(e,i,n){var r=e+"x"+i+"/"+n;if(!t.hasOwnProperty(r)){var s=new T(e,i,".".repeat(e*i));t[r]=s.lines().map(function(t){return t.toArray()},function(t){return t.length>=n}).toArray()}return t[r]}return e.CACHE=t,e}(),result:function(){if(this.hasOwnProperty("__result__"))return this.__result__;for(var t=this.lineLength,e=this.board.asStrings(this.__lines__(this.height,this.width,t)).join(" "),i=0;i<this.players.length;++i)if(e.indexOf(i.toString(36).repeat(t))>=0)return this.__result__=this.victory([this.players[i]]);return e.indexOf(".")<0?this.__result__=this.tied():this.__result__=null},moves:function(){if(this.hasOwnProperty("__moves__"))return this.__moves__;if(this.result())this.__moves__=null;else{var t=this.board;this.__moves__=s(this.activePlayer(),t.coordinates().filter(function(e){return t.isEmptySquare(e)}).toArray())}return this.__moves__},next:function(t,e,i){u(e,"Haps are not required (given ",e,")!");var n=this.activePlayer(),r=this.players.indexOf(n),s=t[n],a=(r+1)%this.players.length,o=this.board.place(s,r.toString(36));return i?(this.activatePlayers(a),this.board=o,this):new this.constructor(a,o)},display:function(t){u(!(t&&t instanceof q.BasicHTMLInterface),"Unsupported UI!");var e=this.moves(),i=this.activePlayer(),n=this.board;e=e&&e[i];this.board.renderAsHTMLTable(t.document,t.container,function(r){r.className="."===r.square?"ludorum-empty":"ludorum-player"+r.square,r.innerHTML="."===r.square?"&nbsp;":"&#x25CF;";var s=r.coord[0]*n.height+r.coord[1];e&&e.indexOf(s)>=0&&(r.move=s,r.activePlayer=i,r.onclick=t.perform.bind(t,r.move,i))});return t},"static __SERMAT__":{identifier:"ConnectionGame",serializer:function(t){return[t.activePlayer(),t.board]}}}),g.OddsAndEvens=c(P,{name:"OddsAndEvens",constructor:function(t,e){P.call(this,this.players),this.turns=isNaN(t)?1:+t,this.points=e||{Evens:0,Odds:0}},isSimultaneous:!0,players:["Evens","Odds"],moves:function(){return this.turns<1?null:{Evens:[1,2],Odds:[1,2]}},result:function(){var t=this.points.Evens-this.points.Odds;return this.turns>0?null:{Evens:+t,Odds:-t}},next:function(t,e,i){u("number"!=typeof t.Evens||"number"!=typeof t.Odds,"Invalid moves ",t,"!"),u(e,"Haps are not required (given ",e,")!");var n=(t.Evens+t.Odds)%2==0,r={Evens:this.points.Evens+(n?1:0),Odds:this.points.Odds+(n?0:1)};return i?(this.turns--,this.points=r,this):new this.constructor(this.turns-1,r)},"static __SERMAT__":{identifier:"OddsAndEvens",serializer:function(t){return[t.turns,t.points]}}}),g.TicTacToe=c(P,{name:"TicTacToe",constructor:function(t,e){P.call(this,t),this.board=e||"_________"},players:["Xs","Os"],result:function(){return this.board.match(this.WIN_X)?this.victory(["Xs"]):this.board.match(this.WIN_O)?this.victory(["Os"]):this.board.indexOf("_")<0?this.tied():null},moves:function(){if(this.result())return null;var t={};return t[this.activePlayer()]=l(this.board).filter(function(t,e){return"_"===t},function(t,e){return e}).toArray(),t},next:function(t,e,i){u(e,"Haps are not required (given ",e,")!");var n=this.activePlayer(),r=+t[n];if(isNaN(r)||"_"!==this.board.charAt(r))throw new Error("Invalid move "+JSON.stringify(t)+" for board "+this.board+" (moves= "+JSON.stringify(t)+").");var s=this.board.substring(0,r)+n.charAt(0)+this.board.substring(r+1);return i?(this.activatePlayers(this.opponent(n)),this.board=s,this):new this.constructor(this.opponent(n),s)},"static __SERMAT__":{identifier:"TicTacToe",serializer:function(t){return[t.activePlayer(),t.board]}},__hash__:function(t){var e={_:0,X:1,O:2};return parseInt((t||this.board).split("").map(function(t){return e[t]}).join(""),3)},equivalent:(B="210543876 678345012 630741852 258147036 876543210 852741630 036147258".split(" ").map(function(t){return t.split("").map(function(t){return+t})}),I=function(){var t=this.board,e=B.map(function(e){return e.map(function(e){return t.charAt(e)}).join("")});return e.sort(),e},I.MAPPINGS=B,I),printBoard:function(){var t=this.board;return[0,3,6].map(function(e){return t.substr(0,3).split("").join("|")}).join("\n-+-+-\n")},"static heuristics":{heuristicFromWeights:function(t){var e=l(t).map(Math.abs).sum();function i(i,n){var r=n.charAt(0);return l(i.board).map(function(e,i){return"_"===e?0:t[i]*(e===r?1:-1)}).sum()/e}return i.weights=t,i}},"":function(){var t=new T(3,3,"_".repeat(9)),e=t.sublines(t.lines(),3);this.prototype.WIN_X=new RegExp(t.asRegExps(e,"X",".")),this.prototype.WIN_O=new RegExp(t.asRegExps(e,"O",".")),this.heuristics.defaultHeuristic=this.heuristics.heuristicFromWeights([2,1,2,1,5,1,2,1,2])}}),g.ToadsAndFrogs=c(P,{name:"ToadsAndFrogs",constructor:function t(e,i){P.call(this,e),this.board=i||t.board()},"static board":function(t,e){return t=isNaN(t)?3:+t,e=isNaN(e)?2:+e,"T".repeat(t)+"_".repeat(e)+"F".repeat(t)},players:["Toads","Frogs"],result:function(){return this.moves()?null:this.defeat()},moves:function(){var t=this.activePlayer(),e={},i=e[t]=[];return this.board.replace(t==this.players[0]?/TF?_/g:/_T?F/g,function(t,e){return i.push(e),t}),i.length>0?e:null},next:function(t,e,i){u(e,"Haps are not required (given ",e,")!");var n,r=this.activePlayer(),s=t[r],a=(r.charAt(0),this.board);if("T_"==a.substr(s,2))n=a.substring(0,s)+"_T"+a.substring(s+2);else if("_F"==a.substr(s,2))n=a.substring(0,s)+"F_"+a.substring(s+2);else if("TF_"==a.substr(s,3))n=a.substring(0,s)+"_FT"+a.substring(s+3);else{if("_TF"!=a.substr(s,3))throw new Error("Invalid move ",s," for board <",a,">.");n=a.substring(0,s)+"FT_"+a.substring(s+3)}return i?(this.activatePlayers(this.opponent()),this.board=n,this):new this.constructor(this.opponent(),n)},"static __SERMAT__":{identifier:"ToadsAndFrogs",serializer:function(t){return[t.activePlayer(),t.board]}},__hash__:function(t,e){var i={_:0,T:1,F:2};return t=(t||this.activePlayer()).charAt(0),e=e||this.board,parseInt((t+e).split("").map(function(t){return i[t]}).join(""),3)}}),g.Pig=c(P,{name:"Pig",constructor:function(t,e,i,n){P.call(this,t),this.goal=isNaN(e)?100:+e,this.__scores__=i||l(this.players).zip([0,0]).toObject(),this.__rolls__=n||[]},isDeterministic:!1,players:["One","Two"],moves:function(){if(!this.result()){var t=this.activePlayer(),e=this.__scores__[t]+l(this.__rolls__).sum();return s(t,this.__rolls__.length<1?["roll"]:e>=this.goal?["hold"]:["roll","hold"])}},result:function(){var t=this.__scores__[this.players[0]],e=this.__scores__[this.players[1]];if(t>=this.goal||e>=this.goal){var i={};return i[this.players[0]]=Math.min(this.goal,t)-Math.min(this.goal,e),i[this.players[1]]=-i[this.players[0]],i}},next:function(t,e,i){var n=this.activePlayer(),r=t&&t[n];u(!r,"No move for active player ",n," at ",this,"!");var s=this.opponent(),c=this.__scores__,h=[];if("hold"===r||"roll"===r){if("hold"===r)(c=a(c))[n]+=l(this.__rolls__).sum();else{var _=0|(e&&e.die);if(!_)return new x(this,t,{die:y.dice.D6},i);if(_>1)return s=n,h=this.__rolls__.concat(_),new this.constructor(n,this.goal,this.__scores__,this.__rolls__.concat(_))}return i?(this.activatePlayers(s),this.__scores__=c,this.__rolls__=h,this):new this.constructor(s,this.goal,c,h)}o("Invalid moves ",JSON.stringify(t)," at ",this,"!")},resultBounds:function(){return[-this.goal,+this.goal]},"static __SERMAT__":{identifier:"Pig",serializer:function(t){return[t.activePlayer(),t.goal,t.__scores__,t.__rolls__]}}}),g.Mutropas=c(P,{name:"Mutropas",players:["Left","Right"],constructor:function(t){P.call(this,this.players),t=t||{},this.playedPieces=t.playedPieces||[],this.pieces=t.pieces||this.dealPieces(t.random),this.__scores__=t.scores||s(this.players[0],0,this.players[1],0)},isDeterministic:!1,isSimultaneous:!0,allPieces:h.range(9).toArray(),dealPieces:function(t){t=t||f.DEFAULT;var e=this.allPieces.length/2|0,i=t.split(e,this.allPieces),n=t.split(e,i[1]);return s(this.players[0],i[0],this.players[1],n[0])},moves:function(){return this.result()?null:a({},this.pieces)},moveResult:function(t,e){var i=l(this.allPieces).max(0)+1;return t<e?e-t<=i/2?1:-1:t>e?t-e>=i/2+1?1:-1:0},next:function(t,e,i){var n=this.players[0],r=this.players[1];if(!this.pieces[n]||!this.pieces[r])return this.__viewNext__(t,e,i);var a=t[n],o=t[r],c=this.pieces;u(c[n].indexOf(a)<0,"Invalid move ",JSON.stringify(a)," for player ",n,"! (moves= ",JSON.stringify(t),")"),u(c[r].indexOf(o)<0,"Invalid move ",JSON.stringify(o)," for player ",r,"! (moves= ",JSON.stringify(t),")");var h=this.moveResult(a,o),l=this.playedPieces.concat([a,o]),_=s(n,c[n].filter(function(t){return t!==a}),r,c[r].filter(function(t){return t!==o})),f=s(n,this.__scores__[n]+h,r,this.__scores__[r]-h);return i?(this.playedPieces=l,this.pieces=_,this.__scores__=f,this):new this.constructor({playedPieces:l,pieces:_,scores:f})},__viewNext__:function(t,e,i){var n=this.pieces[this.players[0]]?this.players[0]:this.players[1],r=this.opponent(n);return e?new this.constructor({pieces:s(n,this.pieces[n],r,e[r]),playedPieces:this.playedPieces,scores:this.__scores__}).next(t,null,i):this.contingent(t,s(n,y.uniformAleatory(this.__possiblePieces__(r))),i)},scores:function(){return a({},this.__scores__)},result:function(){var t=this.players;if(this.playedPieces.length>=this.allPieces.length-1){var e=this.scores();return this.zerosumResult(e[t[0]]-e[t[1]],t[0])}return null},__possiblePieces__:function(t){var e=this.playedPieces,i=this.pieces[this.opponent(t)],n=l(this.allPieces).filter(function(t){return e.indexOf(t)<0&&i.indexOf(t)<0});return n.combinations(n.count()-1)},view:function(t){return new this.constructor({pieces:s(t,this.pieces[t]),playedPieces:this.playedPieces,scores:this.__scores__})},"static __SERMAT__":{identifier:"Mutropas",serializer:function(t){return[{pieces:t.pieces,playedPieces:t.playedPieces,scores:t.__scores__}]}}}),g.Bahab=c(P,{name:"Bahab",players:["Uppercase","Lowercase"],constructor:function(t,e){P.call(this,t),this.board=e instanceof T?e:new T(5,5,e||this.initialBoard)},initialBoard:["BBABB","BBBBB",".....","bbbbb","bbabb"].join(""),__PLAYER_ENDGAME_RE__:{Uppercase:/^[.Bab]+$|^.{0,4}[a]/,Lowercase:/^[.bAB]+$|[A].{0,4}$/},result:function(){for(var t,e=this.board.string,i=0;i<2;++i)if(t=this.players[i],e.match(this.__PLAYER_ENDGAME_RE__[t]))return this.defeat(t);return this.moves()?null:this.defeat(this.activePlayer())},__PLAYER_PIECES_RE__:{Uppercase:/[AB]/g,Lowercase:/[ab]/g},moves:function(){var t=this.activePlayer(),e=this.__PLAYER_PIECES_RE__[t],i=this.board,n=[];return i.string.replace(e,function(t,r){var s,a=[r/5|0,r%5];switch(t){case"A":s=[[1,-1],[-1,0],[1,1]];break;case"B":s=[[1,-1],[1,1]];break;case"a":s=[[-1,-1],[1,0],[-1,1]];break;case"b":s=[[-1,-1],[-1,1]]}return l(s).forEachApply(function(r,s){var o=[a[0]+r,a[1]+s],u=i.square(o);!i.isValidCoord(o)||u.match(e)||"."!=u&&t.toLowerCase()!=u.toLowerCase()||n.push([a,o])}),t}),n.length>0?s(t,n):null},next:function(t,e,i){u(e,"Haps are not required (given ",e,")!"),u(!t,"Invalid moves ",t,"!");var n=this.activePlayer(),r=t[n];u(!Array.isArray(t[n]),"Invalid moves ",t,"!");var s=this.board.move(r[0],r[1]);return i?(this.activatePlayers(this.opponent()),this.board=s,this):new this.constructor(this.opponent(),s)},"static __SERMAT__":{identifier:"Bahab",serializer:function(t){return[t.activePlayer(),t.board]}}}),g.Puzzle15=c(P,{name:"Puzzle15",players:["Player"],width:4,height:4,target:"0123456789ABCDE ",maxMoves:81,constructor:function(t){P.call(this,this.players[0]),t=t||{},this.board=t.board||this.randomBoard(),this.moveNumber=0|t.moveNumber},randomBoard:function(t,e,i,n){return t=0|t||this.width,e=0|e||this.height,i=i||f.DEFAULT,n=n||h.range(t*e-1).map(function(t){return t.toString(36)}).join("").toUpperCase(),new T(t,e,i.shuffle(" "+n.substr(0,t*e-1)).join("")," ")},differences:function(t){t=t||this.target;var e=this.board.string;return l(e).zip(t).map(function(t){return t[0]===t[1]?0:1}).sum()},scores:function(){return s(this.players[0],this.maxMoves-this.moveNumber)},result:function(){return 0===this.differences()?this.victory():this.moveNumber>=this.maxMoves?this.defeat():null},emptyCoord:function(){var t=this.board.string.indexOf(" "),e=this.board.width;return[t/e|0,t%e]},moves:function(){var t=this.emptyCoord();this.board;return this.result()?null:{Player:l(S.DIRECTIONS.ORTHOGONAL).mapApply(function(e,i){return[t[0]+e,t[1]+i]},this.board.isValidCoord.bind(this.board)).toArray()}},next:function(t,e,i){u(e,"Haps are not required (given ",e,")!");var n=this.board.swap(this.emptyCoord(),t.Player);return i?(this.board=n,this.moveNumber++,this):new this.constructor({board:n,moveNumber:this.moveNumber+1})},"static __SERMAT__":{identifier:"Puzzle15",serializer:function(t){return[{board:t.board,moveNumber:t.moveNumber}]}}}),w.RoundRobin=c(N,{constructor:function(t,e,i){N.call(this,t,e),this.matchCount=isNaN(i)?t.players.length:+i,this.__advance__=this.__matches__().chain(h.repeat(null)).__iter__()},__matches__:function(){var t=this.game;return l(this.players).permutations(t.players.length).product(h.range(this.matchCount)).map(function(e){return new M(t,e[0])})},"static __SERMAT__":{identifier:"RoundRobin",serializer:function(t){return[t.game,t.players,t.matchCount]}}}),w.Measurement=c(N,{constructor:function(t,e,i,n){N.call(this,t,Array.isArray(e)?e:[e]),this.opponents=Array.isArray(i)?i:[i],u(this.opponents.length<t.players.length-1,"Not enough opponents."),this.matchCount=isNaN(n)?t.players.length:+n,this.__advance__=this.__matches__().chain(h.repeat(null)).__iter__()},__matches__:function(){var t=this.game,e=t.players.length,i=l(this.opponents);return i=e>2?i.product.apply(i,h.repeat(this.opponents,e-2).toArray()):i.map(function(t){return[t]}),l(this.players).product(h.range(e),i,h.range(this.matchCount)).map(function(e){var i=e[2].slice(0);return i.splice(e[1],0,e[0]),new M(t,i)})},"static __SERMAT__":{identifier:"Measurement",serializer:function(t){return[t.game,t.players,t.opponents,t.matchCount]}}}),w.Elimination=c(N,{constructor:function(t,e,i){N.call(this,t,e),this.matchCount=isNaN(i)?1:+i>>0},__bracket__:function(t){var e=this.game,i=this.matchCount,n=this.game.players.length;return(t=t||this.players).length<n?[]:h.range(0,t.length,n).map(function(r){var s=h.range(r,r+n).map(function(e){return t[e%t.length]}).toArray();return h.range(i).map(function(t){return s.unshift(s.pop()),new M(e,s)}).toArray()}).toArray()},__playoff__:function(t){var e={},i={};t.forEach(function(t){var n=t.result();if(!n)throw new Error("Unfinished match in playoff!");l(t.players).forEach(function(t){var r=t[0],s=t[1].name;e[s]=(+e[s]||0)+n[r],i[s]=t[1]})});var n=l(e).greater(function(t){return t[1]})[0][0];return i[n]},__advance__:function(){if(!this.__matches__||this.__matches__.length<1){if(this.__currentBracket__){if(this.__currentBracket__.length<1)return null;var t=this.__currentBracket__.map(this.__playoff__);this.__currentBracket__=this.__bracket__(t)}else this.__currentBracket__=this.__bracket__(this.players);this.__matches__=l(this.__currentBracket__).flatten().toArray()}return this.__matches__.shift()},"static __SERMAT__":{identifier:"Elimination",serializer:function(t){return[t.game,t.players,t.matchCount]}}}),[M,g.Bahab,g.Choose2Win,g.ConnectionGame,g.Mutropas,g.OddsAndEvens,g.Pig,g.Predefined,g.TicTacToe,g.ToadsAndFrogs,g.Puzzle15,E,b.AlphaBetaPlayer,b.MaxNPlayer,b.MiniMaxPlayer,b.MonteCarloPlayer,b.RandomPlayer,b.TracePlayer,b.UCTPlayer,N,w.Elimination,w.Measurement,w.RoundRobin,y.Aleatory,y.DieAleatory,A.CheckerboardFromString].forEach(function(t){t.__SERMAT__.identifier=v.__package__+"."+t.__SERMAT__.identifier,v.__SERMAT__.include.push(t)}),i.include(v),v});
//# sourceMappingURL=ludorum.min.js.map