<!DOCTYPE html><html lang="en"><head><title>src\games\Mancala</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src\games\Mancala"><meta name="groc-project-path" content="src\games\Mancala.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src\games\Mancala.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Implementation of the Kalah member of the Mancala family of games.</p></div></div><div class="code"><div class="wrapper"><span class="nx">games</span><span class="p">.</span><span class="nx">Mancala</span> <span class="o">=</span> <span class="nx">declare</span><span class="p">(</span><span class="nx">Game</span><span class="p">,</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>new games.Mancala(activePlayer="North", board=makeBoard()):
    TODO.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">Mancala</span><span class="p">(</span><span class="nx">activePlayer</span><span class="p">,</span> <span class="nx">board</span><span class="p">){</span>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">activePlayer</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">board</span> <span class="o">=</span> <span class="nx">board</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeBoard</span><span class="p">();</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.makeBoard(seeds=3, houses=6):
    Builds a board array to use as the game state.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">makeBoard</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">makeBoard</span><span class="p">(</span><span class="nx">seeds</span><span class="p">,</span> <span class="nx">houses</span><span class="p">){</span>
    <span class="nx">seeds</span> <span class="o">=</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">seeds</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="o">+</span><span class="nx">seeds</span><span class="p">;</span>
    <span class="nx">houses</span> <span class="o">=</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">houses</span><span class="p">)</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="o">+</span><span class="nx">houses</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">houses</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">seeds</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">},</span>
  
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Mancala&#39;</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.players:
    Players of Mancala are North and South.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">players</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span> <span class="s2">&quot;South&quot;</span><span class="p">],</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.emptyCapture=false:
    If true, making a capture only moves the active player's seed to his
    store. The opponents seeds are not captured.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">emptyCapture</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.countRemainingSeeds=true:
    If true, at the end of the game if a player has seeds on his houses,
    those seeds are included in his score.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">countRemainingSeeds</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.store(player):
    Returns the index in this game's board of the player's store.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">store</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">store</span><span class="p">(</span><span class="nx">player</span><span class="p">){</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">player</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Store of North.</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Store of South.</span>
      <span class="k">default</span><span class="o">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid player &quot;</span><span class="o">+</span> <span class="nx">player</span> <span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.houses(player):
    Returns an array with the indexes of the player's houses in this
    game's board.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">houses</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">houses</span><span class="p">(</span><span class="nx">player</span><span class="p">){</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">player</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">return</span> <span class="nx">Iterable</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span> <span class="c1">// Store of North.</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="nx">Iterable</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span> <span class="c1">// Store of South.</span>
      <span class="k">default</span><span class="o">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid player &quot;</span><span class="o">+</span> <span class="nx">player</span> <span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.oppositeHouse(player, i):
    Returns the index of the opposite house of i for the given player,
    or a negative if i is not a house of the given player.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">oppositeHouse</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">oppositeHouse</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">playerHouses</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="nx">player</span><span class="p">),</span>
      <span class="nx">opponentHouses</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">opponent</span><span class="p">(</span><span class="nx">player</span><span class="p">)),</span>
      <span class="nx">index</span> <span class="o">=</span> <span class="nx">playerHouses</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">index</span> <span class="o">:</span> <span class="nx">opponentHouses</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()[</span><span class="nx">index</span><span class="p">];</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.nextSquare(player, i):
    Returns the index of the square following i for the given player.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">nextSquare</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">nextSquare</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">i</span><span class="p">){</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">opponent</span><span class="p">(</span><span class="nx">player</span><span class="p">)));</span>
    <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.moves():
    A move for this game is an index of the square in the board.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">moves</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">moves</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">activePlayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlayer</span><span class="p">();</span>     
      <span class="nx">result</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="nx">activePlayer</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">house</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">board</span><span class="p">[</span><span class="nx">house</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// The house has seeds.</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">result</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.scores():
    The game ends when the active player cannot move. The score for
    each player is the seed count of its store and (if countRemainingSeeds
    is true) the houses on its side of the board.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">scores</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">scores</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">board</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span>
      <span class="nx">sides</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">iterable</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="nx">player</span><span class="p">)).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">board</span><span class="p">[</span><span class="nx">h</span><span class="p">];</span>
        <span class="p">}).</span><span class="nx">sum</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">sides</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Both sides have seeds.</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// One side has no seeds.</span>
      <span class="kd">var</span> <span class="nx">_scores</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_scores</span><span class="p">[</span><span class="nx">player</span><span class="p">]</span> <span class="o">=</span> <span class="nx">board</span><span class="p">[</span><span class="nx">game</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">player</span><span class="p">)]</span> <span class="o">+</span> <span class="nx">game</span><span class="p">.</span><span class="nx">countRemainingSeeds</span> <span class="o">*</span> <span class="nx">sides</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">_scores</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.result():
    The game ends when the active player cannot move. The result for
    each player is the difference between the seed count of the stores.
    If a player has seeds in his side, those are added to his count.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">result</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">result</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">scores</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">scores</span><span class="p">(),</span>
      <span class="nx">players</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">scores</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">zerosumResult</span><span class="p">(</span><span class="nx">scores</span><span class="p">[</span><span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="nx">scores</span><span class="p">[</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.next(moves):
    TODO.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">next</span><span class="p">(</span><span class="nx">moves</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">activePlayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlayer</span><span class="p">(),</span> 
      <span class="nx">move</span> <span class="o">=</span> <span class="o">+</span><span class="nx">moves</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">],</span>
      <span class="nx">newBoard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="nx">seeds</span> <span class="o">=</span> <span class="nx">newBoard</span><span class="p">[</span><span class="nx">move</span><span class="p">],</span>
      <span class="nx">freeTurn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">store</span><span class="p">,</span> <span class="nx">oppositeHouse</span><span class="p">;</span>
    <span class="nx">raiseIf</span><span class="p">(</span><span class="nx">seeds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Invalid move &quot;</span><span class="p">,</span> <span class="nx">move</span><span class="p">,</span> <span class="s2">&quot; for game &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Move.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">newBoard</span><span class="p">[</span><span class="nx">move</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">seeds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">seeds</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">move</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextSquare</span><span class="p">(</span><span class="nx">activePlayer</span><span class="p">,</span> <span class="nx">move</span><span class="p">);</span>
      <span class="nx">newBoard</span><span class="p">[</span><span class="nx">move</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Free turn if last square of the move is the player's store.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">freeTurn</span> <span class="o">=</span> <span class="nx">move</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">activePlayer</span><span class="p">);</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Capture.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">freeTurn</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">oppositeHouse</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oppositeHouse</span><span class="p">(</span><span class="nx">activePlayer</span><span class="p">,</span> <span class="nx">move</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">oppositeHouse</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">newBoard</span><span class="p">[</span><span class="nx">move</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">newBoard</span><span class="p">[</span><span class="nx">oppositeHouse</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">store</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">activePlayer</span><span class="p">);</span>
        <span class="nx">newBoard</span><span class="p">[</span><span class="nx">store</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
        <span class="nx">newBoard</span><span class="p">[</span><span class="nx">move</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">emptyCapture</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">newBoard</span><span class="p">[</span><span class="nx">store</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">newBoard</span><span class="p">[</span><span class="nx">oppositeHouse</span><span class="p">];</span>
          <span class="nx">newBoard</span><span class="p">[</span><span class="nx">oppositeHouse</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>         
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">(</span><span class="nx">freeTurn</span> <span class="o">?</span> <span class="nx">activePlayer</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">opponent</span><span class="p">(),</span> <span class="nx">newBoard</span><span class="p">);</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.resultBounds():
    Result bounds are estimated with the total number of stones in the
    board. It is very unlikely to get these result though.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">resultBounds</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">resultBounds</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stoneCount</span> <span class="o">=</span> <span class="nx">iterable</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">).</span><span class="nx">sum</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="nx">stoneCount</span><span class="p">,</span><span class="o">+</span><span class="nx">stoneCount</span><span class="p">];</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Utility methods. ////////////////////////////////////////////////////</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">__serialize__</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">__serialize__</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlayer</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">slice</span><span class="p">()];</span>
  <span class="p">},</span>

  <span class="nx">identifier</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">identifier</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlayer</span><span class="p">().</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;00&#39;</span><span class="o">+</span> <span class="nx">n</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">)).</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.toString():
    Text version of the Mancala board.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">lpad</span> <span class="o">=</span> <span class="nx">basis</span><span class="p">.</span><span class="nx">Text</span><span class="p">.</span><span class="nx">lpad</span><span class="p">,</span>
      <span class="nx">north</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">northHouses</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="nx">north</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">lpad</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">+</span> <span class="nx">game</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">h</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
      <span class="p">}).</span><span class="nx">reverse</span><span class="p">(),</span>
      <span class="nx">northStore</span> <span class="o">=</span> <span class="nx">lpad</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">north</span><span class="p">)],</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
      <span class="nx">south</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">southHouses</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="nx">south</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">lpad</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">+</span> <span class="nx">game</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">h</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
      <span class="p">}),</span>
      <span class="nx">southStore</span> <span class="o">=</span> <span class="nx">lpad</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">south</span><span class="p">)],</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;   &quot;</span><span class="o">+</span> <span class="nx">northHouses</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; | &quot;</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;   \n&quot;</span><span class="o">+</span>
      <span class="nx">northStore</span> <span class="o">+</span><span class="s2">&quot; &quot;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">northHouses</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nx">northHouses</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">southStore</span> <span class="o">+</span><span class="s2">&quot;\n&quot;</span><span class="o">+</span>
      <span class="s2">&quot;   &quot;</span><span class="o">+</span> <span class="nx">southHouses</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; | &quot;</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;   &quot;</span><span class="p">;</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.toHTML():
    Renders the Mancala board as a HTML table.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">toHTML</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">toHTML</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">moves</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">moves</span><span class="p">(),</span>
      <span class="nx">north</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">south</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">function</span> <span class="nx">renderHouse</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">moves</span> <span class="o">||</span> <span class="o">!</span><span class="nx">moves</span><span class="p">[</span><span class="nx">player</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="nx">moves</span><span class="p">[</span><span class="nx">player</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Not a move.</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;td&gt;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;td data-ludorum=&quot;move:&#39;</span><span class="o">+</span> <span class="nx">h</span> <span class="o">+</span><span class="s1">&#39;, activePlayer: \&#39;&#39;</span><span class="o">+</span> <span class="nx">player</span> <span class="o">+</span><span class="s1">&#39;\&#39;&quot;&gt;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;table&gt;&lt;tr&gt;&#39;</span>
      <span class="o">+</span> <span class="s1">&#39;&lt;td rowspan=&quot;2&quot;&gt;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">north</span><span class="p">)]</span> <span class="o">+</span><span class="s1">&#39;&lt;/td&gt;&#39;</span>
      <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="nx">north</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">renderHouse</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">north</span><span class="p">)).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
      <span class="o">+</span> <span class="s1">&#39;&lt;td rowspan=&quot;2&quot;&gt;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">south</span><span class="p">)]</span> <span class="o">+</span><span class="s1">&#39;&lt;/td&gt;&#39;</span>
      <span class="o">+</span> <span class="s1">&#39;&lt;/tr&gt;&lt;tr&gt;&#39;</span>
      <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">houses</span><span class="p">(</span><span class="nx">south</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">renderHouse</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">south</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
      <span class="o">+</span> <span class="s1">&#39;&lt;/tr&gt;&lt;/table&gt;&#39;</span><span class="p">;</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Heuristics. /////////////////////////////////////////////////////////////////</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>static games.Mancala.heuristics:
    Bundle of heuristic evaluation functions for Mancala.</p></div></div><div class="code"><div class="wrapper">  <span class="s1">&#39;static heuristics&#39;</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.heuristics.heuristicFromWeights(weights=default weights):
    Builds an heuristic evaluation function from weights for each square 
    in the board. The result of the function is the normalized weighted 
    sum.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">heuristicFromWeights</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">heuristicFromWeights</span><span class="p">(</span><span class="nx">weights</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">weightSum</span> <span class="o">=</span> <span class="nx">iterable</span><span class="p">(</span><span class="nx">weights</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">).</span><span class="nx">sum</span><span class="p">();</span>
      <span class="kd">function</span> <span class="nx">__heuristic__</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">seedSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">signum</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">players</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">player</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="nx">signum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// North.</span>
          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="nx">signum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// South.</span>
          <span class="k">default</span><span class="o">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid player &quot;</span><span class="o">+</span> <span class="nx">player</span> <span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">iterable</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">board</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">seeds</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">seedSum</span> <span class="o">+=</span> <span class="nx">seeds</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">seeds</span> <span class="o">*</span> <span class="nx">weights</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="c1">//TODO Normalize weights before.</span>
        <span class="p">}).</span><span class="nx">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nx">weightSum</span> <span class="o">/</span> <span class="nx">seedSum</span> <span class="o">*</span> <span class="nx">signum</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">__heuristic__</span><span class="p">.</span><span class="nx">weights</span> <span class="o">=</span> <span class="nx">weights</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">__heuristic__</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Static initializer. /////////////////////////////////////////////////////////</p></div></div><div class="code"><div class="wrapper">  
  <span class="s1">&#39;&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">makeBoard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeBoard</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>games.Mancala.heuristics.defaultHeuristic(game, player):
    Default heuristic for Mancala, based on weights for each square.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">heuristics</span><span class="p">.</span><span class="nx">defaultHeuristic</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">heuristics</span><span class="p">.</span><span class="nx">heuristicFromWeights</span><span class="p">(</span>
      <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> 
       <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span> <span class="c1">// declare Mancala.</span></div></div></div></div></body></html>