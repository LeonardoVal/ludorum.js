<!DOCTYPE html><html lang="en"><head><title>src\players\WebWorkerPlayer</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src\players\WebWorkerPlayer"><meta name="groc-project-path" content="src\players\WebWorkerPlayer.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src\players\WebWorkerPlayer.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>A proxy for another player executing inside a webworker.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">WebWorkerPlayer</span> <span class="o">=</span> <span class="nx">players</span><span class="p">.</span><span class="nx">WebWorkerPlayer</span> <span class="o">=</span> <span class="nx">declare</span><span class="p">(</span><span class="nx">Player</span><span class="p">,</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>new players.WebWorkerPlayer(params):
    Builds a player that is a proxy for another player executing in a web
    worker.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">WebWorkerPlayer</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Player</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="nx">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.WebWorkerPlayer.worker:
    The Worker instance where the actual player is executing.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="s1">&#39;worker&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">basis</span><span class="p">.</span><span class="nx">Parallel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__onmessage__</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>static WebWorkerPlayer.createWorker(playerBuilder):
    Asynchronously creates and initializes a web worker. The modules basis
    and ludorum are loaded in the global namespace (self), before calling 
    the given playerBuilder function. Its results will be stored in the 
    global variable PLAYER.</p></div></div><div class="code"><div class="wrapper">  <span class="s2">&quot;static createWorker&quot;</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">createWorker</span><span class="p">(</span><span class="nx">playerBuilder</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">raiseIf</span><span class="p">(</span><span class="s1">&#39;string function&#39;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">playerBuilder</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> 
      <span class="s2">&quot;Invalid player builder: &quot;</span><span class="o">+</span> <span class="nx">playerBuilder</span> <span class="o">+</span><span class="s2">&quot;!&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">parallel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">basis</span><span class="p">.</span><span class="nx">Parallel</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">parallel</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="s1">&#39;self.ludorum = (&#39;</span><span class="o">+</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">__init__</span> <span class="o">+</span><span class="s1">&#39;)(self.basis), &quot;OK&quot;&#39;</span>
      <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">parallel</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="s1">&#39;self.PLAYER = (&#39;</span><span class="o">+</span> <span class="nx">playerBuilder</span> <span class="o">+</span><span class="s1">&#39;).call(self), &quot;OK&quot;&#39;</span><span class="p">);</span>
      <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">parallel</span><span class="p">.</span><span class="nx">worker</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>static WebWorkerPlayer.create(params):
    Asynchronously creates and initializes a WebWorkerPlayer, with a web 
    worker ready to play. The params must include the playerBuilder function
    to execute on the web worker's environment.</p></div></div><div class="code"><div class="wrapper">  <span class="s2">&quot;static create&quot;</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">WebWorkerPlayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">WebWorkerPlayer</span><span class="p">.</span><span class="nx">createWorker</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">playerBuilder</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">worker</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">WebWorkerPlayer</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">worker</span><span class="o">:</span> <span class="nx">worker</span><span class="p">});</span> 
    <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.WebWorkerPlayer.decision(game, player):
    The decision is delegated to this player's webworker, returning a future
    that will be resolved when the parallel execution is over. 
    Warning! If this method is called while another decision is pending, the 
    player will assume the previous match was aborted, issuing a QUIT 
    command.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">decision</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">decision</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__future__</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">__future__</span><span class="p">.</span><span class="nx">isPending</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">__future__</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">Match</span><span class="p">.</span><span class="nx">commandQuit</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__future__</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Future</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="s1">&#39;PLAYER.decision(ludorum.Game.fromJSON(&#39;</span><span class="o">+</span> <span class="nx">game</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> 
      <span class="o">+</span><span class="s1">&#39;), &#39;</span><span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__future__</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span> <span class="c1">// declare WebWorkerPlayer</span></div></div></div></div></body></html>