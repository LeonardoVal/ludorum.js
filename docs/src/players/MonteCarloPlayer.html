<!DOCTYPE html><html lang="en"><head><title>src\players\MonteCarloPlayer</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src\players\MonteCarloPlayer"><meta name="groc-project-path" content="src\players\MonteCarloPlayer.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src\players\MonteCarloPlayer.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Automatic player based on pure Monte Carlo tree search.</p></div></div><div class="code"><div class="wrapper"><span class="nx">players</span><span class="p">.</span><span class="nx">MonteCarloPlayer</span> <span class="o">=</span> <span class="nx">declare</span><span class="p">(</span><span class="nx">HeuristicPlayer</span><span class="p">,</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>new players.MonteCarloPlayer(params):
    Builds a player that chooses its moves using the <a href="http://en.wikipedia.org/wiki/Monte-Carlo_tree_search">pure Monte Carlo game
    tree search method</a>.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">MonteCarloPlayer</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">HeuristicPlayer</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="nx">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.MonteCarloPlayer.simulationCount=30:
    Maximum amount of simulations performed for each available move at
    each decision.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">number</span><span class="p">(</span><span class="s1">&#39;simulationCount&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">defaultValue</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span> <span class="nx">coerce</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.MonteCarloPlayer.timeCap=1000ms:
    Time limit for the player to decide.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">number</span><span class="p">(</span><span class="s1">&#39;timeCap&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">defaultValue</span><span class="o">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="nx">coerce</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.MonteCarloPlayer.agent:
    Player instance used in the simulations. If undefined moves are
    chosen at random.
    Warning! Agent with asynchronous decisions are not supported.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="s1">&#39;agent&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">defaultValue</span><span class="o">:</span> <span class="kc">null</span> <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.MonteCarloPlayer.selectMoves(moves, game, player):
    Return an array with the best evaluated moves.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">selectMoves</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">selectMoves</span><span class="p">(</span><span class="nx">moves</span><span class="p">,</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">monteCarloPlayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">endTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">timeCap</span><span class="p">,</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">moves</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">move</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span> <span class="nx">move</span><span class="o">:</span> <span class="nx">move</span><span class="p">,</span> <span class="nx">next</span><span class="o">:</span> <span class="nx">game</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">obj</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">move</span><span class="p">)),</span> 
          <span class="nx">isFinal</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">sum</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> 
        <span class="p">};</span>
      <span class="p">});</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">simulationCount</span> <span class="o">&amp;&amp;</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">endTime</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">option</span><span class="p">.</span><span class="nx">isFinal</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">sim</span> <span class="o">=</span> <span class="nx">monteCarloPlayer</span><span class="p">.</span><span class="nx">simulation</span><span class="p">(</span><span class="nx">option</span><span class="p">.</span><span class="nx">next</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
          <span class="nx">option</span><span class="p">.</span><span class="nx">isFinal</span> <span class="o">=</span> <span class="nx">sim</span><span class="p">.</span><span class="nx">plies</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">option</span><span class="p">.</span><span class="nx">sum</span> <span class="o">+=</span> <span class="nx">sim</span><span class="p">.</span><span class="nx">result</span><span class="p">[</span><span class="nx">player</span><span class="p">];</span>
          <span class="o">++</span><span class="nx">option</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">iterable</span><span class="p">(</span><span class="nx">options</span><span class="p">).</span><span class="nx">greater</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">option</span><span class="p">.</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">option</span><span class="p">.</span><span class="nx">sum</span> <span class="o">/</span> <span class="nx">option</span><span class="p">.</span><span class="nx">count</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">option</span><span class="p">.</span><span class="nx">move</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.MonteCarloPlayer.stateEvaluation(game, player):
    Runs this.simulationCount simulations and returns the average result.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">stateEvaluation</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">stateEvaluation</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resultSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
      <span class="nx">simulationCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">simulationCount</span><span class="p">,</span>
      <span class="nx">sim</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">simulationCount</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">simulation</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
      <span class="nx">resultSum</span> <span class="o">+=</span> <span class="nx">sim</span><span class="p">.</span><span class="nx">result</span><span class="p">[</span><span class="nx">player</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sim</span><span class="p">.</span><span class="nx">plies</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// game is final.</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">simulationCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">resultSum</span> <span class="o">/</span> <span class="nx">simulationCount</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>players.MonteCarloPlayer.simulation(game, player):
    Simulates a random match from the given game and returns an object with
    the final state (game), its result (result) and the number of plies 
    simulated (plies).</p></div></div><div class="code"><div class="wrapper">  <span class="nx">simulation</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">simulation</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mc</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">plies</span><span class="p">,</span> <span class="nx">move</span><span class="p">,</span> <span class="nx">moves</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">plies</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kc">true</span><span class="p">;</span> <span class="o">++</span><span class="nx">plies</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">game</span> <span class="k">instanceof</span> <span class="nx">Aleatory</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">moves</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">moves</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">moves</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span> <span class="nx">game</span><span class="o">:</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">game</span><span class="p">.</span><span class="nx">result</span><span class="p">(),</span> <span class="nx">plies</span><span class="o">:</span> <span class="nx">plies</span> <span class="p">};</span>
        <span class="p">}</span>
        <span class="nx">move</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">game</span><span class="p">.</span><span class="nx">activePlayers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">activePlayer</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">move</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mc</span><span class="p">.</span><span class="nx">agent</span> <span class="o">?</span> <span class="nx">mc</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">decision</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">activePlayer</span><span class="p">)</span> 
            <span class="o">:</span> <span class="nx">mc</span><span class="p">.</span><span class="nx">random</span><span class="p">.</span><span class="nx">choice</span><span class="p">(</span><span class="nx">moves</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">]);</span>
        <span class="p">});</span>
        <span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">move</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//return { game: game, result: game.result(), plies: plies };</span>
  <span class="p">},</span>
  
  <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;MonteCarloPlayer&#39;</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;(&#39;</span><span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
      <span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">simulationCount</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">simulationCount</span><span class="p">,</span> <span class="nx">timeCap</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">timeCap</span>
    <span class="p">})</span> <span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span> <span class="c1">// declare MonteCarloPlayer</span></div></div></div></div></body></html>