<!DOCTYPE html><html lang="en"><head><title>src\utils\Scanner</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src\utils\Scanner"><meta name="groc-project-path" content="src\utils\Scanner.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src\utils\Scanner.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Component for scanning a game's tree.</p></div></div><div class="code"><div class="wrapper"><span class="nx">exports</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Scanner</span> <span class="o">=</span> <span class="nx">declare</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>new utils.Scanner(config):
    A Scanner builds a sample of a game tree, in order to get statistics 
    from some of all possible matches.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">Scanner</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.game:
    Game to scan.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignore</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.maxWidth=1000:
    Maximum amount of game states held at each step.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="s2">&quot;maxWidth&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">defaultValue</span><span class="o">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="nx">coerce</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.maxLength=50:
    Maximum length of simulated matches.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="s2">&quot;maxLength&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">defaultValue</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span> <span class="nx">coerce</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.random=randomness.DEFAULT:
    Pseudorandom number generator to use in the simulations.</p></div></div><div class="code"><div class="wrapper">      
      <span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">defaultValue</span><span class="o">:</span> <span class="nx">Randomness</span><span class="p">.</span><span class="nx">DEFAULT</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.statistics:
    Component to gather relevant statistics. These include:
<code>game.result</code>: Final game state results. Also available for victory and defeat.
<code>game.length</code>: Match length in plies. Also available for victory and defeat.
<code>game.width</code>: Number of available moves.
<code>draw.length</code>: Drawn match length in plies.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="s2">&quot;statistics&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">defaultValue</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Statistics</span><span class="p">()</span> <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.scan(players, games...=[this.game]):
    Scans the trees of the given game (using this scanner's game by 
    default). This means reproducing and sampling the set of all possible 
    matches from the given game states. The simulation halts at maxLength
    plies, and never holds more than maxWidth game states.
    The players argument may provide a player for some or all of the games'
    roles. If available, they will be used to decide which move is applied
    to each game state. If missing, all next game states will be added. Ergo
    no players means a simulation off all possible matches.     </p></div></div><div class="code"><div class="wrapper">  <span class="nx">scan</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">scan</span><span class="p">(</span><span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">scanner</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nb">window</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">game</span> <span class="o">?</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">game</span><span class="p">]</span> <span class="o">:</span> <span class="p">[])</span> <span class="o">:</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
      <span class="nx">ply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="k">return</span> <span class="nx">Future</span><span class="p">.</span><span class="nx">whileDo</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">ply</span> <span class="o">&lt;</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">;</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Future</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">__advance__</span><span class="p">(</span><span class="nx">players</span><span class="p">,</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">ply</span><span class="p">);</span>
      <span class="p">})).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span> <span class="o">=</span> <span class="nx">iterable</span><span class="p">(</span><span class="nx">level</span><span class="p">).</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">sample</span><span class="p">(</span><span class="nx">scanner</span><span class="p">.</span><span class="nx">maxWidth</span><span class="p">,</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">random</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
        <span class="nx">ply</span><span class="o">++</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">scanner</span><span class="p">.</span><span class="nx">statistics</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;aborted&#39;</span><span class="p">},</span> <span class="nb">window</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">statistics</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.<strong>advance</strong>(players, game, ply):
    Advances the given game by one ply. This may mean for non final game 
    states either instantiate random variables, ask the available player 
    for a decision, or take all next game states. Final game states are 
    removed. All game states are accounted in the scanner's statistics. The
    result is an Iterable with the game states to add to the next scan
    window.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">__advance__</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">__advance__</span><span class="p">(</span><span class="nx">players</span><span class="p">,</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">ply</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">game</span> <span class="k">instanceof</span> <span class="nx">Aleatory</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">iterable</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">distribution</span><span class="p">()).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">game</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">account</span><span class="p">(</span><span class="nx">players</span><span class="p">,</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">ply</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Iterable</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">scanner</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">moves</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">moves</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">Future</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">activePlayers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">activePlayer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">players</span> <span class="o">&amp;&amp;</span> <span class="nx">players</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">])</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">decisionTime</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">stat</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;decision.time&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span> <span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span> <span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span> <span class="nx">p</span><span class="p">});</span>
          <span class="nx">decisionTime</span><span class="p">.</span><span class="nx">startTime</span><span class="p">();</span>
          <span class="k">return</span> <span class="nx">Future</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">players</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">].</span><span class="nx">decision</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">activePlayer</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">move</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">decisionTime</span><span class="p">.</span><span class="nx">addTime</span><span class="p">();</span>
            <span class="k">return</span> <span class="p">[</span><span class="nx">move</span><span class="p">];</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">moves</span><span class="p">[</span><span class="nx">activePlayer</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">})).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">decisions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Iterable</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">decisions</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">moves</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">game</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">iterable</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">activePlayers</span><span class="p">).</span><span class="nx">zip</span><span class="p">(</span><span class="nx">moves</span><span class="p">).</span><span class="nx">toObject</span><span class="p">());</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">},</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>utils.Scanner.account(players, game, ply):
    Gathers statistics about the game. Returns whether the given game state
    is final or not.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">account</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">account</span><span class="p">(</span><span class="nx">players</span><span class="p">,</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">ply</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">result</span><span class="p">(),</span>
      <span class="nx">stats</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">statistics</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">iterable</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">players</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">role</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span><span class="nx">role</span><span class="p">],</span>
          <span class="nx">p</span> <span class="o">=</span> <span class="nx">players</span> <span class="o">&amp;&amp;</span> <span class="nx">players</span><span class="p">[</span><span class="nx">role</span><span class="p">]</span> <span class="o">?</span> <span class="nx">players</span><span class="p">[</span><span class="nx">role</span><span class="p">].</span><span class="nx">name</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
          <span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;game:&#39;</span><span class="o">+</span> <span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;role:&#39;</span><span class="o">+</span> <span class="nx">role</span><span class="p">,</span> <span class="s1">&#39;player:&#39;</span><span class="o">+</span> <span class="nx">p</span><span class="p">];</span>
        <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;game.result&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">p</span><span class="p">},</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;game.length&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">p</span><span class="p">},</span> <span class="nx">ply</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;defeat.result&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">p</span><span class="p">},</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
          <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;defeat.length&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">p</span><span class="p">},</span> <span class="nx">ply</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;victory.result&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">p</span><span class="p">},</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
          <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;victory.result&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">p</span><span class="p">},</span> <span class="nx">ply</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;draw.length&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">p</span><span class="p">},</span> <span class="nx">ply</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">moves</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">moves</span><span class="p">();</span>
      <span class="nx">iterable</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">activePlayers</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">role</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;game.width&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">},</span> <span class="nx">moves</span><span class="p">[</span><span class="nx">role</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span> <span class="c1">// declare utils.Scanner.</span></div></div></div></div></body></html>