<!DOCTYPE html><html lang="en"><head><title>src\tournaments\Elimination</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src\tournaments\Elimination"><meta name="groc-project-path" content="src\tournaments\Elimination.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src\tournaments\Elimination.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="classelimination">Class <code>Elimination</code></h1>

<p>Playoffs or sudden death kind of contests, also known as 
<a href="http://en.wikipedia.org/wiki/Single-elimination_tournament">elimination tournaments</a>.
In this tournaments players get randomly matched in successive brackets, each 
match's winner passing to the next round until the final match. Games are 
assumed to have only one winner per match.</p></div></div><div class="code"><div class="wrapper"><span class="nx">tournaments</span><span class="p">.</span><span class="nx">Elimination</span> <span class="o">=</span> <span class="nx">declare</span><span class="p">(</span><span class="nx">Tournament</span><span class="p">,</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The constructor takes the <code>game</code> to be played, the <code>players</code> and the 
amount of matches that make each playoff (<code>matchCount</code>, 1 by default).</p></div></div><div class="code"><div class="wrapper">  <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">Elimination</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">players</span><span class="p">,</span> <span class="nx">matchCount</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Tournament</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">players</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">matchCount</span> <span class="o">=</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">matchCount</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">+</span><span class="nx">matchCount</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Each bracket is defined by partitioning the <code>players</code> in groups of the
size required by the game (usually two). If there are not enough players,
some players get reassigned. The bracket includes <code>matchCount</code> matches 
between these participants, rotating roles if possible.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">__bracket__</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">__bracket__</span><span class="p">(</span><span class="nx">players</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">game</span><span class="p">,</span>
      <span class="nx">matchCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">matchCount</span><span class="p">,</span>
      <span class="nx">roleCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">players</span> <span class="o">=</span> <span class="nx">players</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">roleCount</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">[];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Iterable</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">roleCount</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">participants</span> <span class="o">=</span> <span class="nx">Iterable</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">roleCount</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">players</span><span class="p">[</span><span class="nx">j</span> <span class="o">%</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">];</span> <span class="c1">// Fill by repeating players if necessary.</span>
        <span class="p">}).</span><span class="nx">toArray</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">Iterable</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">matchCount</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">participants</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">participants</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span> <span class="c1">// Rotate partipants roles.</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nx">Match</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">participants</span><span class="p">);</span>
        <span class="p">}).</span><span class="nx">toArray</span><span class="p">();</span>
      <span class="p">}).</span><span class="nx">toArray</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A playoff is resolved by aggregating the results of all its matches. The
winner of the playoff is the one with the greater result sum.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">__playoff__</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">__playoff__</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">playoffResult</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">players</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">matches</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">matchResult</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">result</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matchResult</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unfinished match in playoff!&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">iterable</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">players</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tuple</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">role</span> <span class="o">=</span> <span class="nx">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
          <span class="nx">playerName</span> <span class="o">=</span> <span class="nx">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
        <span class="nx">playoffResult</span><span class="p">[</span><span class="nx">playerName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">+</span><span class="nx">playoffResult</span><span class="p">[</span><span class="nx">playerName</span><span class="p">]</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">matchResult</span><span class="p">[</span><span class="nx">role</span><span class="p">];</span>
        <span class="nx">players</span><span class="p">[</span><span class="nx">playerName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">})</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">winnerName</span> <span class="o">=</span> <span class="nx">iterable</span><span class="p">(</span><span class="nx">playoffResult</span><span class="p">).</span><span class="nx">greater</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">pair</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">players</span><span class="p">[</span><span class="nx">winnerName</span><span class="p">];</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The elimination tournament runs until there is less players in the next
bracket than the amount required to play the game. Since this amount is 
usually two, the contest ends with one player at the top.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">__advance__</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">__advance__</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__matches__</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">__matches__</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__currentBracket__</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// First bracket.</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__currentBracket__</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__bracket__</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">players</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__currentBracket__</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Tournament is finished.</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Second and on brackets.</span>
        <span class="kd">var</span> <span class="nx">players</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__currentBracket__</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__playoff__</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__currentBracket__</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__bracket__</span><span class="p">(</span><span class="nx">players</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">__matches__</span> <span class="o">=</span> <span class="nx">iterable</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__currentBracket__</span><span class="p">).</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">toArray</span><span class="p">();</span>
    <span class="p">}</span> 
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__matches__</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span> <span class="c1">//// declare Elimination.</span></div></div></div></div></body></html>