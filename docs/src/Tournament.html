<!DOCTYPE html><html lang="en"><head><title>src\Tournament</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src\Tournament"><meta name="groc-project-path" content="src\Tournament.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src\Tournament.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="classtournament">Class <code>Tournament</code></h2>

<p>A tournament is a set of matches played between many players. The whole contest 
ranks the participants according to the result of the matches. This is an 
abstract base class for many different types of contests.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">Tournament</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Tournament</span> <span class="o">=</span> <span class="nx">declare</span><span class="p">({</span>
  <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">Tournament</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">players</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The tournament always has one <a href="Game.html"><code>game</code></a> state from which 
all matches start.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">game</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>All the <a href="Player.html"><code>players</code></a> involved in the tournament must be
provided to the constructor in an array.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">players</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">players</span><span class="p">)</span> <span class="o">?</span> <span class="nx">players</span> <span class="o">:</span> <span class="nx">iterables</span><span class="p">.</span><span class="nx">iterable</span><span class="p">(</span><span class="nx">players</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">statistics</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Statistics</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Events</span><span class="p">({</span> 
      <span class="nx">events</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span> <span class="s1">&#39;beforeMatch&#39;</span><span class="p">,</span> <span class="s1">&#39;afterMatch&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">]</span>
    <span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The next match to be played is determined by <code>__advance__</code>, which 
returns a match instance, or null if the tournament has finished. It is not 
implemented in this base class. </p></div></div><div class="code"><div class="wrapper">  <span class="nx">__advance__</span><span class="o">:</span> <span class="nx">unimplemented</span><span class="p">(</span><span class="s2">&quot;Tournament&quot;</span><span class="p">,</span> <span class="s2">&quot;__advance__&quot;</span><span class="p">),</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>Tournament.run()</code> plays all the tournament's matches. Since running a 
match is asynchronous, running a tournament is too. Hence the result is 
always a future, which will be resolved when all matches have been played.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">run</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onBegin</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">tournament</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">Future</span><span class="p">.</span><span class="nx">doWhile</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Future</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">tournament</span><span class="p">.</span><span class="nx">__advance__</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">tournament</span><span class="p">.</span><span class="nx">beforeMatch</span><span class="p">(</span><span class="nx">match</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">match</span><span class="p">.</span><span class="nx">run</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tournament</span><span class="p">.</span><span class="nx">account</span><span class="p">(</span><span class="nx">match</span><span class="p">);</span>
            <span class="nx">tournament</span><span class="p">.</span><span class="nx">afterMatch</span><span class="p">(</span><span class="nx">match</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onEnd</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Tournaments gather information from the played matches using their
<code>statistics</code> property (instance of <code>basis.Statistics</code>). The method 
<code>Tournament.account(match)</code> is called to accounts the results of each 
finished match for the players' score.</p>

<p>The match results are gathered in the <code>results</code> key. The keys <code>victories</code>,
<code>defeats</code> and <code>draws</code> count each result type. The length of each game is
recorded under <code>length</code>. The move count at each ply is aggregated under
<code>width</code>. All these numbers are open by game, role, player.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">account</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">account</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">game</span><span class="p">,</span>
      <span class="nx">results</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">result</span><span class="p">(),</span> 
      <span class="nx">isDraw</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">stats</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">statistics</span><span class="p">;</span>
    <span class="nx">raiseIf</span><span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">,</span> <span class="s2">&quot;Match doesn&#39;t have results. Has it finished?&quot;</span><span class="p">);</span>
    <span class="nx">iterable</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">players</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Player statistics.</span>
      <span class="kd">var</span> <span class="nx">role</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">player</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">playerResult</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;game:&#39;</span><span class="o">+</span> <span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;role:&#39;</span><span class="o">+</span> <span class="nx">role</span><span class="p">,</span> <span class="s1">&#39;player:&#39;</span><span class="o">+</span> <span class="nx">player</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
      <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">player</span><span class="p">.</span><span class="nx">name</span><span class="p">},</span> <span class="nx">playerResult</span><span class="p">);</span>
      <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="p">(</span><span class="nx">playerResult</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;victories&#39;</span> <span class="o">:</span> <span class="nx">playerResult</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;defeats&#39;</span> <span class="o">:</span> <span class="s1">&#39;draws&#39;</span><span class="p">),</span>
        <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">player</span><span class="p">.</span><span class="nx">name</span><span class="p">},</span> <span class="nx">playerResult</span><span class="p">);</span>
      <span class="c1">//FIXME This may not be accurate if the game has random variables.</span>
      <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">player</span><span class="p">.</span><span class="nx">name</span><span class="p">},</span> <span class="nx">match</span><span class="p">.</span><span class="nx">ply</span><span class="p">());</span> 
      <span class="nx">match</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">entry</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">moves</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">moves</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">moves</span><span class="p">();</span>  
          <span class="k">if</span> <span class="p">(</span><span class="nx">moves</span> <span class="o">&amp;&amp;</span> <span class="nx">moves</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">role</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">moves</span><span class="p">[</span><span class="nx">role</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stats</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="o">:</span><span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="nx">role</span><span class="p">,</span> <span class="nx">player</span><span class="o">:</span><span class="nx">player</span><span class="p">.</span><span class="nx">name</span><span class="p">},</span> 
              <span class="nx">moves</span><span class="p">[</span><span class="nx">role</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="events">Events</h3>

<p>Tournaments provide events to enable further analysis and control over it. 
<code>Tournament.events</code> is the event handler. The emitted events are:</p></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>The <code>begin</code> event fired by <code>Tournament.onBegin()</code> when the whole 
contest begins. The callbacks should have the signature 
<code>function (tournament)</code>.</li>
</ul></div></div><div class="code"><div class="wrapper">  
  <span class="nx">onBegin</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">onBegin</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Tournament begins for game &#39;</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>The <code>beforeMatch</code> event triggered by <code>Tournament.beforeMatch(match)</code> 
just before starting a match. The callbacks should have the signature 
<code>function (match, tournament)</code>.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nx">beforeMatch</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">beforeMatch</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;beforeMatch&#39;</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Beginning match with &#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">players</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>The <code>afterMatch</code> event triggered by <code>Tournament.afterMatch(match)</code> 
just after a match ends. The callbacks should have the signature 
<code>function (match, tournament)</code>.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nx">afterMatch</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">afterMatch</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;afterMatch&#39;</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Finishing match with &#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">players</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>The <code>end</code> event triggered by <code>Tournament.onEnd()</code> when the whole 
contest is completed. The callbacks should have the signature 
<code>function (statistics, tournament)</code>.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nx">onEnd</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">onEnd</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">statistics</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Tournament ends for game &#39;</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;:\n&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">statistics</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span> <span class="c1">// declare Tournament</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The namespace <code>ludorum.tournaments</code> holds several contest types implemented 
as Tournament subtypes.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">tournaments</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">tournaments</span> <span class="o">=</span> <span class="p">{};</span></div></div></div></div></body></html>